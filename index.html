<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="appTitle">Runaki Bill Assistant</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for plotting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <style>
        /* Define a custom color palette using CSS variables for consistency */
        :root {
            --primary-blue: #3b82f6; /* A clean, vibrant blue */
            --secondary-green: #22c55e; /* A fresh green */
            --accent-orange: #f97316; /* A warm orange */
            --accent-purple: #8b5cf6; /* A soft purple */
            --neutral-gray-dark: #374151; /* Dark gray for text */
            --neutral-gray-medium: #6b7280; /* Medium gray for labels */
            --neutral-gray-light: #e5e7eb; /* Light gray for borders/backgrounds */
            --background-light: #f9fafb; /* Very light background */
            --card-background: #ffffff; /* White for cards */
            --highlight-yellow: #facc15; /* Yellow for highlights */
            --error-red: #ef4444; /* Standard error red */

            /* New light gray button colors */
            --button-light-gray: #e0e0e0;
            --button-hover-gray: #d1d1d1;
            --button-active-gray: #c0c0c0;
            --button-dark-text: #333f48;

            /* Night mode specific colors */
            --background-dark: #1a202c; /* Deep dark background */
            --card-dark: #2d3748; /* Slightly lighter dark for cards */
            --text-light: #e2e8f0; /* Light gray for main text */
            --text-medium-light: #a0aec0; /* Medium light gray for labels */
            --input-dark-bg: #4a5568; /* Darker input background */
            --input-dark-border: #6b7280; /* Darker input border */
            --result-item-dark-bg: #3c4a5c; /* Darker result item background */
            --result-item-dark-border: #5a6a7c; /* Darker result item border */
            --primary-blue-darker: #2563eb; /* A slightly darker blue for accents on dark background */
            --highlight-yellow-dark: #fbbf24; /* Brighter yellow for dark background */
            
            /* Dynamic colors for result displays */
            --manual-result-color: #fef08a; /* Light yellow */
            --manual-highlight-color: #fbbf24; /* Brighter yellow */
            --meter-result-color: #bbf7d0; /* Light green */
            --meter-highlight-color: #86efac; /* Brighter green */
            --device-result-color: #a7f3d0; /* Light teal/cyan */
            --device-highlight-color: #5eead4; /* Brighter teal/cyan */
            --optimization-result-color: #bfdbfe; /* Light blue */
            --optimization-highlight-color: #93c5fd; /* Brighter blue */
        }

        /* Custom styles for better aesthetics and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-dark); /* Night mode background */
            margin: 0;
            padding: 2rem; /* Increased padding */
            color: var(--text-light); /* Night mode text color */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: pan-x pan-y;
        }

        /* RTL specific styles */
        body.rtl {
            direction: rtl;
            text-align: right;
        }

        body.rtl .input-group label {
            /* Adjust label alignment for RTL if needed, depends on flex layout */
            margin-right: 0;
            margin-left: 1.25rem; /* Equivalent of gap from LTR */
        }

        body.rtl .device-table th, 
        body.rtl .device-table td {
            text-align: center; /* Keep center for table cells */
        }

        body.rtl .modal-close-button {
            right: unset;
            left: 1rem;
        }
        
        /* Language selector styling */
        .language-selector {
            margin-top: 1rem; /* Space from the content above */
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        h1 {
            color: white; /* Changed to white as requested */
            font-weight: 800;
            margin-bottom: 2.5rem; /* Increased margin */
            text-align: center;
            font-size: 2.75rem; /* Slightly larger font size */
            letter-spacing: -0.025em; /* Tighten letter spacing slightly */
        }

        h2 {
            color: var(--text-light); /* Night mode heading color */
            font-weight: 700;
            margin-bottom: 1.25rem; /* Increased margin */
            text-align: left;
            font-size: 1.6rem; /* Slightly larger for section titles */
        }

        .main-container {
            display: flex;
            flex-direction: column; /* Always column layout */
            gap: 2.5rem; /* Increased gap */
            width: 100%;
            max-width: 45rem; /* Adjusted max-width for single column */
            background-color: var(--card-dark); /* Night mode card background */
            padding: 2.5rem; /* Increased padding */
            border-radius: 1.25rem; /* More rounded corners */
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.25); /* Stronger, diffused shadow for dark mode */
        }

        .section-card {
            background-color: var(--card-dark); /* Night mode card background */
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 1rem; /* More rounded corners */
            padding: 2rem; /* Increased padding */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); /* Softer shadow */
        }

        .input-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1.25rem; /* Increased gap */
            margin-bottom: 1.75rem; /* Increased margin */
        }

        label {
            font-weight: 600;
            color: var(--text-medium-light); /* Night mode label color */
            flex-shrink: 0; /* Prevent label from shrinking */
        }

        input[type="text"],
        input[type="number"],
        select {
            padding: 0.75rem 1rem; /* More padding */
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 0.6rem; /* More rounded corners */
            font-size: 1rem; /* Slightly larger font */
            text-align: center;
            background-color: var(--input-dark-bg); /* Night mode input background */
            color: var(--text-light); /* Night mode input text color */
            flex-grow: 1;
            min-width: 8rem; /* Slightly larger min-width */
            transition: all 0.2s ease-in-out;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Subtle inner shadow */
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--primary-blue-darker); /* Night mode focus border */
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4); /* Soft blue glow on focus for night mode */
            outline: none;
        }

        /* General button styling */
        button {
            padding: 0.75rem 1.5rem; /* More padding */
            border-radius: 0.6rem; /* More rounded corners */
            border: none; /* Removed border */
            font-size: 1rem; /* Slightly larger font */
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Stronger button shadow */
            white-space: nowrap;
            color: var(--button-dark-text); /* Dark text for light grey button */
            margin: 0.5rem; /* Increased margin for spacing between buttons */
            background-color: var(--button-light-gray); /* Light grey background */
        }

        button:hover {
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 8px 16px rgba(0,0,0,0.2); /* Stronger hover shadow */
            opacity: 0.95;
            background-color: var(--button-hover-gray); /* Slightly darker grey on hover */
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: var(--button-active-gray); /* Keep background light grey when active */
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(8rem, 1fr)); /* Adjusted min-width for results */
            gap: 1rem; /* Increased gap */
            font-size: 1rem;
            margin-top: 1rem; /* Added margin-top */
            max-width: 40rem; /* Max width for the grid itself */
            margin-left: auto; /* Center the grid */
            margin-right: auto; /* Center the grid */
        }

        .result-item {
            background-color: var(--result-item-dark-bg); /* Night mode result item background */
            border: 1px solid var(--result-item-dark-border); /* Night mode result item border */
            border-radius: 0.75rem;
            padding: 1.2rem; /* More padding */
            text-align: center;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.07); /* Inner shadow for depth */
        }

        .result-label {
            color: var(--text-medium-light); /* Night mode result label color */
            margin-bottom: 0.4rem;
            font-weight: 500;
        }

        .result-value {
            font-weight: 800;
            /* Use dynamic CSS variables for color */
            color: var(--current-result-color); 
            font-size: 1.25rem; /* Larger font for values */
            transition: color 0.2s ease-in-out; /* Smooth transition for color flash */
        }

        /* Flashing animation for result values */
        @keyframes flashEffect {
            0% { color: var(--current-result-color); } /* Start with dynamic color */
            16.6% { color: var(--current-highlight-color); } /* Flash brighter dynamic color */
            33.3% { color: var(--current-result-color); } /* Back to dynamic color */
            50% { color: var(--current-highlight-color); } /* Flash brighter dynamic color again */
            66.6% { color: var(--current-result-color); } /* Back to dynamic color */
            83.3% { color: var(--current-highlight-color); } /* Flash brighter dynamic color one last time */
            100% { color: var(--current-result-color); } /* End with dynamic color */
        }

        .flash-animation {
            animation: flashEffect 1.8s ease-out; /* 3 flashes over 1.8 seconds */
        }

        /* Chart container styling */
        .chart-container {
            width: 100%;
            height: 300px; /* Fixed height for chart */
            margin-top: 2rem; 
            background-color: var(--card-dark); 
            border-radius: 1rem;
            padding: 1.5rem; 
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
        }

        /* Slider styling (Not used in this version, but kept for reference) */
        .range-slider {
            width: 100%;
            height: 0.75rem; 
            background-color: #d1fae5; 
            border-radius: 0.4rem;
            appearance: none;
            cursor: grab;
            margin-top: 2rem; 
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.1);
        }

        .range-slider::-webkit-slider-thumb {
            appearance: none;
            width: 1.8rem; 
            height: 1.8rem; 
            background: var(--secondary-green);
            border-radius: 50%;
            border: 4px solid white; 
            box-shadow: 0 4-8px rgba(0,0,0,0.3); 
            transition: background 0.15s ease-in-out;
            cursor: grab;
        }
        .range-slider::-webkit-slider-thumb:active {
            cursor: grabbing;
        }

        .range-slider::-moz-range-thumb {
            width: 1.8rem;
            height: 1.8rem;
            background: var(--secondary-green);
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: background 0.15s ease-in-out;
            cursor: grab;
        }
        .range-slider::-moz-range-thumb:active {
            cursor: grabbing;
        }

        .range-slider::-webkit-slider-runnable-track {
            background: linear-gradient(to right, #a7f3d0 0%, #a7f3d0 var(--slider-fill, 0%), #fff var(--slider-fill, 0%), #fff 100%);
            border-radius: 0.4rem;
        }

        .range-slider::-moz-range-track {
            background: linear-gradient(to right, #a7f3d0 0%, #a7f3d0 var(--slider-fill, 0%), #fff var(--slider-fill, 0%), #fff 100%);
            border-radius: 0.4rem;
        }

        /* Device Table Styling */
        .device-table-container {
            overflow-x: auto;
            max-height: 500px; /* Slightly taller table */
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 1rem;
            margin-bottom: 2rem; /* Increased margin */
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2); /* Stronger shadow for dark mode */
        }

        .device-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Ensure table doesn't get too narrow on small screens */
        }

        .device-table th, .device-table td {
            padding: 1rem 0.8rem; /* More padding */
            text-align: center;
            border-bottom: 1px solid var(--input-dark-border); /* Night mode border */
            font-size: 0.95rem; /* Slightly larger font */
        }

        .device-table th {
            background-color: var(--input-dark-bg); /* Night mode header background */
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            color: var(--text-light); /* Night mode header text */
        }

        .device-table tbody tr:hover {
            background-color: #3a475c; /* Darker hover effect for table rows */
        }

        .device-table tbody tr.selected-row {
            background-color: #3b82f640; /* Light blue highlight on dark background */
            box-shadow: inset 0 0 0 3px var(--primary-blue-darker); /* Blue border on selected row */
        }

        .device-table input[type="text"],
        .device-table input[type="number"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 0.4rem;
            text-align: center;
            font-size: 0.9rem;
            background-color: var(--input-dark-bg); /* Night mode input background */
            color: var(--text-light); /* Night mode input text */
        }

        .device-table input[type="checkbox"] {
            width: 1.2rem; /* Slightly larger checkbox */
            height: 1.2rem;
            cursor: pointer;
            border-radius: 0.3rem;
            accent-color: var(--primary-blue-darker); /* Night mode checkbox accent */
        }

        .device-table .output-cell {
            background-color: #2a3a4c; /* Darker blue for output values */
            font-weight: 600;
            color: var(--primary-blue-darker); /* A subtle blue for output values */
        }

        /* Responsive adjustments for table inputs */
        @media (max-width: 768px) {
            .device-table input[type="text"],
            .device-table input[type="number"] {
                width: 100%;
            }
        }

        /* Custom Modal for Tariff Details */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--card-dark); /* Night mode modal background */
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            color: var(--text-light); /* Night mode modal text */
            position: relative;
        }

        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light); /* Night mode close button color */
            cursor: pointer;
        }
        .modal-close-button:hover {
            color: var(--primary-blue-darker); /* Night mode close button hover */
        }

        .modal-content h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-blue-darker); /* Night mode modal heading color */
            margin-bottom: 1rem;
        }

        .modal-content pre {
            background-color: #1a202c; /* Deeper dark for code/preformatted text */
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: 'Cascadia Code', 'Fira Code', monospace;
            font-size: 0.9rem;
            color: #a0aec0; /* Lighter text for code */
        }

        /* Footer */
        footer {
            color: var(--text-medium-light); /* Night mode footer text */
            margin-top: 8rem; /* Increased margin-top for footer */
            text-align: center;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        /* Message Box Styling */
        #appMessage {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1100;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            color: white; /* Default text color for messages */
        }
        #appMessage.show {
            opacity: 1;
            transform: translateY(0);
        }
        #appMessage.info {
            background-color: #3b82f6;
        } /* Blue for info */
        #appMessage.success {
            background-color: #22c55e;
        } /* Green for success */
        #appMessage.error {
            background-color: #ef4444;
        } /* Red for error */

        /* Report Modal Specific Styles */
        .report-section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-blue-darker);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-blue-darker);
            padding-bottom: 0.5rem;
        }
        .report-item-label {
            font-weight: 600;
            color: var(--text-medium-light);
            margin-right: 0.5rem;
        }
        .report-item-value {
            font-weight: 700;
            color: var(--text-light);
        }
        .report-breakdown-item {
            margin-left: 1rem;
            font-size: 0.95rem;
            color: var(--text-medium-light);
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background-color: var(--input-dark-bg);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .report-table th, .report-table td {
            padding: 0.75rem;
            border: 1px solid var(--input-dark-border);
            text-align: left;
            color: var(--text-light);
        }
        .report-table th {
            background-color: var(--primary-blue-darker);
            color: white;
            font-weight: 700;
        }
        .report-table tbody tr:nth-child(even) {
            background-color: #3a475c; /* Slightly different background for even rows */
        }
    </style>
</head>
<body>
    <h1 class="text-3xl lg:text-4xl" data-lang-key="mainTitle">Runaki Bill Assistant</h1>
    <div class="main-container">
        <!-- Main content now in a single column -->
        <div class="flex flex-col w-full space-y-8">
            <!-- 1. Manual Calculation -->
            <div class="section-card" id="manualCalculationSection">
                <h2 class="text-xl" data-lang-key="manualCalculationTitle">1. Manual Calculation</h2>
                <div class="input-group">
                    <label for="categoryDropdown" data-lang-key="categoryLabel">Category:</label>
                    <select id="categoryDropdown" class="p-2 border rounded-md">
                        <option value="Household" data-lang-key="householdOption">Household</option>
                        <option value="Commercial" data-lang-key="commercialOption">Commercial</option>
                        <option value="Agriculture" data-lang-key="agricultureOption">Agriculture</option>
                        <option value="Industrial" data-lang-key="industrialOption">Industrial</option>
                        <option value="Large Industry" data-lang-key="largeIndustryOption">Large Industry</option>
                        <option value="State" data-lang-key="stateOption">State</option>
                    </select>
                    <label for="manualInputTypeDropdown" data-lang-key="inputLabel">Input:</label>
                    <select id="manualInputTypeDropdown" class="p-2 border rounded-md">
                        <option value="kWh" data-lang-key="kwhOption">kWh</option>
                        <option value="Avg Amperes" data-lang-key="avgAmperesOption">Avg Amperes</option>
                        <option value="Given Bill" data-lang-key="givenBillOption">Given Bill (IQD)</option>
                    </select>
                    <input type="number" id="manualInput" value="1891" class="w-28">
                </div>
                <button id="calculateManualButton" class="btn w-full" data-lang-key="calculateBillButton">Calculate Bill</button>
                <div class="result-grid" id="manualResultGrid">
                    <div class="result-item">
                        <div class="result-label" data-lang-key="billLabel">Bill</div>
                        <div class="result-value" id="manualBill">0 IQD</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="consumptionLabel">Consumption</div>
                        <div class="result-value" id="manualKwh">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="tariffDetailsLabel">Details</div>
                        <div class="result-value text-blue-400 cursor-pointer" id="manualTariffDetailsButton">View</div>
                    </div>
                </div>
            </div>

            <!-- 2. Meter Calculation -->
            <div class="section-card" id="meterCalculationSection">
                <h2 class="text-xl" data-lang-key="meterCalculationTitle">2. Meter Calculation</h2>
                <div class="input-group">
                    <label for="meterCategoryDropdown" data-lang-key="categoryLabel">Category:</label>
                    <select id="meterCategoryDropdown" class="p-2 border rounded-md">
                        <option value="Household" data-lang-key="householdOption">Household</option>
                        <option value="Commercial" data-lang-key="commercialOption">Commercial</option>
                        <option value="Agriculture" data-lang-key="agricultureOption">Agriculture</option>
                        <option value="Industrial" data-lang-key="industrialOption">Industrial</option>
                        <option value="Large Industry" data-lang-key="largeIndustryOption">Large Industry</option>
                        <option value="State" data-lang-key="stateOption">State</option>
                    </select>
                    <label for="meterReadingInput" data-lang-key="meterReadingLabel">Meter Reading:</label>
                    <input type="number" id="meterReadingInput" value="0" class="w-28">
                    <label for="previousReadingInput" data-lang-key="previousReadingLabel">Previous:</label>
                    <input type="number" id="previousReadingInput" value="0" class="w-28">
                </div>
                <button id="calculateMeterButton" class="btn w-full" data-lang-key="calculateBillButton">Calculate Bill</button>
                <div class="result-grid" id="meterResultGrid">
                    <div class="result-item">
                        <div class="result-label" data-lang-key="billLabel">Bill</div>
                        <div class="result-value" id="meterBill">0 IQD</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="consumptionLabel">Consumption</div>
                        <div class="result-value" id="meterKwh">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="tariffDetailsLabel">Details</div>
                        <div class="result-value text-blue-400 cursor-pointer" id="meterTariffDetailsButton">View</div>
                    </div>
                </div>
            </div>

            <!-- 3. Device List -->
            <div class="section-card" id="deviceCalculationSection">
                <h2 class="text-xl" data-lang-key="deviceListTitle">3. Device List</h2>
                <div class="input-group flex-col md:flex-row">
                    <label for="deviceCategoryDropdown" data-lang-key="categoryLabel">Category:</label>
                    <select id="deviceCategoryDropdown" class="p-2 border rounded-md">
                        <option value="Household" data-lang-key="householdOption">Household</option>
                        <option value="Commercial" data-lang-key="commercialOption">Commercial</option>
                        <option value="Agriculture" data-lang-key="agricultureOption">Agriculture</option>
                        <option value="Industrial" data-lang-key="industrialOption">Industrial</option>
                        <option value="Large Industry" data-lang-key="largeIndustryOption">Large Industry</option>
                        <option value="State" data-lang-key="stateOption">State</option>
                    </select>
                </div>
                <button id="addDeviceButton" class="btn w-full mb-4" data-lang-key="addDeviceButton">Add Device</button>
                <div class="device-table-container">
                    <table class="device-table" id="deviceTable">
                        <thead>
                            <tr>
                                <th data-lang-key="deviceNameHeader">Device Name</th>
                                <th data-lang-key="devicePowerHeader">Power (Watt)</th>
                                <th data-lang-key="deviceDailyHoursHeader">Hours/Day</th>
                                <th data-lang-key="deviceMonthlyConsumptionHeader">Monthly kWh</th>
                                <th data-lang-key="deviceMonthlyCostHeader">Monthly Cost (IQD)</th>
                                <th data-lang-key="deviceActiveHeader">Active</th>
                                <th data-lang-key="deviceActionsHeader">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Device rows will be added here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="result-grid mt-4" id="deviceResultGrid">
                    <div class="result-item">
                        <div class="result-label" data-lang-key="monthlyConsumptionLabel">Monthly Consumption</div>
                        <div class="result-value" id="totalDeviceConsumption">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="monthlyBillLabel">Monthly Bill</div>
                        <div class="result-value" id="totalDeviceBill">0 IQD</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="tariffDetailsLabel">Details</div>
                        <div class="result-value text-blue-400 cursor-pointer" id="deviceTariffDetailsButton">View</div>
                    </div>
                </div>
            </div>

            <!-- Report Button -->
            <button id="generateReportButton" class="btn bg-gray-600 text-white hover:bg-gray-700 w-full" data-lang-key="generateReportButton">Generate Report</button>
        </div>
    </div>

    <!-- Modals -->
    <!-- Tariff Details Modal -->
    <div id="tariffDetailsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeTariffModal" class="modal-close-button">&times;</button>
            <h3 data-lang-key="tariffDetailsTitle">Electricity Tariff Details</h3>
            <p data-lang-key="tariffDetailsDescription">The following shows the tiered pricing structure for the selected category.</p>
            <div id="tariffChartContainer" class="chart-container" style="display: none;">
                <canvas id="tariffChart"></canvas>
            </div>
            <pre id="tariffDetailsContent" class="mt-4 p-4 bg-gray-800 rounded-md text-sm overflow-x-auto"></pre>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeReportModal" class="modal-close-button">&times;</button>
            <h3 data-lang-key="reportTitle">Electricity Usage Report</h3>
            <div id="reportContent" class="mt-4">
                <!-- Report content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div id="appMessage" class="hidden"></div>
    
    <!-- Footer -->
    <footer>
        <div class="language-selector">
            <button id="lang-en" class="text-xs p-1 rounded-md bg-gray-700 text-gray-200">English</button>
            <button id="lang-ar" class="text-xs p-1 rounded-md bg-gray-700 text-gray-200">العربية</button>
            <button id="lang-ku" class="text-xs p-1 rounded-md bg-gray-700 text-gray-200">کوردی</button>
        </div>
        <p class="text-sm">Made with ❤️ by Runaki</p>
    </footer>

    <!-- JavaScript for functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- TARIFF RATES AND CONSTANTS (UPDATED FOR IRAQ) ---
            const TARIFF_RATES = {
                "Household": [
                    { kwh: 1000, rate: 10 },
                    { kwh: 2000, rate: 20 },
                    { kwh: 4000, rate: 40 },
                    { kwh: Infinity, rate: 80 }
                ],
                "Commercial": [
                    { kwh: 1000, rate: 20 },
                    { kwh: 2000, rate: 30 },
                    { kwh: 4000, rate: 50 },
                    { kwh: Infinity, rate: 100 }
                ],
                "Agriculture": [
                    { kwh: Infinity, rate: 5 }
                ],
                "Industrial": [
                    { kwh: Infinity, rate: 10 }
                ],
                "Large Industry": [
                    { kwh: Infinity, rate: 20 }
                ],
                "State": [
                    { kwh: Infinity, rate: 40 }
                ]
            };

            const KW_PER_AMP = 0.22; // Assuming 220V, but kept this as a constant
            const DAYS_IN_MONTH = 30; // Average days in a month
            const METER_READING_COST_PER_MONTH = 1000; // Fixed cost for meter reading
            let currentCategory = 'Household';

            // --- LANGUAGE SUPPORT (UPDATED FOR IRAQ) ---
            const LANGUAGES = {
                'en': {
                    'appTitle': 'Runaki Bill Assistant',
                    'mainTitle': 'Runaki Bill Assistant',
                    'manualCalculationTitle': '1. Manual Calculation',
                    'categoryLabel': 'Category:',
                    'inputLabel': 'Input:',
                    'kwhOption': 'kWh',
                    'avgAmperesOption': 'Avg Amperes',
                    'givenBillOption': 'Given Bill (IQD)',
                    'calculateBillButton': 'Calculate Bill',
                    'billLabel': 'Bill',
                    'consumptionLabel': 'Consumption',
                    'tariffDetailsLabel': 'Details',
                    'meterCalculationTitle': '2. Meter Calculation',
                    'meterReadingLabel': 'Meter Reading:',
                    'previousReadingLabel': 'Previous:',
                    'deviceListTitle': '3. Device List',
                    'addDeviceButton': 'Add Device',
                    'deviceNameHeader': 'Device Name',
                    'devicePowerHeader': 'Power (Watt)',
                    'deviceDailyHoursHeader': 'Hours/Day',
                    'deviceMonthlyConsumptionHeader': 'Monthly kWh',
                    'deviceMonthlyCostHeader': 'Monthly Cost (IQD)',
                    'deviceActiveHeader': 'Active',
                    'deviceActionsHeader': 'Actions',
                    'monthlyConsumptionLabel': 'Monthly Consumption',
                    'monthlyBillLabel': 'Monthly Bill',
                    'generateReportButton': 'Generate Report',
                    'tariffDetailsTitle': 'Electricity Tariff Details',
                    'tariffDetailsDescription': 'The following shows the tiered pricing structure for the selected category.',
                    'householdOption': 'Household',
                    'commercialOption': 'Commercial',
                    'agricultureOption': 'Agriculture',
                    'industrialOption': 'Industrial',
                    'largeIndustryOption': 'Large Industry',
                    'stateOption': 'State',
                    'reportTitle': 'Electricity Usage Report',
                    'reportHeaderManual': '1. Manual Calculation Result',
                    'reportHeaderMeter': '2. Meter Calculation Result',
                    'reportHeaderDevice': '3. Device List Summary',
                    'reportTotalConsumption': 'Total Monthly Consumption:',
                    'reportTotalBill': 'Total Monthly Bill:',
                    'reportBreakdown': 'Consumption Breakdown:',
                    'reportItem': '- {{kwh}} kWh @ {{rate}} IQD/kWh = {{cost}} IQD',
                    'reportItemFixed': '- {{kwh}} kWh @ {{rate}} IQD/kWh = {{cost}} IQD (Fixed Rate)',
                    'reportFixedMeterCost': 'Fixed Meter Reading Cost:',
                    'reportNoData': 'No data to show.',
                    'reportDeviceTableTitle': 'Active Devices List',
                    'reportTableDevice': 'Device',
                    'reportTableConsumption': 'Monthly kWh',
                    'reportTableCost': 'Monthly Cost (IQD)',
                },
                'ar': {
                    'appTitle': 'مساعد حساب الفاتورة من روناكي',
                    'mainTitle': 'مساعد حساب الفاتورة من روناكي',
                    'manualCalculationTitle': '1. الحساب اليدوي',
                    'categoryLabel': 'الفئة:',
                    'inputLabel': 'الإدخال:',
                    'kwhOption': 'كيلوواط ساعة',
                    'avgAmperesOption': 'متوسط الأمبير',
                    'givenBillOption': 'الفاتورة المعطاة (د.ع)',
                    'calculateBillButton': 'حساب الفاتورة',
                    'billLabel': 'الفاتورة',
                    'consumptionLabel': 'الاستهلاك',
                    'tariffDetailsLabel': 'التفاصيل',
                    'meterCalculationTitle': '2. حساب العداد',
                    'meterReadingLabel': 'قراءة العداد:',
                    'previousReadingLabel': 'السابقة:',
                    'deviceListTitle': '3. قائمة الأجهزة',
                    'addDeviceButton': 'إضافة جهاز',
                    'deviceNameHeader': 'اسم الجهاز',
                    'devicePowerHeader': 'القدرة (واط)',
                    'deviceDailyHoursHeader': 'ساعات/يوم',
                    'deviceMonthlyConsumptionHeader': 'كيلوواط ساعة شهرياً',
                    'deviceMonthlyCostHeader': 'التكلفة الشهرية (د.ع)',
                    'deviceActiveHeader': 'فعال',
                    'deviceActionsHeader': 'الإجراءات',
                    'monthlyConsumptionLabel': 'الاستهلاك الشهري',
                    'monthlyBillLabel': 'الفاتورة الشهرية',
                    'generateReportButton': 'إنشاء تقرير',
                    'tariffDetailsTitle': 'تفاصيل تسعيرة الكهرباء',
                    'tariffDetailsDescription': 'التالي يوضح هيكل التسعيرة المتعددة الفئات للفئة المختارة.',
                    'householdOption': 'منزلية',
                    'commercialOption': 'تجارية',
                    'agricultureOption': 'زراعية',
                    'industrialOption': 'صناعية',
                    'largeIndustryOption': 'صناعة كبرى',
                    'stateOption': 'حكومية',
                    'reportTitle': 'تقرير استخدام الكهرباء',
                    'reportHeaderManual': '1. نتيجة الحساب اليدوي',
                    'reportHeaderMeter': '2. نتيجة حساب العداد',
                    'reportHeaderDevice': '3. ملخص قائمة الأجهزة',
                    'reportTotalConsumption': 'إجمالي الاستهلاك الشهري:',
                    'reportTotalBill': 'إجمالي الفاتورة الشهرية:',
                    'reportBreakdown': 'تفصيل الاستهلاك:',
                    'reportItem': '- {{kwh}} كيلوواط ساعة بسعر {{rate}} د.ع/كيلوواط ساعة = {{cost}} د.ع',
                    'reportItemFixed': '- {{kwh}} كيلوواط ساعة بسعر {{rate}} د.ع/كيلوواط ساعة = {{cost}} د.ع (سعر ثابت)',
                    'reportFixedMeterCost': 'تكلفة قراءة العداد الثابتة:',
                    'reportNoData': 'لا توجد بيانات للعرض.',
                    'reportDeviceTableTitle': 'قائمة الأجهزة النشطة',
                    'reportTableDevice': 'الجهاز',
                    'reportTableConsumption': 'كيلوواط ساعة شهرياً',
                    'reportTableCost': 'التكلفة الشهرية (د.ع)',
                },
                'ku': {
                    'appTitle': 'یارمەتیدەری بیل لەلایەن روناكی',
                    'mainTitle': 'یارمەتیدەری بیل لەلایەن روناكی',
                    'manualCalculationTitle': '1. ژماردنی دەستی',
                    'categoryLabel': 'جۆر:',
                    'inputLabel': 'داتای داخڵکردن:',
                    'kwhOption': 'کیلۆوات کاتژمێر',
                    'avgAmperesOption': 'تێکڕای ئەمپێر',
                    'givenBillOption': 'بیلێکی دیاریکراو (د.ع)',
                    'calculateBillButton': 'ژماردنی بیل',
                    'billLabel': 'بیل',
                    'consumptionLabel': 'بەکارهێنان',
                    'tariffDetailsLabel': 'وردەکاری',
                    'meterCalculationTitle': '2. ژماردنی میتەر',
                    'meterReadingLabel': 'خوێندنەوەی میتەر:',
                    'previousReadingLabel': 'پێشوو:',
                    'deviceListTitle': '3. لیستی ئامێرەکان',
                    'addDeviceButton': 'زیادکردنی ئامێر',
                    'deviceNameHeader': 'ناوی ئامێر',
                    'devicePowerHeader': 'هێز (وات)',
                    'deviceDailyHoursHeader': 'کاتژمێر/ڕۆژ',
                    'deviceMonthlyConsumptionHeader': 'کیلۆوات کاتژمێر مانگانە',
                    'deviceMonthlyCostHeader': 'تێچووی مانگانە (د.ع)',
                    'deviceActiveHeader': 'چالاک',
                    'deviceActionsHeader': 'کردارەکان',
                    'monthlyConsumptionLabel': 'بەکارهێنانی مانگانە',
                    'monthlyBillLabel': 'بیلی مانگانە',
                    'generateReportButton': 'دروستکردنی راپۆرت',
                    'tariffDetailsTitle': 'وردەکاری نرخی کارەبا',
                    'tariffDetailsDescription': 'لێرەدا نرخی پلەبەندی بۆ جۆری دیاریکراو نیشاندراوە.',
                    'householdOption': 'ماڵان',
                    'commercialOption': 'بازرگانی',
                    'agricultureOption': 'کشتوکاڵی',
                    'industrialOption': 'پیشەسازی',
                    'largeIndustryOption': 'پیشەسازی گەورە',
                    'stateOption': 'حکومی',
                    'reportTitle': 'راپۆرتی بەکارهێنانی کارەبا',
                    'reportHeaderManual': '1. ئەنجامی ژماردنی دەستی',
                    'reportHeaderMeter': '2. ئەنجامی ژماردنی میتەر',
                    'reportHeaderDevice': '3. پوختەی لیستی ئامێرەکان',
                    'reportTotalConsumption': 'کۆی بەکارهێنانی مانگانە:',
                    'reportTotalBill': 'کۆی بیلی مانگانە:',
                    'reportBreakdown': 'شیکردنەوەی بەکارهێنان:',
                    'reportItem': '- {{kwh}} کیلۆوات کاتژمێر لە نرخی {{rate}} د.ع/کیلۆوات کاتژمێر = {{cost}} د.ع',
                    'reportItemFixed': '- {{kwh}} کیلۆوات کاتژمێر لە نرخی {{rate}} د.ع/کیلۆوات کاتژمێر = {{cost}} د.ع (نرخی جێگیر)',
                    'reportFixedMeterCost': 'تێچووی جێگیری خوێندنەوەی میتەر:',
                    'reportNoData': 'هیچ داتایەک نییە بۆ نیشاندان.',
                    'reportDeviceTableTitle': 'لیستی ئامێرە چالاکەکان',
                    'reportTableDevice': 'ئامێر',
                    'reportTableConsumption': 'کیلۆوات کاتژمێر مانگانە',
                    'reportTableCost': 'تێچووی مانگانە (د.ع)',
                }
            };
            
            let currentLanguage = 'en';

            // --- UI ELEMENT SELECTION ---
            const manualCalculationSection = document.getElementById('manualCalculationSection');
            const manualInput = document.getElementById('manualInput');
            const manualInputTypeDropdown = document.getElementById('manualInputTypeDropdown');
            const categoryDropdown = document.getElementById('categoryDropdown');
            const calculateManualButton = document.getElementById('calculateManualButton');
            const manualBillElement = document.getElementById('manualBill');
            const manualKwhElement = document.getElementById('manualKwh');
            const manualTariffDetailsButton = document.getElementById('manualTariffDetailsButton');

            const meterCalculationSection = document.getElementById('meterCalculationSection');
            const meterCategoryDropdown = document.getElementById('meterCategoryDropdown');
            const meterReadingInput = document.getElementById('meterReadingInput');
            const previousReadingInput = document.getElementById('previousReadingInput');
            const calculateMeterButton = document.getElementById('calculateMeterButton');
            const meterBillElement = document.getElementById('meterBill');
            const meterKwhElement = document.getElementById('meterKwh');
            const meterTariffDetailsButton = document.getElementById('meterTariffDetailsButton');

            const deviceCalculationSection = document.getElementById('deviceCalculationSection');
            const deviceCategoryDropdown = document.getElementById('deviceCategoryDropdown');
            const addDeviceButton = document.getElementById('addDeviceButton');
            const deviceTableBody = document.querySelector('#deviceTable tbody');
            const totalDeviceConsumptionElement = document.getElementById('totalDeviceConsumption');
            const totalDeviceBillElement = document.getElementById('totalDeviceBill');
            const deviceTariffDetailsButton = document.getElementById('deviceTariffDetailsButton');
            let deviceData = [];

            const tariffDetailsModal = document.getElementById('tariffDetailsModal');
            const closeTariffModal = document.getElementById('closeTariffModal');
            const tariffDetailsContent = document.getElementById('tariffDetailsContent');
            const tariffChartContainer = document.getElementById('tariffChartContainer');
            const tariffChartCanvas = document.getElementById('tariffChart');
            let tariffChart = null;

            const reportModal = document.getElementById('reportModal');
            const closeReportModal = document.getElementById('closeReportModal');
            const reportContent = document.getElementById('reportContent');
            const generateReportButton = document.getElementById('generateReportButton');

            const appMessage = document.getElementById('appMessage');
            
            const langEnButton = document.getElementById('lang-en');
            const langArButton = document.getElementById('lang-ar');
            const langKuButton = document.getElementById('lang-ku');

            // --- HELPER FUNCTIONS ---

            /**
             * Formats a number with commas for thousands and rounds to 2 decimal places.
             * @param {number} num The number to format.
             * @returns {string} The formatted string.
             */
            const formatNumber = (num) => {
                if (typeof num !== 'number' || isNaN(num)) {
                    return '0.00';
                }
                const parts = num.toFixed(2).toString().split('.');
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                return parts.join('.');
            };

            /**
             * Calculates the bill for a given consumption (kWh) and category.
             * @param {number} kwh The total kWh consumption.
             * @param {string} category The electricity category.
             * @returns {object} An object containing the total bill and a breakdown of the calculation.
             */
            const calculateBill = (kwh, category) => {
                let totalCost = 0;
                const breakdown = [];
                const rates = TARIFF_RATES[category];

                if (!rates) {
                    return { cost: 0, breakdown: [] };
                }
                
                let remainingKwh = kwh;

                // Handle fixed rates first (if there's only one tier)
                if (rates.length === 1) {
                    const rate = rates[0].rate;
                    totalCost = kwh * rate;
                    breakdown.push({ kwh: kwh, rate: rate, cost: kwh * rate });
                } else {
                    // Handle tiered rates
                    for (const tier of rates) {
                        if (remainingKwh <= 0) break;

                        const tierLimit = tier.kwh;
                        const tierRate = tier.rate;

                        if (remainingKwh > tierLimit) {
                            const tierKwh = tierLimit;
                            const tierCost = tierKwh * tierRate;
                            totalCost += tierCost;
                            breakdown.push({ kwh: tierKwh, rate: tierRate, cost: tierCost });
                            remainingKwh -= tierKwh;
                        } else {
                            const tierKwh = remainingKwh;
                            const tierCost = tierKwh * tierRate;
                            totalCost += tierCost;
                            breakdown.push({ kwh: tierKwh, rate: tierRate, cost: tierCost });
                            remainingKwh = 0;
                        }
                    }
                }
                return { cost: totalCost, breakdown: breakdown };
            };

            /**
             * Calculates consumption (kWh) from Amperes.
             * @param {number} amperes The average amperes.
             * @returns {number} The calculated monthly kWh.
             */
            const calculateKwhFromAmperes = (amperes) => {
                // Calculation: Amperes * Volts * Hours/Day * Days/Month / 1000
                // Assuming 220V and 24 hours/day for this calculation
                const kwhPerMonth = (amperes * 220 * 24 * DAYS_IN_MONTH) / 1000;
                return kwhPerMonth;
            };

            /**
             * Displays a small, temporary message to the user.
             * @param {string} message The message to display.
             * @param {string} type The message type ('info', 'success', 'error').
             */
            const showMessage = (message, type = 'info') => {
                appMessage.textContent = message;
                appMessage.className = `show ${type}`;
                setTimeout(() => {
                    appMessage.className = appMessage.className.replace('show', '');
                }, 3000);
            };

            /**
             * Animates a result value with a flashing effect.
             * @param {HTMLElement} element The element to animate.
             * @param {string} resultColor The base color for the result.
             * @param {string} highlightColor The highlight color for the flash.
             */
            const animateResult = (element, resultColor, highlightColor) => {
                element.style.setProperty('--current-result-color', resultColor);
                element.style.setProperty('--current-highlight-color', highlightColor);
                element.classList.remove('flash-animation');
                void element.offsetWidth; // Trigger reflow
                element.classList.add('flash-animation');
            };

            /**
             * Updates all translatable elements on the page.
             * @param {string} lang The language key (e.g., 'en', 'ar', 'ku').
             */
            const updateUIForLanguage = (lang) => {
                const elements = document.querySelectorAll('[data-lang-key]');
                elements.forEach(el => {
                    const key = el.getAttribute('data-lang-key');
                    if (LANGUAGES[lang] && LANGUAGES[lang][key]) {
                        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                            el.placeholder = LANGUAGES[lang][key];
                        } else if (el.tagName === 'OPTION') {
                            el.textContent = LANGUAGES[lang][key];
                        } else {
                            el.textContent = LANGUAGES[lang][key];
                        }
                    }
                });

                // Update category names to include Arabic
                const categoryOptions = {
                    'Household': LANGUAGES[lang]['householdOption'],
                    'Commercial': LANGUAGES[lang]['commercialOption'],
                    'Agriculture': LANGUAGES[lang]['agricultureOption'],
                    'Industrial': LANGUAGES[lang]['industrialOption'],
                    'Large Industry': LANGUAGES[lang]['largeIndustryOption'],
                    'State': LANGUAGES[lang]['stateOption'],
                };
                document.querySelectorAll('#categoryDropdown option, #meterCategoryDropdown option, #deviceCategoryDropdown option').forEach(option => {
                    const value = option.value;
                    if (categoryOptions[value]) {
                        option.textContent = categoryOptions[value];
                    }
                });

                // Set direction and text alignment for RTL languages
                const body = document.body;
                if (lang === 'ar') {
                    body.classList.add('rtl');
                } else {
                    body.classList.remove('rtl');
                }
            };
            
            // --- CALCULATION LOGIC ---

            const performManualCalculation = () => {
                const input = parseFloat(manualInput.value);
                const inputType = manualInputTypeDropdown.value;
                const category = categoryDropdown.value;

                if (isNaN(input) || input <= 0) {
                    manualBillElement.textContent = '0 IQD';
                    manualKwhElement.textContent = '0.00 kWh';
                    showMessage(LANGUAGES[currentLanguage]['reportNoData'], 'error');
                    return;
                }

                let kwh;
                let bill;
                let breakdown;

                if (inputType === 'kWh') {
                    kwh = input;
                    const result = calculateBill(kwh, category);
                    bill = result.cost;
                    breakdown = result.breakdown;
                } else if (inputType === 'Avg Amperes') {
                    kwh = calculateKwhFromAmperes(input);
                    const result = calculateBill(kwh, category);
                    bill = result.cost;
                    breakdown = result.breakdown;
                } else if (inputType === 'Given Bill') {
                    bill = input;
                    // This is more complex and requires inverse calculation, but for now, we will just display the bill and a placeholder for kWh
                    kwh = 0;
                    breakdown = [];
                    // You would need a more sophisticated algorithm to calculate kWh from a given bill with tiered rates
                }

                manualBillElement.textContent = `${formatNumber(bill)} IQD`;
                manualKwhElement.textContent = `${formatNumber(kwh)} kWh`;

                // Flash the results to indicate a change
                animateResult(manualBillElement, 'var(--manual-result-color)', 'var(--manual-highlight-color)');
                animateResult(manualKwhElement, 'var(--manual-result-color)', 'var(--manual-highlight-color)');
                
                // Store calculation details for the report
                manualCalculationSection.dataset.kwh = kwh;
                manualCalculationSection.dataset.bill = bill;
                manualCalculationSection.dataset.breakdown = JSON.stringify(breakdown);
                manualCalculationSection.dataset.category = category;
            };

            const performMeterCalculation = () => {
                const currentReading = parseFloat(meterReadingInput.value);
                const previousReading = parseFloat(previousReadingInput.value);
                const category = meterCategoryDropdown.value;

                if (isNaN(currentReading) || isNaN(previousReading) || currentReading < previousReading) {
                    meterBillElement.textContent = '0 IQD';
                    meterKwhElement.textContent = '0.00 kWh';
                    showMessage(LANGUAGES[currentLanguage]['reportNoData'], 'error');
                    return;
                }

                const kwh = currentReading - previousReading;
                const result = calculateBill(kwh, category);
                let bill = result.cost;

                // Add fixed meter reading cost
                bill += METER_READING_COST_PER_MONTH;

                meterBillElement.textContent = `${formatNumber(bill)} IQD`;
                meterKwhElement.textContent = `${formatNumber(kwh)} kWh`;

                // Flash the results to indicate a change
                animateResult(meterBillElement, 'var(--meter-result-color)', 'var(--meter-highlight-color)');
                animateResult(meterKwhElement, 'var(--meter-result-color)', 'var(--meter-highlight-color)');

                // Store calculation details for the report
                meterCalculationSection.dataset.kwh = kwh;
                meterCalculationSection.dataset.bill = bill;
                meterCalculationSection.dataset.breakdown = JSON.stringify(result.breakdown);
                meterCalculationSection.dataset.category = category;
            };

            const calculateDeviceConsumption = () => {
                let totalKwh = 0;
                let totalCost = 0;
                const category = deviceCategoryDropdown.value;

                const activeDevices = deviceData.filter(device => device.isActive);

                if (activeDevices.length === 0) {
                    totalDeviceConsumptionElement.textContent = '0.00 kWh';
                    totalDeviceBillElement.textContent = '0 IQD';
                    deviceCalculationSection.dataset.kwh = 0;
                    deviceCalculationSection.dataset.bill = 0;
                    deviceCalculationSection.dataset.breakdown = JSON.stringify([]);
                    deviceCalculationSection.dataset.activeDevices = JSON.stringify([]);
                    return;
                }

                // Calculate total kWh first
                activeDevices.forEach(device => {
                    const monthlyKwh = (device.power * device.dailyHours * DAYS_IN_MONTH) / 1000;
                    totalKwh += monthlyKwh;
                    device.monthlyKwh = monthlyKwh; // Update the device object
                });
                
                // Then calculate the total cost based on the total kWh and tiered rates
                const result = calculateBill(totalKwh, category);
                totalCost = result.cost;
                
                // Now, distribute the cost back to each device proportionally
                activeDevices.forEach(device => {
                    const costFraction = device.monthlyKwh / totalKwh;
                    device.monthlyCost = totalCost * costFraction;
                });
                
                // Update UI
                totalDeviceConsumptionElement.textContent = `${formatNumber(totalKwh)} kWh`;
                totalDeviceBillElement.textContent = `${formatNumber(totalCost)} IQD`;
                
                // Flash the results
                animateResult(totalDeviceConsumptionElement, 'var(--device-result-color)', 'var(--device-highlight-color)');
                animateResult(totalDeviceBillElement, 'var(--device-result-color)', 'var(--device-highlight-color)');

                // Update the device table
                renderDeviceTable();

                // Store calculation details for the report
                deviceCalculationSection.dataset.kwh = totalKwh;
                deviceCalculationSection.dataset.bill = totalCost;
                deviceCalculationSection.dataset.breakdown = JSON.stringify(result.breakdown);
                deviceCalculationSection.dataset.category = category;
                deviceCalculationSection.dataset.activeDevices = JSON.stringify(activeDevices);
            };

            // --- UI RENDERING & EVENT HANDLERS ---

            const renderDeviceTable = () => {
                deviceTableBody.innerHTML = '';
                deviceData.forEach((device, index) => {
                    const row = document.createElement('tr');
                    row.dataset.index = index;
                    if (device.isActive) {
                        row.classList.add('selected-row');
                    }
                    row.innerHTML = `
                        <td class="w-1/4">
                            <input type="text" value="${device.name}" class="device-name-input" data-index="${index}">
                        </td>
                        <td class="w-1/6">
                            <input type="number" value="${device.power}" class="device-power-input" data-index="${index}">
                        </td>
                        <td class="w-1/6">
                            <input type="number" value="${device.dailyHours}" class="device-hours-input" data-index="${index}">
                        </td>
                        <td class="output-cell font-mono w-1/6">${formatNumber(device.monthlyKwh)} kWh</td>
                        <td class="output-cell font-mono w-1/6">${formatNumber(device.monthlyCost)} IQD</td>
                        <td class="w-1/12">
                            <input type="checkbox" ${device.isActive ? 'checked' : ''} class="device-active-checkbox" data-index="${index}">
                        </td>
                        <td class="w-1/12">
                            <button class="delete-device-button text-red-500 hover:text-red-700" data-index="${index}">&times;</button>
                        </td>
                    `;
                    deviceTableBody.appendChild(row);
                });

                // Attach event listeners to new elements
                document.querySelectorAll('.device-name-input, .device-power-input, .device-hours-input').forEach(input => {
                    input.addEventListener('change', updateDeviceData);
                });
                document.querySelectorAll('.device-active-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', updateDeviceData);
                });
                document.querySelectorAll('.delete-device-button').forEach(button => {
                    button.addEventListener('click', deleteDevice);
                });
            };

            const updateDeviceData = (e) => {
                const index = parseInt(e.target.dataset.index);
                const device = deviceData[index];

                if (e.target.classList.contains('device-name-input')) {
                    device.name = e.target.value;
                } else if (e.target.classList.contains('device-power-input')) {
                    device.power = parseFloat(e.target.value) || 0;
                } else if (e.target.classList.contains('device-hours-input')) {
                    device.dailyHours = parseFloat(e.target.value) || 0;
                } else if (e.target.classList.contains('device-active-checkbox')) {
                    device.isActive = e.target.checked;
                    // Re-render the row to update the highlight class
                    const row = e.target.closest('tr');
                    if (device.isActive) {
                        row.classList.add('selected-row');
                    } else {
                        row.classList.remove('selected-row');
                    }
                }
                
                // Recalculate consumption and cost for all devices
                calculateDeviceConsumption();
            };

            const deleteDevice = (e) => {
                const index = parseInt(e.target.dataset.index);
                deviceData.splice(index, 1);
                calculateDeviceConsumption(); // Re-render and recalculate
            };

            const startupPopulateDeviceTable = () => {
                // Initial data for the table
                deviceData = [
                    { name: 'AC (1 Ton)', power: 1500, dailyHours: 8, isActive: true, monthlyKwh: 0, monthlyCost: 0 },
                    { name: 'Refrigerator', power: 150, dailyHours: 24, isActive: true, monthlyKwh: 0, monthlyCost: 0 },
                    { name: 'TV', power: 100, dailyHours: 5, isActive: false, monthlyKwh: 0, monthlyCost: 0 },
                    { name: 'Washing Machine', power: 2500, dailyHours: 1, isActive: false, monthlyKwh: 0, monthlyCost: 0 }
                ];
            };

            const createTariffChart = (category) => {
                const rates = TARIFF_RATES[category];
                if (!rates || rates.length === 0) {
                    console.error("No tariff data for category:", category);
                    return;
                }

                if (tariffChart) {
                    tariffChart.destroy();
                }

                const labels = rates.map((tier, index) => {
                    if (tier.kwh === Infinity) {
                        return `> ${rates[index - 1].kwh} kWh`;
                    }
                    if (index === 0) {
                        return `0 - ${tier.kwh} kWh`;
                    }
                    return `${rates[index - 1].kwh + 1} - ${tier.kwh} kWh`;
                });

                const data = rates.map(tier => tier.rate);
                const colors = ['#facc15', '#fb923c', '#ef4444', '#b91c1c'];

                const chartData = {
                    labels: labels,
                    datasets: [{
                        label: 'Tariff Rate (IQD/kWh)',
                        data: data,
                        backgroundColor: colors.slice(0, data.length),
                        borderColor: 'transparent',
                        borderWidth: 1,
                        borderRadius: 5,
                        hoverOffset: 4,
                    }]
                };

                const config = {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false,
                            },
                            title: {
                                display: true,
                                text: `${LANGUAGES[currentLanguage].tariffDetailsTitle} (${category})`,
                                color: 'var(--text-light)',
                                font: {
                                    size: 16,
                                    weight: 'bold'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += `${context.parsed.y} IQD/kWh`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: 'var(--text-medium-light)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: 'var(--text-medium-light)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                };

                tariffChart = new Chart(tariffChartCanvas, config);
                tariffChartContainer.style.display = 'block';
            };

            const showTariffDetails = (category) => {
                const rates = TARIFF_RATES[category];
                let content = `Category: ${category}\n\n`;

                if (rates.length === 1) {
                    content += `Fixed Rate: ${rates[0].rate} IQD/kWh`;
                } else {
                    rates.forEach((tier, index) => {
                        let range = '';
                        if (index === 0) {
                            range = `0 - ${tier.kwh} kWh`;
                        } else if (tier.kwh === Infinity) {
                            range = `${rates[index - 1].kwh + 1}+ kWh`;
                        } else {
                            range = `${rates[index - 1].kwh + 1} - ${tier.kwh} kWh`;
                        }
                        content += `Tier ${index + 1}: ${range} -> ${tier.rate} IQD/kWh\n`;
                    });
                }
                
                tariffDetailsContent.textContent = content;
                tariffDetailsModal.style.display = 'flex';
                
                createTariffChart(category);
            };

            const generateReport = () => {
                const manualKwh = manualCalculationSection.dataset.kwh || 0;
                const manualBill = manualCalculationSection.dataset.bill || 0;
                const manualBreakdown = JSON.parse(manualCalculationSection.dataset.breakdown || '[]');
                const manualCategory = manualCalculationSection.dataset.category || '';

                const meterKwh = meterCalculationSection.dataset.kwh || 0;
                const meterBill = meterCalculationSection.dataset.bill || 0;
                const meterBreakdown = JSON.parse(meterCalculationSection.dataset.breakdown || '[]');
                const meterCategory = meterCalculationSection.dataset.category || '';

                const deviceKwh = deviceCalculationSection.dataset.kwh || 0;
                const deviceBill = deviceCalculationSection.dataset.bill || 0;
                const deviceBreakdown = JSON.parse(deviceCalculationSection.dataset.breakdown || '[]');
                const deviceCategory = deviceCalculationSection.dataset.category || '';
                const activeDevices = JSON.parse(deviceCalculationSection.dataset.activeDevices || '[]');
                
                if (manualKwh === 0 && meterKwh === 0 && deviceKwh === 0) {
                    showMessage(LANGUAGES[currentLanguage]['reportNoData'], 'error');
                    return;
                }

                let reportHtml = '';

                // Manual Calculation Report
                reportHtml += `<div class="report-section-title">${LANGUAGES[currentLanguage]['reportHeaderManual']} (${manualCategory})</div>`;
                if (manualKwh > 0) {
                    reportHtml += `<p><span class="report-item-label">${LANGUAGES[currentLanguage]['reportTotalConsumption']}</span> <span class="report-item-value">${formatNumber(manualKwh)} kWh</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${LANGUAGES[currentLanguage]['reportTotalBill']}</span> <span class="report-item-value">${formatNumber(manualBill)} IQD</span></p>`;
                    reportHtml += `<p class="mt-2 font-bold">${LANGUAGES[currentLanguage]['reportBreakdown']}</p>`;
                    manualBreakdown.forEach(item => {
                        const template = TARIFF_RATES[manualCategory].length === 1 ? 'reportItemFixed' : 'reportItem';
                        reportHtml += `<p class="report-breakdown-item">${LANGUAGES[currentLanguage][template]
                            .replace('{{kwh}}', formatNumber(item.kwh))
                            .replace('{{rate}}', item.rate)
                            .replace('{{cost}}', formatNumber(item.cost))}</p>`;
                    });
                } else {
                    reportHtml += `<p class="text-gray-400 italic">${LANGUAGES[currentLanguage]['reportNoData']}</p>`;
                }

                // Meter Calculation Report
                reportHtml += `<div class="report-section-title">${LANGUAGES[currentLanguage]['reportHeaderMeter']} (${meterCategory})</div>`;
                if (meterKwh > 0) {
                    reportHtml += `<p><span class="report-item-label">${LANGUAGES[currentLanguage]['reportTotalConsumption']}</span> <span class="report-item-value">${formatNumber(meterKwh)} kWh</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${LANGUAGES[currentLanguage]['reportTotalBill']}</span> <span class="report-item-value">${formatNumber(meterBill)} IQD</span></p>`;
                    reportHtml += `<p class="mt-2 font-bold">${LANGUAGES[currentLanguage]['reportBreakdown']}</p>`;
                    meterBreakdown.forEach(item => {
                        const template = TARIFF_RATES[meterCategory].length === 1 ? 'reportItemFixed' : 'reportItem';
                        reportHtml += `<p class="report-breakdown-item">${LANGUAGES[currentLanguage][template]
                            .replace('{{kwh}}', formatNumber(item.kwh))
                            .replace('{{rate}}', item.rate)
                            .replace('{{cost}}', formatNumber(item.cost))}</p>`;
                    });
                    reportHtml += `<p class="report-breakdown-item">${LANGUAGES[currentLanguage]['reportFixedMeterCost']} ${formatNumber(METER_READING_COST_PER_MONTH)} IQD</p>`;
                } else {
                    reportHtml += `<p class="text-gray-400 italic">${LANGUAGES[currentLanguage]['reportNoData']}</p>`;
                }

                // Device List Report
                reportHtml += `<div class="report-section-title">${LANGUAGES[currentLanguage]['reportHeaderDevice']} (${deviceCategory})</div>`;
                if (activeDevices.length > 0) {
                    reportHtml += `<p><span class="report-item-label">${LANGUAGES[currentLanguage]['reportTotalConsumption']}</span> <span class="report-item-value">${formatNumber(deviceKwh)} kWh</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${LANGUAGES[currentLanguage]['reportTotalBill']}</span> <span class="report-item-value">${formatNumber(deviceBill)} IQD</span></p>`;
                    reportHtml += `<p class="mt-4 font-bold">${LANGUAGES[currentLanguage]['reportDeviceTableTitle']}</p>`;
                    reportHtml += `<table class="report-table"><thead><tr><th>${LANGUAGES[currentLanguage]['reportTableDevice']}</th><th>${LANGUAGES[currentLanguage]['reportTableConsumption']}</th><th>${LANGUAGES[currentLanguage]['reportTableCost']}</th></tr></thead><tbody>`;
                    activeDevices.forEach(device => {
                        reportHtml += `<tr><td>${device.name}</td><td>${formatNumber(device.monthlyKwh)} kWh</td><td>${formatNumber(device.monthlyCost)} IQD</td></tr>`;
                    });
                    reportHtml += `</tbody></table>`;
                    
                    reportHtml += `<p class="mt-2 font-bold">${LANGUAGES[currentLanguage]['reportBreakdown']}</p>`;
                    deviceBreakdown.forEach(item => {
                        const template = TARIFF_RATES[deviceCategory].length === 1 ? 'reportItemFixed' : 'reportItem';
                        reportHtml += `<p class="report-breakdown-item">${LANGUAGES[currentLanguage][template]
                            .replace('{{kwh}}', formatNumber(item.kwh))
                            .replace('{{rate}}', item.rate)
                            .replace('{{cost}}', formatNumber(item.cost))}</p>`;
                    });
                } else {
                    reportHtml += `<p class="text-gray-400 italic">${LANGUAGES[currentLanguage]['reportNoData']}</p>`;
                }
                
                reportContent.innerHTML = reportHtml;
                reportModal.style.display = 'flex';
            };


            // --- EVENT LISTENERS ---
            manualInputTypeDropdown.addEventListener('change', () => {
                const inputType = manualInputTypeDropdown.value;
                if (inputType === 'Given Bill') {
                    manualInput.value = '20000';
                } else {
                    manualInput.value = '1891';
                }
            });
            categoryDropdown.addEventListener('change', () => {
                currentCategory = categoryDropdown.value;
                performManualCalculation();
            });
            meterCategoryDropdown.addEventListener('change', performMeterCalculation);
            deviceCategoryDropdown.addEventListener('change', calculateDeviceConsumption);
            addDeviceButton.addEventListener('click', () => {
                const newDevice = { name: 'New Device', power: 100, dailyHours: 1, isActive: true, monthlyKwh: 0, monthlyCost: 0 };
                deviceData.push(newDevice);
                calculateDeviceConsumption();
            });

            calculateManualButton.addEventListener('click', performManualCalculation);
            calculateMeterButton.addEventListener('click', performMeterCalculation);
            generateReportButton.addEventListener('click', generateReport);
            manualTariffDetailsButton.addEventListener('click', () => showTariffDetails(categoryDropdown.value));
            meterTariffDetailsButton.addEventListener('click', () => showTariffDetails(meterCategoryDropdown.value));
            deviceTariffDetailsButton.addEventListener('click', () => showTariffDetails(deviceCategoryDropdown.value));

            // Language Buttons
            langEnButton.addEventListener('click', () => { currentLanguage = 'en'; updateUIForLanguage('en'); });
            langArButton.addEventListener('click', () => { currentLanguage = 'ar'; updateUIForLanguage('ar'); });
            langKuButton.addEventListener('click', () => { currentLanguage = 'ku'; updateUIForLanguage('ku'); });

            // Close modals
            closeTariffModal.addEventListener('click', () => {
                tariffDetailsModal.style.display = 'none'; // Hide the modal
                if (tariffChart) {
                    tariffChart.destroy();
                    tariffChart = null;
                }
                tariffChartContainer.style.display = 'none'; // Hide the chart container
            });

            // Close modal if clicked outside content
            tariffDetailsModal.addEventListener('click', (e) => {
                if (e.target === tariffDetailsModal) {
                    tariffDetailsModal.style.display = 'none';
                    if (tariffChart) {
                        tariffChart.destroy();
                        tariffChart = null;
                    }
                    tariffChartContainer.style.display = 'none'; // Hide the chart container
                }
            });

            closeReportModal.addEventListener('click', () => {
                reportModal.style.display = 'none';
            });

            reportModal.addEventListener('click', (e) => {
                if (e.target === reportModal) {
                    reportModal.style.display = 'none';
                }
            });


            // --- INITIALIZATION CALLS ---
            updateUIForLanguage(currentLanguage); // Set initial language
            startupPopulateDeviceTable(); // Populate table on load
            calculateDeviceConsumption(); // Calculate initial device consumption
            performManualCalculation(); // Perform initial manual calculation
            performMeterCalculation(); // Perform initial meter calculation
        });
    </script>
</body>
</html>
