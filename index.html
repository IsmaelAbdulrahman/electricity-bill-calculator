<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="appTitle">Iraqi Electricity Bill Calculator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for plotting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <style>
        /* Define a custom color palette using CSS variables for consistency */
        :root {
            --primary-blue: #3b82f6; /* A clean, vibrant blue */
            --secondary-green: #22c55e; /* A fresh green */
            --accent-orange: #f97316; /* A warm orange */
            --accent-purple: #8b5cf6; /* A soft purple */
            --neutral-gray-dark: #374151; /* Dark gray for text */
            --neutral-gray-medium: #6b7280; /* Medium gray for labels */
            --neutral-gray-light: #e5e7eb; /* Light gray for borders/backgrounds */
            --background-light: #f9fafb; /* Very light background */
            --card-background: #ffffff; /* White for cards */
            --highlight-yellow: #facc15; /* Yellow for highlights */
            --error-red: #ef4444; /* Standard error red */

            /* New light gray button colors */
            --button-light-gray: #e0e0e0;
            --button-hover-gray: #d1d1d1;
            --button-active-gray: #c0c0c0;
            --button-dark-text: #333f48;

            /* Night mode specific colors */
            --background-dark: #1a202c; /* Deep dark background */
            --card-dark: #2d3748; /* Slightly lighter dark for cards */
            --text-light: #e2e8f0; /* Light gray for main text */
            --text-medium-light: #a0aec0; /* Medium light gray for labels */
            --input-dark-bg: #4a5568; /* Darker input background */
            --input-dark-border: #6b7280; /* Darker input border */
            --result-item-dark-bg: #3c4a5c; /* Darker result item background */
            --result-item-dark-border: #5a6a7c; /* Darker result item border */
            --primary-blue-darker: #2563eb; /* A slightly darker blue for accents on dark background */
            --highlight-yellow-dark: #fbbf24; /* Brighter yellow for dark background */
            
            /* Dynamic colors for result displays */
            --manual-result-color: #fef08a; /* Light yellow */
            --manual-highlight-color: #fbbf24; /* Brighter yellow */
            --meter-result-color: #bbf7d0; /* Light green */
            --meter-highlight-color: #86efac; /* Brighter green */
            --device-result-color: #a7f3d0; /* Light teal/cyan */
            --device-highlight-color: #5eead4; /* Brighter teal/cyan */
            --optimization-result-color: #bfdbfe; /* Light blue */
            --optimization-highlight-color: #93c5fd; /* Brighter blue */
        }

        /* Custom styles for better aesthetics and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-dark); /* Night mode background */
            margin: 0;
            padding: 2rem; /* Increased padding */
            color: var(--text-light); /* Night mode text color */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: pan-x pan-y;
        }

        /* RTL specific styles */
        body.rtl {
            direction: rtl;
            text-align: right;
        }

        body.rtl .input-group label {
            /* Adjust label alignment for RTL if needed, depends on flex layout */
            margin-right: 0;
            margin-left: 1.25rem; /* Equivalent of gap from LTR */
        }

        body.rtl .device-table th, 
        body.rtl .device-table td {
            text-align: center; /* Keep center for table cells */
        }

        body.rtl .modal-close-button {
            right: unset;
            left: 1rem;
        }
        
        /* Language selector styling */
        .language-selector {
            margin-top: 1rem; /* Space from the content above */
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
        }

        h1 {
            color: white; /* Changed to white as requested */
            font-weight: 800;
            margin-bottom: 2.5rem; /* Increased margin */
            text-align: center;
            font-size: 2.75rem; /* Slightly larger font size */
            letter-spacing: -0.025em; /* Tighten letter spacing slightly */
        }

        h2 {
            color: var(--text-light); /* Night mode heading color */
            font-weight: 700;
            margin-bottom: 1.25rem; /* Increased margin */
            text-align: left;
            font-size: 1.6rem; /* Slightly larger for section titles */
        }

        .main-container {
            display: flex;
            flex-direction: column; /* Always column layout */
            gap: 2.5rem; /* Increased gap */
            width: 100%;
            max-width: 45rem; /* Adjusted max-width for single column */
            background-color: var(--card-dark); /* Night mode card background */
            padding: 2.5rem; /* Increased padding */
            border-radius: 1.25rem; /* More rounded corners */
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.25); /* Stronger, diffused shadow for dark mode */
        }

        .section-card {
            background-color: var(--card-dark); /* Night mode card background */
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 1rem; /* More rounded corners */
            padding: 2rem; /* Increased padding */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); /* Softer shadow */
        }

        .input-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1.25rem; /* Increased gap */
            margin-bottom: 1.75rem; /* Increased margin */
        }

        label {
            font-weight: 600;
            color: var(--text-medium-light); /* Night mode label color */
            flex-shrink: 0; /* Prevent label from shrinking */
        }

        input[type="text"],
        input[type="number"],
        select {
            padding: 0.75rem 1rem; /* More padding */
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 0.6rem; /* More rounded corners */
            font-size: 1rem; /* Slightly larger font */
            text-align: center;
            background-color: var(--input-dark-bg); /* Night mode input background */
            color: var(--text-light); /* Night mode input text color */
            flex-grow: 1;
            min-width: 8rem; /* Slightly larger min-width */
            transition: all 0.2s ease-in-out;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Subtle inner shadow */
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--primary-blue-darker); /* Night mode focus border */
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4); /* Soft blue glow on focus for night mode */
            outline: none;
        }

        /* General button styling */
        button {
            padding: 0.75rem 1.5rem; /* More padding */
            border-radius: 0.6rem; /* More rounded corners */
            border: none; /* Removed border */
            font-size: 1rem; /* Slightly larger font */
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Stronger button shadow */
            white-space: nowrap;
            color: var(--button-dark-text); /* Dark text for light grey button */
            margin: 0.5rem; /* Increased margin for spacing between buttons */
            background-color: var(--button-light-gray); /* Light grey background */
        }

        button:hover {
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 8px 16px rgba(0,0,0,0.2); /* Stronger hover shadow */
            opacity: 0.95;
            background-color: var(--button-hover-gray); /* Slightly darker grey on hover */
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: var(--button-active-gray); /* Keep background light grey when active */
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(8rem, 1fr)); /* Adjusted min-width for results */
            gap: 1rem; /* Increased gap */
            font-size: 1rem;
            margin-top: 1rem; /* Added margin-top */
            max-width: 40rem; /* Max width for the grid itself */
            margin-left: auto; /* Center the grid */
            margin-right: auto; /* Center the grid */
        }

        .result-item {
            background-color: var(--result-item-dark-bg); /* Night mode result item background */
            border: 1px solid var(--result-item-dark-border); /* Night mode result item border */
            border-radius: 0.75rem;
            padding: 1.2rem; /* More padding */
            text-align: center;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.07); /* Inner shadow for depth */
        }

        .result-label {
            color: var(--text-medium-light); /* Night mode result label color */
            margin-bottom: 0.4rem;
            font-weight: 500;
        }

        .result-value {
            font-weight: 800;
            /* Use dynamic CSS variables for color */
            color: var(--current-result-color); 
            font-size: 1.25rem; /* Larger font for values */
            transition: color 0.2s ease-in-out; /* Smooth transition for color flash */
        }

        /* Flashing animation for result values */
        @keyframes flashEffect {
            0% { color: var(--current-result-color); } /* Start with dynamic color */
            16.6% { color: var(--current-highlight-color); } /* Flash brighter dynamic color */
            33.3% { color: var(--current-result-color); } /* Back to dynamic color */
            50% { color: var(--current-highlight-color); } /* Flash brighter dynamic color again */
            66.6% { color: var(--current-result-color); } /* Back to dynamic color */
            83.3% { color: var(--current-highlight-color); } /* Flash brighter dynamic color one last time */
            100% { color: var(--current-result-color); } /* End with dynamic color */
        }

        .flash-animation {
            animation: flashEffect 1.8s ease-out; /* 3 flashes over 1.8 seconds */
        }

        /* Chart container styling */
        .chart-container {
            width: 100%;
            height: 300px; /* Fixed height for chart */
            margin-top: 2rem; 
            background-color: var(--card-dark); 
            border-radius: 1rem;
            padding: 1.5rem; 
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
        }

        /* Slider styling (Not used in this version, but kept for reference) */
        .range-slider {
            width: 100%;
            height: 0.75rem; 
            background-color: #d1fae5; 
            border-radius: 0.4rem;
            appearance: none;
            cursor: grab;
            margin-top: 2rem; 
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.1);
        }

        .range-slider::-webkit-slider-thumb {
            appearance: none;
            width: 1.8rem; 
            height: 1.8rem; 
            background: var(--secondary-green);
            border-radius: 50%;
            border: 4px solid white; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); 
            transition: background 0.15s ease-in-out;
            cursor: grab;
        }
        .range-slider::-webkit-slider-thumb:active {
            cursor: grabbing;
        }

        .range-slider::-moz-range-thumb {
            width: 1.8rem;
            height: 1.8rem;
            background: var(--secondary-green);
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: background 0.15s ease-in-out;
            cursor: grab;
        }
        .range-slider::-moz-range-thumb:active {
            cursor: grabbing;
        }

        .range-slider::-webkit-slider-runnable-track {
            background: linear-gradient(to right, #a7f3d0 0%, #a7f3d0 var(--slider-fill, 0%), #fff var(--slider-fill, 0%), #fff 100%);
            border-radius: 0.4rem;
        }

        .range-slider::-moz-range-track {
            background: linear-gradient(to right, #a7f3d0 0%, #a7f3d0 var(--slider-fill, 0%), #fff var(--slider-fill, 0%), #fff 100%);
            border-radius: 0.4rem;
        }

        /* Device Table Styling */
        .device-table-container {
            overflow-x: auto;
            max-height: 500px; /* Slightly taller table */
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 1rem;
            margin-bottom: 2rem; /* Increased margin */
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2); /* Stronger shadow for dark mode */
        }

        .device-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Ensure table doesn't get too narrow on small screens */
        }

        .device-table th, .device-table td {
            padding: 1rem 0.8rem; /* More padding */
            text-align: center;
            border-bottom: 1px solid var(--input-dark-border); /* Night mode border */
            font-size: 0.95rem; /* Slightly larger font */
        }

        .device-table th {
            background-color: var(--input-dark-bg); /* Night mode header background */
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            color: var(--text-light); /* Night mode header text */
        }

        .device-table tbody tr:hover {
            background-color: #3a475c; /* Darker hover effect for table rows */
        }

        .device-table tbody tr.selected-row {
            background-color: #3b82f640; /* Light blue highlight on dark background */
            box-shadow: inset 0 0 0 3px var(--primary-blue-darker); /* Blue border on selected row */
        }

        .device-table input[type="text"],
        .device-table input[type="number"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 0.4rem;
            text-align: center;
            font-size: 0.9rem;
            background-color: var(--input-dark-bg); /* Night mode input background */
            color: var(--text-light); /* Night mode input text */
        }

        .device-table input[type="checkbox"] {
            width: 1.2rem; /* Slightly larger checkbox */
            height: 1.2rem;
            cursor: pointer;
            border-radius: 0.3rem;
            accent-color: var(--primary-blue-darker); /* Night mode checkbox accent */
        }

        .device-table .output-cell {
            background-color: #2a3a4c; /* Darker blue for output values */
            font-weight: 600;
            color: var(--primary-blue-darker); /* A subtle blue for output values */
        }

        /* Responsive adjustments for table inputs */
        @media (max-width: 768px) {
            .device-table input[type="text"],
            .device-table input[type="number"] {
                width: 100%;
            }
        }

        /* Custom Modal for Tariff Details */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--card-dark); /* Night mode modal background */
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            color: var(--text-light); /* Night mode modal text */
            position: relative;
        }

        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light); /* Night mode close button color */
            cursor: pointer;
        }
        .modal-close-button:hover {
            color: var(--primary-blue-darker); /* Night mode close button hover */
        }

        .modal-content h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-blue-darker); /* Night mode modal heading color */
            margin-bottom: 1rem;
        }

        .modal-content pre {
            background-color: #1a202c; /* Deeper dark for code/preformatted text */
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: 'Cascadia Code', 'Fira Code', monospace;
            font-size: 0.9rem;
            color: #a0aec0; /* Lighter text for code */
        }

        /* Footer */
        footer {
            color: var(--text-medium-light); /* Night mode footer text */
            margin-top: 8rem; /* Increased margin-top for footer */
            text-align: center;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        /* Message Box Styling */
        #appMessage {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1100;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            color: white; /* Default text color for messages */
        }
        #appMessage.show {
            opacity: 1;
            transform: translateY(0);
        }
        #appMessage.info {
            background-color: #3b82f6;
        } /* Blue for info */
        #appMessage.success {
            background-color: #22c55e;
        } /* Green for success */
        #appMessage.error {
            background-color: #ef4444;
        } /* Red for error */

        /* Report Modal Specific Styles */
        .report-section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-blue-darker);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-blue-darker);
            padding-bottom: 0.5rem;
        }
        .report-item-label {
            font-weight: 600;
            color: var(--text-medium-light);
            margin-right: 0.5rem;
        }
        .report-item-value {
            font-weight: 700;
            color: var(--text-light);
        }
        .report-breakdown-item {
            margin-left: 1rem;
            font-size: 0.95rem;
            color: var(--text-medium-light);
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background-color: var(--input-dark-bg);
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .report-table th, .report-table td {
            padding: 0.75rem;
            border: 1px solid var(--input-dark-border);
            text-align: left;
            color: var(--text-light);
        }
        .report-table th {
            background-color: var(--primary-blue-darker);
            color: white;
            font-weight: 700;
        }
        .report-table tbody tr:nth-child(even) {
            background-color: #3a475c; /* Slightly different background for even rows */
        }

    </style>
</head>
<body>
    <h1 class="text-3xl lg:text-4xl" data-lang-key="mainTitle">Iraqi Electricity Bill Calculator</h1>

    <div class="main-container">
        <!-- Main content now in a single column -->
        <div class="flex flex-col w-full space-y-8">
            <!-- 1. Manual Calculation -->
            <div class="section-card" id="manualCalculationSection">
                <h2 class="text-xl" data-lang-key="manualCalculationTitle">1. Manual Calculation</h2>
                <div class="input-group">
                    <label for="categoryDropdown" data-lang-key="categoryLabel">Category:</label>
                    <select id="categoryDropdown" class="p-2 border rounded-md">
                        <option value="Household" data-lang-key="householdOption">Household</option>
                        <option value="Commercial" data-lang-key="commercialOption">Commercial</option>
                        <option value="Agriculture" data-lang-key="agricultureOption">Agriculture</option>
                        <option value="Industrial" data-lang-key="industrialOption">Industrial</option>
                        <option value="Large Industry" data-lang-key="largeIndustryOption">Large Industry</option>
                        <option value="State" data-lang-key="stateOption">State</option>
                    </select>

                    <label for="manualInputTypeDropdown" data-lang-key="inputLabel">Input:</label>
                    <select id="manualInputTypeDropdown" class="p-2 border rounded-md">
                        <option value="kWh" data-lang-key="kwhOption">kWh</option>
                        <option value="Avg Amperes" data-lang-key="avgAmperesOption">Avg Amperes</option>
                        <option value="Given Bill" data-lang-key="givenBillOption">Given Bill (IQD)</option>
                    </select>

                    <input type="number" id="manualInput" value="1891" class="w-28">
                </div>
                <button id="calculateManualButton" class="btn w-full" data-lang-key="calculateBillButton">Calculate Bill</button>

                <div class="result-grid" id="manualResultGrid">
                    <div class="result-item">
                        <div class="result-label" data-lang-key="billLabel">Bill</div>
                        <div class="result-value" id="manualBill">0 IQD</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="consumptionLabel">Consumption</div>
                        <div class="result-value" id="manualKwh">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="rateLabel">Avg Rate</div>
                        <div class="result-value" id="manualAvgRate">0.00 IQD/kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="costPerAmpereLabel">Cost/Ampere</div>
                        <div class="result-value" id="manualCostPerAmpere">0.00 IQD/A</div>
                    </div>
                </div>
            </div>
            
            <!-- 2. Meter Reading Calculation -->
            <div class="section-card" id="meterCalculationSection">
                <h2 class="text-xl" data-lang-key="meterCalculationTitle">2. Meter Reading Calculation</h2>
                <div class="input-group">
                    <label for="previousReading" data-lang-key="previousReadingLabel">Previous Reading (kWh):</label>
                    <input type="number" id="previousReading" value="10000" class="w-28">
                    <label for="currentReading" data-lang-key="currentReadingLabel">Current Reading (kWh):</label>
                    <input type="number" id="currentReading" value="11891" class="w-28">
                </div>
                <button id="calculateMeterButton" class="btn w-full" data-lang-key="calculateBillButton">Calculate Bill</button>
                <div class="result-grid" id="meterResultGrid">
                    <div class="result-item">
                        <div class="result-label" data-lang-key="billLabel">Bill</div>
                        <div class="result-value" id="meterBill">0 IQD</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="consumptionLabel">Consumption</div>
                        <div class="result-value" id="meterKwh">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="rateLabel">Avg Rate</div>
                        <div class="result-value" id="meterAvgRate">0.00 IQD/kWh</div>
                    </div>
                </div>
            </div>

            <!-- 3. Device Consumption -->
            <div class="section-card" id="deviceConsumptionSection">
                <h2 class="text-xl" data-lang-key="deviceConsumptionTitle">3. Device Consumption</h2>
                <div class="input-group">
                    <label for="deviceCategoryDropdown" data-lang-key="categoryLabel">Category:</label>
                    <select id="deviceCategoryDropdown" class="p-2 border rounded-md">
                        <option value="Household" data-lang-key="householdOption">Household</option>
                        <option value="Commercial" data-lang-key="commercialOption">Commercial</option>
                        <option value="Agriculture" data-lang-key="agricultureOption">Agriculture</option>
                        <option value="Industrial" data-lang-key="industrialOption">Industrial</option>
                        <option value="Large Industry" data-lang-key="largeIndustryOption">Large Industry</option>
                        <option value="State" data-lang-key="stateOption">State</option>
                    </select>
                </div>
                
                <div class="device-table-container shadow-lg rounded-xl">
                    <table class="device-table" id="deviceTable">
                        <thead>
                            <tr>
                                <th data-lang-key="deviceNameHeader">Device Name</th>
                                <th data-lang-key="wattsHeader">Watts (W)</th>
                                <th data-lang-key="quantityHeader">Quantity</th>
                                <th data-lang-key="hoursHeader">Hours/Day</th>
                                <th data-lang-key="totalKwhHeader">Total kWh</th>
                                <th data-lang-key="totalCostHeader">Total Cost (IQD)</th>
                                <th data-lang-key="actionsHeader">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Device rows will be added here dynamically by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-center flex-wrap gap-2 mt-4">
                    <button id="addDeviceButton" class="btn bg-blue-500 text-white hover:bg-blue-600" data-lang-key="addDeviceButton">Add Device</button>
                    <button id="removeSelectedButton" class="btn bg-red-500 text-white hover:bg-red-600" data-lang-key="removeSelectedButton">Remove Selected</button>
                    <button id="calculateDeviceButton" class="btn bg-green-500 text-white hover:bg-green-600" data-lang-key="calculateDeviceButton">Calculate All</button>
                </div>
                
                <div class="result-grid" id="deviceResultGrid">
                    <div class="result-item">
                        <div class="result-label" data-lang-key="billLabel">Total Bill</div>
                        <div class="result-value" id="deviceTotalBill">0 IQD</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="consumptionLabel">Total Consumption</div>
                        <div class="result-value" id="deviceTotalKwh">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="rateLabel">Avg Rate</div>
                        <div class="result-value" id="deviceAvgRate">0.00 IQD/kWh</div>
                    </div>
                </div>
            </div>

            <!-- Information and Report Section -->
            <div class="flex justify-center flex-wrap gap-4 mt-8">
                <button id="showTariffDetailsButton" class="btn bg-gray-400 text-gray-800 hover:bg-gray-500" data-lang-key="showTariffDetailsButton">Show Tariff Details</button>
                <button id="showReportButton" class="btn bg-gray-400 text-gray-800 hover:bg-gray-500" data-lang-key="generateReportButton">Generate Report</button>
            </div>
            
        </div>
    </div>

    <!-- Modals (outside main-container) -->
    <!-- Tariff Details Modal -->
    <div id="tariffDetailsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeTariffModal" class="modal-close-button">&times;</button>
            <h3 data-lang-key="tariffDetailsTitle">Tariff Details</h3>
            <p data-lang-key="tariffDetailsText">Below are the current tariff rates in IQD per kWh, based on the consumption category and tiered structure.</p>
            
            <!-- Dynamic content for tariffs will be generated here -->
            <div id="tariffDetailsContent"></div>
            
            <!-- Chart containers for household and other categories -->
            <div id="householdTariffChartContainer" class="chart-container hidden">
                <canvas id="householdTariffChart"></canvas>
            </div>
            <div id="otherCategoriesTariffChartContainer" class="chart-container hidden">
                <canvas id="otherCategoriesTariffChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeReportModal" class="modal-close-button">&times;</button>
            <h3 data-lang-key="reportTitle">Bill Calculation Report</h3>
            <div id="reportContent">
                <!-- Report content generated dynamically by JS -->
            </div>
        </div>
    </div>

    <!-- Floating message box -->
    <div id="appMessage" class="hidden"></div>

    <footer class="mt-8 text-center text-gray-500 text-sm">
        <p>&copy; 2024 Iraqi Electricity Bill Calculator. All rights reserved.</p>
        <p data-lang-key="disclaimerText">Disclaimer: This tool is for estimation purposes only and should not be considered a final bill.</p>
        <p data-lang-key="sourceText">Tariff rates based on Iraqi Ministry of Electricity, 2017.</p>
    </footer>

    <script>
        // Set the default language to English
        let currentLanguage = 'en';

        // Translations object
        const translations = {
            'en': {
                appTitle: 'Iraqi Electricity Bill Calculator',
                mainTitle: 'Iraqi Electricity Bill Calculator',
                manualCalculationTitle: '1. Manual Calculation',
                categoryLabel: 'Category:',
                inputLabel: 'Input:',
                kwhOption: 'kWh',
                avgAmperesOption: 'Avg Amperes',
                givenBillOption: 'Given Bill (IQD)',
                calculateBillButton: 'Calculate Bill',
                billLabel: 'Bill',
                consumptionLabel: 'Consumption',
                rateLabel: 'Avg Rate',
                costPerAmpereLabel: 'Cost/Ampere',
                meterCalculationTitle: '2. Meter Reading Calculation',
                previousReadingLabel: 'Previous Reading (kWh):',
                currentReadingLabel: 'Current Reading (kWh):',
                deviceConsumptionTitle: '3. Device Consumption',
                deviceNameHeader: 'Device Name',
                wattsHeader: 'Watts (W)',
                quantityHeader: 'Quantity',
                hoursHeader: 'Hours/Day',
                totalKwhHeader: 'Total kWh',
                totalCostHeader: 'Total Cost (IQD)',
                actionsHeader: 'Actions',
                addDeviceButton: 'Add Device',
                removeSelectedButton: 'Remove Selected',
                calculateDeviceButton: 'Calculate All',
                showTariffDetailsButton: 'Show Tariff Details',
                generateReportButton: 'Generate Report',
                tariffDetailsTitle: 'Tariff Details',
                tariffDetailsText: 'Below are the current tariff rates in IQD per kWh, based on the consumption category and tiered structure.',
                reportTitle: 'Bill Calculation Report',
                disclaimerText: 'Disclaimer: This tool is for estimation purposes only and should not be considered a final bill.',
                sourceText: 'Tariff rates based on Iraqi Ministry of Electricity, 2017.',
                householdOption: 'Household',
                commercialOption: 'Commercial',
                agricultureOption: 'Agriculture',
                industrialOption: 'Industrial',
                largeIndustryOption: 'Large Industry',
                stateOption: 'State',
                messageErrorInvalidInput: 'Error: Invalid input. Please check your values.',
                reportConsumptionPeriod: 'Consumption Period:',
                reportManualCalculation: 'Manual Calculation',
                reportMeterCalculation: 'Meter Reading Calculation',
                reportDeviceConsumption: 'Device Consumption',
                reportTotalBill: 'Total Bill:',
                reportTotalConsumption: 'Total Consumption:',
                reportTierBreakdown: 'Tier Breakdown:',
                reportTariffCategory: 'Tariff Category:',
                reportDeviceBreakdown: 'Device Breakdown:',
                reportDeviceName: 'Device Name',
                reportWatts: 'Watts',
                reportQuantity: 'Quantity',
                reportHours: 'Hours/Day',
                reportKwh: 'kWh',
                reportCost: 'Cost (IQD)'
            },
            'ar': {
                appTitle: 'حاسبة فواتير الكهرباء العراقية',
                mainTitle: 'حاسبة فواتير الكهرباء العراقية',
                manualCalculationTitle: '1. الحساب اليدوي',
                categoryLabel: 'الفئة:',
                inputLabel: 'الإدخال:',
                kwhOption: 'كيلوواط ساعة',
                avgAmperesOption: 'متوسط الأمبير',
                givenBillOption: 'الفاتورة المعطاة (د.ع)',
                calculateBillButton: 'احسب الفاتورة',
                billLabel: 'الفاتورة',
                consumptionLabel: 'الاستهلاك',
                rateLabel: 'متوسط السعر',
                costPerAmpereLabel: 'التكلفة/أمبير',
                meterCalculationTitle: '2. حساب قراءة العداد',
                previousReadingLabel: 'القراءة السابقة (كيلوواط ساعة):',
                currentReadingLabel: 'القراءة الحالية (كيلوواط ساعة):',
                deviceConsumptionTitle: '3. استهلاك الأجهزة',
                deviceNameHeader: 'اسم الجهاز',
                wattsHeader: 'الواط (واط)',
                quantityHeader: 'الكمية',
                hoursHeader: 'ساعة/يوم',
                totalKwhHeader: 'إجمالي كيلوواط ساعة',
                totalCostHeader: 'إجمالي التكلفة (د.ع)',
                actionsHeader: 'الإجراءات',
                addDeviceButton: 'أضف جهاز',
                removeSelectedButton: 'إزالة المحدد',
                calculateDeviceButton: 'احسب الكل',
                showTariffDetailsButton: 'عرض تفاصيل التعرفة',
                generateReportButton: 'إنشاء تقرير',
                tariffDetailsTitle: 'تفاصيل التعرفة',
                tariffDetailsText: 'فيما يلي أسعار التعرفة الحالية بالدينار العراقي لكل كيلوواط ساعة، بناءً على فئة الاستهلاك والتعرفة المتدرجة.',
                reportTitle: 'تقرير حساب الفاتورة',
                disclaimerText: 'إخلاء مسؤولية: هذه الأداة لأغراض التقدير فقط ولا يجب اعتبارها فاتورة نهائية.',
                sourceText: 'أسعار التعرفة مبنية على بيانات وزارة الكهرباء العراقية، 2017.',
                householdOption: 'منزلي',
                commercialOption: 'تجاري',
                agricultureOption: 'زراعي',
                industrialOption: 'صناعي',
                largeIndustryOption: 'صناعة كبيرة',
                stateOption: 'حكومي',
                messageErrorInvalidInput: 'خطأ: إدخال غير صالح. يرجى التحقق من القيم.',
                reportConsumptionPeriod: 'فترة الاستهلاك:',
                reportManualCalculation: 'الحساب اليدوي',
                reportMeterCalculation: 'حساب قراءة العداد',
                reportDeviceConsumption: 'استهلاك الأجهزة',
                reportTotalBill: 'إجمالي الفاتورة:',
                reportTotalConsumption: 'إجمالي الاستهلاك:',
                reportTierBreakdown: 'تفصيل الشرائح:',
                reportTariffCategory: 'فئة التعرفة:',
                reportDeviceBreakdown: 'تفصيل الأجهزة:',
                reportDeviceName: 'اسم الجهاز',
                reportWatts: 'واط',
                reportQuantity: 'الكمية',
                reportHours: 'ساعة/يوم',
                reportKwh: 'كيلوواط ساعة',
                reportCost: 'التكلفة (د.ع)'
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => {
             // --- UI ELEMENT SELECTION ---
            const calculateManualButton = document.getElementById('calculateManualButton');
            const calculateMeterButton = document.getElementById('calculateMeterButton');
            const calculateDeviceButton = document.getElementById('calculateDeviceButton');
            const showTariffDetailsButton = document.getElementById('showTariffDetailsButton');
            const showReportButton = document.getElementById('showReportButton');
            const addDeviceButton = document.getElementById('addDeviceButton');
            const removeSelectedButton = document.getElementById('removeSelectedButton');
            const manualInput = document.getElementById('manualInput');
            const previousReading = document.getElementById('previousReading');
            const currentReading = document.getElementById('currentReading');
            const manualBill = document.getElementById('manualBill');
            const manualKwh = document.getElementById('manualKwh');
            const manualAvgRate = document.getElementById('manualAvgRate');
            const manualCostPerAmpere = document.getElementById('manualCostPerAmpere');
            const meterBill = document.getElementById('meterBill');
            const meterKwh = document.getElementById('meterKwh');
            const meterAvgRate = document.getElementById('meterAvgRate');
            const deviceTotalBill = document.getElementById('deviceTotalBill');
            const deviceTotalKwh = document.getElementById('deviceTotalKwh');
            const deviceAvgRate = document.getElementById('deviceAvgRate');
            const deviceTableBody = document.querySelector('#deviceTable tbody');
            const manualInputTypeDropdown = document.getElementById('manualInputTypeDropdown');
            const categoryDropdown = document.getElementById('categoryDropdown');
            const deviceCategoryDropdown = document.getElementById('deviceCategoryDropdown');
            const tariffDetailsModal = document.getElementById('tariffDetailsModal');
            const closeTariffModal = document.getElementById('closeTariffModal');
            const tariffDetailsContent = document.getElementById('tariffDetailsContent');
            const householdTariffChartContainer = document.getElementById('householdTariffChartContainer');
            const otherCategoriesTariffChartContainer = document.getElementById('otherCategoriesTariffChartContainer');
            const reportModal = document.getElementById('reportModal');
            const closeReportModal = document.getElementById('closeReportModal');
            const reportContent = document.getElementById('reportContent');
            const appMessage = document.getElementById('appMessage');


            // Check for and apply saved language preference, or default to 'en'
            const savedLanguage = localStorage.getItem('language') || 'en';
            applyLanguage(savedLanguage);

            // --- TARIFF DATA ---
            // Define the tariff rates for different categories based on the provided Iraqi tariff table.
            // The rates are in IQD per kWh.
            const tariffRates = {
                "Household": [
                    { kwh: 1000, rate: 10 },
                    { kwh: 2000, rate: 20 },
                    { kwh: Infinity, rate: 40 }
                ],
                "Commercial": [
                    { kwh: 1000, rate: 25 },
                    { kwh: 2000, rate: 50 },
                    { kwh: Infinity, rate: 100 }
                ],
                "Agriculture": [
                    { kwh: 2000, rate: 10 },
                    { kwh: Infinity, rate: 20 }
                ],
                "Industrial": [
                    { kwh: 2000, rate: 25 },
                    { kwh: Infinity, rate: 50 }
                ],
                "Large Industry": [ // Assuming same rates as Industrial based on available data
                    { kwh: 2000, rate: 25 },
                    { kwh: Infinity, rate: 50 }
                ],
                "State": [
                    { kwh: Infinity, rate: 40 }
                ]
            };

            // Define the minimum monthly tariffs for each category in IQD
            const minimumTariffs = {
                "Household": 250,
                "Commercial": 500,
                "Agriculture": 500,
                "Industrial": 1000,
                "Large Industry": 1000, // Assuming same as Industrial
                "State": 1000
            };
            

            // Store device data and Chart.js instances globally
            let devices = [];
            let householdChartInstance;
            let otherCategoriesChartInstance;
            let reportData = {
                manual: {},
                meter: {},
                device: {}
            };

            // --- HELPER FUNCTIONS ---

            /**
             * Applies the selected language to the UI.
             * @param {string} langCode - The language code ('en' or 'ar').
             */
            function applyLanguage(langCode) {
                currentLanguage = langCode;
                const body = document.body;

                if (langCode === 'ar') {
                    body.classList.add('rtl');
                } else {
                    body.classList.remove('rtl');
                }

                document.querySelectorAll('[data-lang-key]').forEach(element => {
                    const key = element.dataset.langKey;
                    if (translations[langCode][key]) {
                        if (element.tagName === 'INPUT') {
                             element.placeholder = translations[langCode][key];
                        } else {
                            element.textContent = translations[langCode][key];
                        }
                    }
                });

                // Re-populate dropdowns to update options
                const categories = ["Household", "Commercial", "Agriculture", "Industrial", "Large Industry", "State"];
                const categoryDropdowns = [categoryDropdown, deviceCategoryDropdown];
                
                categoryDropdowns.forEach(dropdown => {
                    const selectedValue = dropdown.value;
                    dropdown.innerHTML = '';
                    categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = translations[langCode][`${cat.replace(/\s/g, '')}Option`] || cat;
                        dropdown.appendChild(option);
                    });
                    dropdown.value = selectedValue; // Restore previous selection
                });
            }


            /**
             * Displays a floating message box.
             * @param {string} message - The message to display.
             * @param {string} type - 'info', 'success', or 'error'.
             */
            function showMessage(message, type) {
                appMessage.textContent = message;
                appMessage.className = `show ${type}`;
                setTimeout(() => {
                    appMessage.className = appMessage.className.replace('show', '');
                }, 3000);
            }

            /**
             * Calculates the total bill based on consumption and a tiered tariff system.
             * @param {number} consumption - The total kWh consumption.
             * @param {string} category - The tariff category (e.g., "Household").
             * @returns {{totalBill: number, tariffBreakdown: Array<Object>}} - The calculated bill and a breakdown of costs.
             */
            function calculateBill(consumption, category) {
                const tariffBreakdown = [];
                let totalBill = 0;
                let remainingConsumption = consumption;
                let previousTierKwh = 0;

                if (!tariffRates[category]) {
                    console.error("Invalid category provided for bill calculation.");
                    return { totalBill: 0, tariffBreakdown: [] };
                }

                tariffRates[category].forEach((tier, index) => {
                    if (remainingConsumption > 0) {
                        // Calculate the consumption within the current tier
                        const blockUpperKwh = tier.kwh;
                        const consumptionInBlock = Math.min(blockUpperKwh - previousTierKwh, remainingConsumption);

                        if (consumptionInBlock > 0) {
                            const blockCost = consumptionInBlock * tier.rate;
                            totalBill += blockCost;
                            remainingConsumption -= consumptionInBlock;

                            tariffBreakdown.push({
                                label: `Tier ${index + 1} (${previousTierKwh + 1}-${tier.kwh === Infinity ? '...' : tier.kwh} kWh)`,
                                consumption: consumptionInBlock,
                                rate: tier.rate,
                                cost: blockCost
                            });
                        }
                    }
                    previousTierKwh = tier.kwh;
                });

                // Add minimum charge if applicable
                const minimumCharge = minimumTariffs[category] || 0;
                if (totalBill < minimumCharge) {
                    totalBill = minimumCharge;
                    // Note: No breakdown for minimum charge as it replaces the whole bill.
                    tariffBreakdown.length = 0; // Clear breakdown if minimum charge is applied
                    tariffBreakdown.push({
                        label: 'Minimum Charge',
                        consumption: 0,
                        rate: 'N/A',
                        cost: minimumCharge
                    });
                }

                return { totalBill, tariffBreakdown };
            }

            /**
             * Calculates the average amperes from total kWh consumption over a month.
             * @param {number} kwh - Total kWh consumption.
             * @returns {number} - Average amperes.
             */
            function calculateAvgAmperes(kwh) {
                const hoursInMonth = 24 * 30;
                const watts = (kwh * 1000) / hoursInMonth;
                const volts = 220; // Assuming 220V standard
                return watts / volts;
            }

            /**
             * Performs the manual calculation based on user input.
             */
            function performManualCalculation() {
                const inputValue = parseFloat(manualInput.value);
                const inputType = manualInputTypeDropdown.value;
                const category = categoryDropdown.value;

                if (isNaN(inputValue) || inputValue < 0) {
                    showMessage(translations[currentLanguage]['messageErrorInvalidInput'], 'error');
                    return;
                }

                let kwh;
                let bill;
                let avgRate;
                let costPerAmpere;

                if (inputType === 'kWh') {
                    kwh = inputValue;
                    const result = calculateBill(kwh, category);
                    bill = result.totalBill;
                } else if (inputType === 'Avg Amperes') {
                    const avgAmperes = inputValue;
                    const hoursInMonth = 24 * 30;
                    const volts = 220;
                    kwh = (avgAmperes * volts * hoursInMonth) / 1000;
                    const result = calculateBill(kwh, category);
                    bill = result.totalBill;
                } else if (inputType === 'Given Bill') {
                    bill = inputValue;
                    // This is an inverse calculation, which is complex for tiered tariffs.
                    // A simple approximation is used here for demonstration.
                    const approxAvgRate = 35; // A reasonable approximation for average rate
                    kwh = bill / approxAvgRate;
                }

                // Update UI with results
                manualBill.textContent = `${bill.toFixed(2)} IQD`;
                manualKwh.textContent = `${kwh.toFixed(2)} kWh`;
                avgRate = kwh > 0 ? bill / kwh : 0;
                manualAvgRate.textContent = `${avgRate.toFixed(2)} IQD/kWh`;
                costPerAmpere = calculateAvgAmperes(kwh) > 0 ? bill / calculateAvgAmperes(kwh) : 0;
                manualCostPerAmpere.textContent = `${costPerAmpere.toFixed(2)} IQD/A`;

                // Add flash animation
                [manualBill, manualKwh, manualAvgRate, manualCostPerAmpere].forEach(element => {
                    element.classList.add('flash-animation');
                    element.style.setProperty('--current-result-color', 'var(--manual-result-color)');
                    element.style.setProperty('--current-highlight-color', 'var(--manual-highlight-color)');
                    setTimeout(() => {
                        element.classList.remove('flash-animation');
                    }, 1800);
                });

                // Save data for report
                reportData.manual = { kwh, bill, category };
            }

            /**
             * Performs the calculation based on meter readings.
             */
            function performMeterCalculation() {
                const prev = parseFloat(previousReading.value);
                const curr = parseFloat(currentReading.value);
                const category = categoryDropdown.value;

                if (isNaN(prev) || isNaN(curr) || curr < prev) {
                    showMessage(translations[currentLanguage]['messageErrorInvalidInput'], 'error');
                    return;
                }

                const kwh = curr - prev;
                const result = calculateBill(kwh, category);
                const bill = result.totalBill;
                const avgRate = kwh > 0 ? bill / kwh : 0;

                // Update UI with results
                meterBill.textContent = `${bill.toFixed(2)} IQD`;
                meterKwh.textContent = `${kwh.toFixed(2)} kWh`;
                meterAvgRate.textContent = `${avgRate.toFixed(2)} IQD/kWh`;
                
                // Add flash animation
                [meterBill, meterKwh, meterAvgRate].forEach(element => {
                    element.classList.add('flash-animation');
                    element.style.setProperty('--current-result-color', 'var(--meter-result-color)');
                    element.style.setProperty('--current-highlight-color', 'var(--meter-highlight-color)');
                    setTimeout(() => {
                        element.classList.remove('flash-animation');
                    }, 1800);
                });

                // Save data for report
                reportData.meter = { kwh, bill, category };
            }

            /**
             * Calculates the device consumption and updates the table and summary.
             */
            function calculateDeviceConsumption() {
                const category = deviceCategoryDropdown.value;
                let totalKwh = 0;

                // Iterate through each device row to get values and calculate total kWh
                deviceTableBody.querySelectorAll('tr').forEach(row => {
                    const wattsInput = row.querySelector('.watts-input');
                    const quantityInput = row.querySelector('.quantity-input');
                    const hoursInput = row.querySelector('.hours-input');
                    const totalKwhCell = row.querySelector('.total-kwh-cell');
                    const totalCostCell = row.querySelector('.total-cost-cell');

                    const watts = parseFloat(wattsInput.value) || 0;
                    const quantity = parseInt(quantityInput.value) || 0;
                    const hours = parseFloat(hoursInput.value) || 0;

                    const deviceKwh = (watts * quantity * hours * 30) / 1000;
                    totalKwh += deviceKwh;

                    totalKwhCell.textContent = deviceKwh.toFixed(2);
                });

                const result = calculateBill(totalKwh, category);
                const totalBill = result.totalBill;
                const avgRate = totalKwh > 0 ? totalBill / totalKwh : 0;

                // Update the total cost for each device based on the average rate
                deviceTableBody.querySelectorAll('tr').forEach(row => {
                    const totalKwhCell = row.querySelector('.total-kwh-cell');
                    const totalCostCell = row.querySelector('.total-cost-cell');
                    const deviceKwh = parseFloat(totalKwhCell.textContent) || 0;
                    const deviceCost = deviceKwh * avgRate;
                    totalCostCell.textContent = deviceCost.toFixed(2);
                });

                // Update UI for device totals
                deviceTotalBill.textContent = `${totalBill.toFixed(2)} IQD`;
                deviceTotalKwh.textContent = `${totalKwh.toFixed(2)} kWh`;
                deviceAvgRate.textContent = `${avgRate.toFixed(2)} IQD/kWh`;

                // Add flash animation
                [deviceTotalBill, deviceTotalKwh, deviceAvgRate].forEach(element => {
                    element.classList.add('flash-animation');
                    element.style.setProperty('--current-result-color', 'var(--device-result-color)');
                    element.style.setProperty('--current-highlight-color', 'var(--device-highlight-color)');
                    setTimeout(() => {
                        element.classList.remove('flash-animation');
                    }, 1800);
                });

                // Update devices array for the report
                devices = Array.from(deviceTableBody.querySelectorAll('tr')).map(row => {
                    return {
                        name: row.querySelector('.name-input').value,
                        watts: parseFloat(row.querySelector('.watts-input').value),
                        quantity: parseInt(row.querySelector('.quantity-input').value),
                        hours: parseFloat(row.querySelector('.hours-input').value),
                        kwh: parseFloat(row.querySelector('.total-kwh-cell').textContent),
                        cost: parseFloat(row.querySelector('.total-cost-cell').textContent),
                    };
                });
                reportData.device = { kwh: totalKwh, bill: totalBill, category, breakdown: devices };
            }

            /**
             * Adds a new device row to the table.
             */
            function addDeviceRow() {
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td class="px-2 py-1">
                        <input type="text" class="name-input w-full p-2 rounded-md bg-gray-700 text-white" placeholder="Device Name">
                    </td>
                    <td class="px-2 py-1">
                        <input type="number" value="100" class="watts-input w-full p-2 rounded-md bg-gray-700 text-white" min="0">
                    </td>
                    <td class="px-2 py-1">
                        <input type="number" value="1" class="quantity-input w-full p-2 rounded-md bg-gray-700 text-white" min="1">
                    </td>
                    <td class="px-2 py-1">
                        <input type="number" value="8" class="hours-input w-full p-2 rounded-md bg-gray-700 text-white" min="0" max="24">
                    </td>
                    <td class="output-cell total-kwh-cell">0.00</td>
                    <td class="output-cell total-cost-cell">0.00</td>
                    <td class="px-2 py-1">
                        <input type="checkbox" class="remove-checkbox">
                    </td>
                `;
                deviceTableBody.appendChild(newRow);

                // Add event listeners to the new inputs
                const inputs = newRow.querySelectorAll('input');
                inputs.forEach(input => {
                    input.addEventListener('input', calculateDeviceConsumption);
                });
            }

            /**
             * Populates the device table with a few initial rows.
             */
            function startupPopulateDeviceTable() {
                // Clear existing rows
                deviceTableBody.innerHTML = '';
                // Add some default rows
                addDeviceRow();
                addDeviceRow();
                addDeviceRow();
            }
            
            /**
             * Generates and displays the report in the modal.
             */
            function generateReport() {
                reportContent.innerHTML = ''; // Clear previous report

                // Manual Calculation Report
                if (Object.keys(reportData.manual).length > 0) {
                    const manualDiv = document.createElement('div');
                    manualDiv.innerHTML = `
                        <h4 class="report-section-title">${translations[currentLanguage]['reportManualCalculation']}</h4>
                        <div class="space-y-1">
                            <div><span class="report-item-label">${translations[currentLanguage]['reportTariffCategory']}</span><span class="report-item-value">${reportData.manual.category}</span></div>
                            <div><span class="report-item-label">${translations[currentLanguage]['reportTotalConsumption']}</span><span class="report-item-value">${reportData.manual.kwh.toFixed(2)} kWh</span></div>
                            <div><span class="report-item-label">${translations[currentLanguage]['reportTotalBill']}</span><span class="report-item-value">${reportData.manual.bill.toFixed(2)} IQD</span></div>
                        </div>
                    `;
                    reportContent.appendChild(manualDiv);
                }

                // Meter Calculation Report
                if (Object.keys(reportData.meter).length > 0) {
                    const meterDiv = document.createElement('div');
                    meterDiv.innerHTML = `
                        <h4 class="report-section-title">${translations[currentLanguage]['reportMeterCalculation']}</h4>
                        <div class="space-y-1">
                            <div><span class="report-item-label">${translations[currentLanguage]['reportTariffCategory']}</span><span class="report-item-value">${reportData.meter.category}</span></div>
                            <div><span class="report-item-label">${translations[currentLanguage]['reportTotalConsumption']}</span><span class="report-item-value">${reportData.meter.kwh.toFixed(2)} kWh</span></div>
                            <div><span class="report-item-label">${translations[currentLanguage]['reportTotalBill']}</span><span class="report-item-value">${reportData.meter.bill.toFixed(2)} IQD</span></div>
                        </div>
                    `;
                    reportContent.appendChild(meterDiv);
                }

                // Device Consumption Report
                if (Object.keys(reportData.device).length > 0 && reportData.device.breakdown.length > 0) {
                    const deviceDiv = document.createElement('div');
                    let deviceTableHtml = `
                        <h4 class="report-section-title">${translations[currentLanguage]['reportDeviceConsumption']}</h4>
                        <div class="space-y-1">
                            <div><span class="report-item-label">${translations[currentLanguage]['reportTariffCategory']}</span><span class="report-item-value">${reportData.device.category}</span></div>
                            <div><span class="report-item-label">${translations[currentLanguage]['reportTotalConsumption']}</span><span class="report-item-value">${reportData.device.kwh.toFixed(2)} kWh</span></div>
                            <div><span class="report-item-label">${translations[currentLanguage]['reportTotalBill']}</span><span class="report-item-value">${reportData.device.bill.toFixed(2)} IQD</span></div>
                        </div>
                        <h5 class="font-bold text-lg mt-4 mb-2">${translations[currentLanguage]['reportDeviceBreakdown']}</h5>
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th>${translations[currentLanguage]['reportDeviceName']}</th>
                                    <th>${translations[currentLanguage]['reportWatts']}</th>
                                    <th>${translations[currentLanguage]['reportQuantity']}</th>
                                    <th>${translations[currentLanguage]['reportHours']}</th>
                                    <th>${translations[currentLanguage]['reportKwh']}</th>
                                    <th>${translations[currentLanguage]['reportCost']}</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    reportData.device.breakdown.forEach(device => {
                        deviceTableHtml += `
                            <tr>
                                <td>${device.name || 'N/A'}</td>
                                <td>${device.watts}</td>
                                <td>${device.quantity}</td>
                                <td>${device.hours}</td>
                                <td>${device.kwh.toFixed(2)}</td>
                                <td>${device.cost.toFixed(2)}</td>
                            </tr>
                        `;
                    });

                    deviceTableHtml += `
                            </tbody>
                        </table>
                    `;
                    deviceDiv.innerHTML = deviceTableHtml;
                    reportContent.appendChild(deviceDiv);
                }

                if (reportContent.innerHTML === '') {
                    reportContent.innerHTML = `<p>${translations[currentLanguage]['noReportData'] || 'No report data available. Please run a calculation first.'}</p>`;
                }
            }

            /**
             * Generates a canvas chart for a given tariff category.
             * @param {string} chartId - The ID of the canvas element.
             * @param {string} category - The tariff category.
             * @returns {Chart} - The Chart.js instance.
             */
            function generateTariffChart(chartId, category) {
                const ctx = document.getElementById(chartId).getContext('2d');
                const tiers = tariffRates[category];
                const labels = [];
                const data = [];
                const backgroundColors = [];
                
                let previousKwh = 0;
                const colors = ['#facc15', '#fbbf24', '#f97316', '#ef4444']; // Yellow, Orange, Red, Dark Red

                tiers.forEach((tier, index) => {
                    const tierLabel = tier.kwh === Infinity ? `> ${previousKwh} kWh` : `${previousKwh + 1}-${tier.kwh} kWh`;
                    labels.push(tierLabel);
                    data.push(tier.rate);
                    backgroundColors.push(colors[index % colors.length]);
                    previousKwh = tier.kwh;
                });

                const chartData = {
                    labels: labels,
                    datasets: [{
                        label: `Tariff Rate (${category})`,
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: 'rgba(255, 255, 255, 0.8)',
                        borderWidth: 1,
                    }]
                };

                const chartOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Rate: ${context.parsed.y} IQD/kWh`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Consumption Tier',
                                color: 'var(--text-light)',
                            },
                            ticks: {
                                color: 'var(--text-medium-light)',
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Rate (IQD/kWh)',
                                color: 'var(--text-light)',
                            },
                            ticks: {
                                color: 'var(--text-medium-light)',
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)',
                            }
                        }
                    }
                };

                return new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: chartOptions,
                });
            }


            // --- EVENT LISTENERS ---
            
            // Manual calculation event listeners
            calculateManualButton.addEventListener('click', performManualCalculation);
            manualInput.addEventListener('input', performManualCalculation);
            manualInputTypeDropdown.addEventListener('change', performManualCalculation);
            categoryDropdown.addEventListener('change', () => {
                // Also update the device category dropdown to keep them in sync
                deviceCategoryDropdown.value = categoryDropdown.value;
                performManualCalculation();
            });

            // Meter calculation event listeners
            calculateMeterButton.addEventListener('click', performMeterCalculation);
            previousReading.addEventListener('input', performMeterCalculation);
            currentReading.addEventListener('input', performMeterCalculation);

            // Device consumption event listeners
            addDeviceButton.addEventListener('click', () => {
                addDeviceRow();
                calculateDeviceConsumption();
            });
            removeSelectedButton.addEventListener('click', () => {
                const rowsToRemove = Array.from(deviceTableBody.querySelectorAll('.remove-checkbox:checked'));
                rowsToRemove.forEach(checkbox => {
                    checkbox.closest('tr').remove();
                });
                calculateDeviceConsumption();
            });
            calculateDeviceButton.addEventListener('click', calculateDeviceConsumption);
            deviceCategoryDropdown.addEventListener('change', () => {
                // Also update the manual category dropdown to keep them in sync
                categoryDropdown.value = deviceCategoryDropdown.value;
                calculateDeviceConsumption();
            });

            // Tariff details modal
            showTariffDetailsButton.addEventListener('click', () => {
                const category = categoryDropdown.value;
                tariffDetailsContent.innerHTML = '';
                
                // Show tariff details in a preformatted block
                const pre = document.createElement('pre');
                pre.classList.add('p-4', 'bg-gray-800', 'rounded-md', 'text-gray-300', 'whitespace-pre-wrap');
                
                let tariffText = `Category: ${category}\n\n`;
                const tiers = tariffRates[category];
                
                let previousKwh = 0;
                tiers.forEach(tier => {
                    const blockEnd = tier.kwh === Infinity ? '...' : tier.kwh;
                    tariffText += `  - ${previousKwh + 1}-${blockEnd} kWh: ${tier.rate} IQD/kWh\n`;
                    previousKwh = tier.kwh;
                });
                
                tariffText += `\nMinimum Monthly Charge: ${minimumTariffs[category] || 0} IQD`;
                
                pre.textContent = tariffText;
                tariffDetailsContent.appendChild(pre);

                // Destroy old chart instances if they exist
                if (householdChartInstance) householdChartInstance.destroy();
                if (otherCategoriesChartInstance) otherCategoriesChartInstance.destroy();

                // Show the appropriate chart container
                if (category === 'Household') {
                    householdTariffChartContainer.style.display = 'block';
                    otherCategoriesTariffChartContainer.style.display = 'none';
                    householdChartInstance = generateTariffChart('householdTariffChart', category);
                } else {
                    householdTariffChartContainer.style.display = 'none';
                    otherCategoriesTariffChartContainer.style.display = 'block';
                    otherCategoriesChartInstance = generateTariffChart('otherCategoriesTariffChart', category);
                }

                tariffDetailsModal.style.display = 'flex';
            });
            
            // Report modal
            showReportButton.addEventListener('click', () => {
                generateReport();
                reportModal.style.display = 'flex';
            });

            // Close modals
            closeTariffModal.addEventListener('click', () => {
                tariffDetailsModal.style.display = 'none'; // Hide the modal
                householdTariffChartContainer.style.display = 'none'; // Hide chart containers
                otherCategoriesTariffChartContainer.style.display = 'none';
            });

            // Close modal if clicked outside content
            tariffDetailsModal.addEventListener('click', (e) => {
                if (e.target === tariffDetailsModal) {
                    tariffDetailsModal.style.display = 'none';
                    householdTariffChartContainer.style.display = 'none'; // Hide chart containers
                    otherCategoriesTariffChartContainer.style.display = 'none';
                }
            });

            closeReportModal.addEventListener('click', () => {
                reportModal.style.display = 'none';
            });

            reportModal.addEventListener('click', (e) => {
                if (e.target === reportModal) {
                    reportModal.style.display = 'none';
                }
            });


            // --- INITIALIZATION CALLS ---
            startupPopulateDeviceTable(); // Populate table on load
            calculateDeviceConsumption(); // Calculate initial device consumption
            performManualCalculation(); // Perform initial manual calculation
            performMeterCalculation(); // Perform initial meter calculation
        });
    </script>
</body>
</html>
