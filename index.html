<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="appTitle">Runaki Bill Assistant</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for plotting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
    <style>
        /* Define a custom color palette using CSS variables for consistency */
        :root {
            --primary-blue: #3b82f6; /* A clean, vibrant blue */
            --secondary-green: #22c55e; /* A fresh green */
            --accent-orange: #f97316; /* A warm orange */
            --accent-purple: #8b5cf6; /* A soft purple */
            --neutral-gray-dark: #374151; /* Dark gray for text */
            --neutral-gray-medium: #6b7280; /* Medium gray for labels */
            --neutral-gray-light: #e5e7eb; /* Light gray for borders/backgrounds */
            --background-light: #f9fafb; /* Very light background */
            --card-background: #ffffff; /* White for cards */
            --highlight-yellow: #facc15; /* Yellow for highlights */
            --error-red: #ef4444; /* Standard error red */

            /* New light gray button colors */
            --button-light-gray: #e0e0e0;
            --button-hover-gray: #d1d1d1;
            --button-active-gray: #c0c0c0;
            --button-dark-text: #333f48;

            /* Night mode specific colors */
            --background-dark: #1a202c; /* Deep dark background */
            --card-dark: #2d3748; /* Slightly lighter dark for cards */
            --text-light: #e2e8f0; /* Light gray for main text */
            --text-medium-light: #a0aec0; /* Medium light gray for labels */
            --input-dark-bg: #4a5568; /* Darker input background */
            --input-dark-border: #6b7280; /* Darker input border */
            --result-item-dark-bg: #3c4a5c; /* Darker result item background */
            --result-item-dark-border: #5a6a7c; /* Darker result item border */
            --primary-blue-darker: #2563eb; /* A slightly darker blue for accents on dark background */
            --highlight-yellow-dark: #fbbf24; /* Brighter yellow for dark background */
            
            /* Dynamic colors for result displays */
            --manual-result-color: #fef08a; /* Light yellow */
            --manual-highlight-color: #fbbf24; /* Brighter yellow */
            --meter-result-color: #bbf7d0; /* Light green */
            --meter-highlight-color: #86efac; /* Brighter green */
            --device-result-color: #a7f3d0; /* Light teal/cyan */
            --device-highlight-color: #5eead4; /* Brighter teal/cyan */
            --optimization-result-color: #bfdbfe; /* Light blue */
            --optimization-highlight-color: #93c5fd; /* Brighter blue */
        }

        /* Custom styles for better aesthetics and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-dark); /* Night mode background */
            margin: 0;
            padding: 2rem; /* Increased padding */
            color: var(--text-light); /* Night mode text color */
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: pan-x pan-y;
        }

        /* RTL specific styles */
        body.rtl {
            direction: rtl;
        }
        body.rtl h1,
        body.rtl h2,
        body.rtl .section-card,
        body.rtl footer {
            text-align: right;
        }
        body.rtl .text-left {
            text-align: right;
        }
        body.rtl .items-start {
            align-items: flex-end;
        }
        body.rtl .modal-close-button {
            right: unset;
            left: 1rem;
        }
        
        /* Language selector styling */
        .lang-btn {
            transition: background-color 0.2s, border-color 0.2s;
            border: 2px solid transparent;
            width: 3rem;
            height: 3rem;
            font-weight: bold;
        }
        .lang-btn.active {
            border-color: var(--primary-blue);
            background-color: var(--input-dark-bg);
            color: white;
        }
        .lang-btn:not(.active) {
            background-color: var(--card-dark);
            color: var(--text-medium-light);
        }


        h1 {
            color: white; /* Changed to white as requested */
            font-weight: 800;
            margin-bottom: 1.5rem; /* Reduced margin */
            text-align: center;
            font-size: 2.75rem; /* Slightly larger font size */
            letter-spacing: -0.025em; /* Tighten letter spacing slightly */
        }

        h2 {
            color: var(--text-light); /* Night mode heading color */
            font-weight: 700;
            margin-bottom: 1.25rem; /* Increased margin */
            font-size: 1.6rem; /* Slightly larger for section titles */
        }

        .main-container {
            display: flex;
            flex-direction: column; /* Always column layout */
            gap: 2.5rem; /* Increased gap */
            width: 100%;
            max-width: 45rem; /* Adjusted max-width for single column */
            background-color: var(--card-dark); /* Night mode card background */
            padding: 2.5rem; /* Increased padding */
            border-radius: 1.25rem; /* More rounded corners */
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.25); /* Stronger, diffused shadow for dark mode */
        }

        .section-card {
            background-color: var(--card-dark); /* Night mode card background */
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 1rem; /* More rounded corners */
            padding: 2rem; /* Increased padding */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08); /* Softer shadow */
        }

        .input-group {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1.25rem; /* Increased gap */
            margin-bottom: 1.75rem; /* Increased margin */
        }

        label {
            font-weight: 600;
            color: var(--text-medium-light); /* Night mode label color */
            flex-shrink: 0; /* Prevent label from shrinking */
        }

        input[type="text"],
        input[type="number"],
        select {
            padding: 0.75rem 1rem; /* More padding */
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 0.6rem; /* More rounded corners */
            font-size: 1rem; /* Slightly larger font */
            text-align: center;
            background-color: var(--input-dark-bg); /* Night mode input background */
            color: var(--text-light); /* Night mode input text color */
            flex-grow: 1;
            min-width: 8rem; /* Slightly larger min-width */
            transition: all 0.2s ease-in-out;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Subtle inner shadow */
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            border-color: var(--primary-blue-darker); /* Night mode focus border */
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4); /* Soft blue glow on focus for night mode */
            outline: none;
        }

        /* General button styling */
        button {
            padding: 0.75rem 1.5rem; /* More padding */
            border-radius: 0.6rem; /* More rounded corners */
            border: none; /* Removed border */
            font-size: 1rem; /* Slightly larger font */
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* Stronger button shadow */
            white-space: nowrap;
            color: var(--button-dark-text); /* Dark text for light grey button */
            margin: 0.5rem; /* Increased margin for spacing between buttons */
            background-color: var(--button-light-gray); /* Light grey background */
        }

        button.btn-action {
            color: var(--highlight-yellow-dark);
        }

        button:hover {
            transform: translateY(-3px); /* More pronounced lift */
            box-shadow: 0 8px 16px rgba(0,0,0,0.2); /* Stronger hover shadow */
            opacity: 0.95;
            background-color: var(--button-hover-gray); /* Slightly darker grey on hover */
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: var(--button-active-gray); /* Keep background light grey when active */
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(8rem, 1fr)); /* Adjusted min-width for results */
            gap: 1rem; /* Increased gap */
            font-size: 1rem;
            margin-top: 1rem; /* Added margin-top */
            max-width: 40rem; /* Max width for the grid itself */
            margin-left: auto; /* Center the grid */
            margin-right: auto; /* Center the grid */
        }

        .result-item {
            background-color: var(--result-item-dark-bg); /* Night mode result item background */
            border: 1px solid var(--result-item-dark-border); /* Night mode result item border */
            border-radius: 0.75rem;
            padding: 1.2rem; /* More padding */
            text-align: center;
            box-shadow: inset 0 1px 4px rgba(0,0,0,0.07); /* Inner shadow for depth */
        }

        .result-label {
            color: var(--text-medium-light); /* Night mode result label color */
            margin-bottom: 0.4rem;
            font-weight: 500;
        }

        .result-value {
            font-weight: 800;
            /* Use dynamic CSS variables for color */
            color: var(--current-result-color); 
            font-size: 1.25rem; /* Larger font for values */
            transition: color 0.2s ease-in-out; /* Smooth transition for color flash */
        }

        /* Flashing animation for result values */
        @keyframes flashEffect {
            0% { color: var(--current-result-color); } /* Start with dynamic color */
            16.6% { color: var(--current-highlight-color); } /* Flash brighter dynamic color */
            33.3% { color: var(--current-result-color); } /* Back to dynamic color */
            50% { color: var(--current-highlight-color); } /* Flash brighter dynamic color again */
            66.6% { color: var(--current-result-color); } /* Back to dynamic color */
            83.3% { color: var(--current-highlight-color); } /* Flash brighter dynamic color one last time */
            100% { color: var(--current-result-color); } /* End with dynamic color */
        }

        .flash-animation {
            animation: flashEffect 1.8s ease-out; /* 3 flashes over 1.8 seconds */
        }

        /* Chart container styling */
        .chart-container {
            width: 100%;
            height: 300px; /* Fixed height for chart */
            margin-top: 2rem; 
            background-color: var(--card-dark); 
            border-radius: 1rem;
            padding: 1.5rem; 
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
        }

        /* Device Table Styling */
        .device-table-container {
            overflow-x: auto;
            max-height: 500px; /* Slightly taller table */
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 1rem;
            margin-bottom: 2rem; /* Increased margin */
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2); /* Stronger shadow for dark mode */
        }

        .device-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Ensure table doesn't get too narrow on small screens */
        }

        .device-table th, .device-table td {
            padding: 1rem 0.8rem; /* More padding */
            text-align: center;
            border-bottom: 1px solid var(--input-dark-border); /* Night mode border */
            font-size: 0.95rem; /* Slightly larger font */
        }

        .device-table th {
            background-color: var(--input-dark-bg); /* Night mode header background */
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            color: var(--text-light); /* Night mode header text */
        }

        .device-table tbody tr:hover {
            background-color: #3a475c; /* Darker hover effect for table rows */
        }

        .device-table tbody tr.selected-row {
            background-color: #3b82f640; /* Light blue highlight on dark background */
            box-shadow: inset 0 0 0 3px var(--primary-blue-darker); /* Blue border on selected row */
        }

        .device-table input[type="text"],
        .device-table input[type="number"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--input-dark-border); /* Night mode border */
            border-radius: 0.4rem;
            text-align: center;
            font-size: 0.9rem;
            background-color: var(--input-dark-bg); /* Night mode input background */
            color: var(--text-light); /* Night mode input text */
        }

        .device-table input[type="checkbox"] {
            width: 1.2rem; /* Slightly larger checkbox */
            height: 1.2rem;
            cursor: pointer;
            border-radius: 0.3rem;
            accent-color: var(--primary-blue-darker); /* Night mode checkbox accent */
        }

        .device-table .output-cell {
            background-color: #2a3a4c; /* Darker blue for output values */
            font-weight: 600;
            color: var(--primary-blue-darker); /* A subtle blue for output values */
        }

        /* Responsive adjustments for table inputs */
        @media (max-width: 768px) {
            .device-table input[type="text"],
            .device-table input[type="number"] {
                width: 100%;
            }
        }

        /* Custom Modal for Tariff Details */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--card-dark); /* Night mode modal background */
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            color: var(--text-light); /* Night mode modal text */
            position: relative;
        }

        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light); /* Night mode close button color */
            cursor: pointer;
        }
        .modal-close-button:hover {
            color: var(--primary-blue-darker); /* Night mode close button hover */
        }

        .modal-content h3 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-blue-darker); /* Night mode modal heading color */
            margin-bottom: 1rem;
        }

        .modal-content pre {
            background-color: #1a202c; /* Deeper dark for code/preformatted text */
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-family: 'Cascadia Code', 'Fira Code', monospace;
            font-size: 0.9rem;
            color: #a0aec0; /* Lighter text for code */
        }

        /* Footer */
        footer {
            color: var(--text-medium-light); /* Night mode footer text */
            margin-top: 8rem; /* Increased margin-top for footer */
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        /* Message Box Styling */
        #appMessage {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1100;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            color: white; /* Default text color for messages */
        }

        #appMessage.show {
            opacity: 1;
            transform: translateY(0);
        }

        #appMessage.info { background-color: #3b82f6; } /* Blue for info */
        #appMessage.success { background-color: #22c55e; } /* Green for success */
        #appMessage.error { background-color: #ef4444; } /* Red for error */

        /* Report Modal Specific Styles */
        .report-section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-blue-darker);
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            border-bottom: 2px solid var(--primary-blue-darker);
            padding-bottom: 0.5rem;
        }

        .report-item-label {
            font-weight: 600;
            color: var(--text-medium-light);
            margin-right: 0.5rem;
        }

        .report-item-value {
            font-weight: 700;
            color: var(--text-light);
        }

        .report-breakdown-item {
            margin-left: 1rem;
            font-size: 0.95rem;
            color: var(--text-medium-light);
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background-color: var(--input-dark-bg);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .report-table th, .report-table td {
            padding: 0.75rem;
            border: 1px solid var(--input-dark-border);
            text-align: left;
            color: var(--text-light);
        }

        .report-table th {
            background-color: var(--primary-blue-darker);
            color: white;
            font-weight: 700;
        }

        .report-table tbody tr:nth-child(even) {
            background-color: #3a475c; /* Slightly different background for even rows */
        }
    </style>
</head>
<body>

    <h1 class="text-3xl lg:text-4xl" data-lang-key="mainTitle">Runaki Bill Assistant</h1>

    <div id="languageSelectorTop" class="mb-6 flex justify-center gap-2">
        <button id="lang-en" class="lang-btn">EN</button>
        <button id="lang-ar" class="lang-btn">AR</button>
        <button id="lang-ku" class="lang-btn">KU</button>
    </div>

    <div class="main-container">
        <!-- Main content now in a single column -->
        <div class="flex flex-col w-full space-y-8">

            <!-- 1. Manual Calculation -->
            <div class="section-card" id="manualCalculationSection">
                <h2 class="text-xl" data-lang-key="manualCalculationTitle">1. Manual Calculation</h2>
                <div class="input-group">
                    <label for="categoryDropdown" data-lang-key="categoryLabel">Category:</label>
                    <select id="categoryDropdown" class="p-2 border rounded-md">
                        <option value="Household" data-lang-key="householdOption">Household</option>
                        <option value="Commercial" data-lang-key="commercialOption">Commercial</option>
                        <option value="Agriculture" data-lang-key="agricultureOption">Agriculture</option>
                        <option value="Industrial" data-lang-key="industrialOption">Industrial</option>
                        <option value="Government" data-lang-key="governmentOption">Government</option>
                    </select>
                    <label for="manualInputTypeDropdown" data-lang-key="inputLabel">Input:</label>
                    <select id="manualInputTypeDropdown" class="p-2 border rounded-md">
                        <option value="kWh" data-lang-key="kwhOption">kWh</option>
                        <option value="Avg Amperes" data-lang-key="avgAmperesOption">Avg Amperes</option>
                        <option value="Given Bill" data-lang-key="givenBillOption">Given Bill (IQD)</option>
                    </select>
                    <input type="number" id="manualInput" value="1891" class="w-28">
                </div>
                <button id="calculateManualButton" class="btn btn-action w-full" data-lang-key="calculateBillButton">Calculate Bill</button>
                <div class="result-grid" id="manualResultGrid">
                    <div class="result-item">
                        <div class="result-label" data-lang-key="billLabel">Bill</div>
                        <div class="result-value" id="manualBill">0 IQD</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="consumptionLabel">Consumption</div>
                        <div class="result-value" id="manualKwh">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="avgAmperesLabel">Avg Amperes</div>
                        <div class="result-value" id="manualAmperes">0.00 A</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="avgRateLabel">Avg Rate</div>
                        <div class="result-value" id="manualAvgRate">0.00 IQD/kWh</div>
                    </div>
                </div>
                <button id="manualReportButton" class="btn btn-action w-full mt-6" data-lang-key="generateReportButton">Generate Report</button>
            </div>

            <!-- 2. By Meter Calculation -->
            <div class="section-card" id="meterCalculationSection" style="display: none;">
                <h2 class="text-xl" data-lang-key="meterCalculationTitle">2. By Meter Calculation</h2>
                <div class="input-group">
                    <label for="meterPrevReading" data-lang-key="prevReadingLabel">Prev Reading:</label>
                    <input type="number" id="meterPrevReading" value="31051" class="w-24">
                    <label for="meterCurrReading" data-lang-key="currReadingLabel">Curr Reading:</label>
                    <input type="number" id="meterCurrReading" value="31910" class="w-24">
                    <label for="daysInput" data-lang-key="daysLabel">Days:</label>
                    <input type="number" id="daysInput" value="30" min="1" max="365" class="w-16">
                </div>
                <button id="calculateMeterButton" class="btn btn-action w-full" data-lang-key="calculateBillButton">Calculate Bill</button>
                <div class="result-grid" id="meterResultGrid">
                    <div class="result-item">
                        <div class="result-label" data-lang-key="billLabel">Bill</div>
                        <div class="result-value" id="meterBill">0 IQD</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="consumptionLabel">Consumption</div>
                        <div class="result-value" id="meterKwh">0.00 kWh</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="avgAmperesLabel">Avg Amperes</div>
                        <div class="result-value" id="meterAmperes">0.00 A</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label" data-lang-key="avgRateLabel">Avg Rate</div>
                        <div class="result-value" id="meterAvgRate">0.00 IQD/kWh</div>
                    </div>
                </div>
                <button id="meterReportButton" class="btn btn-action w-full mt-6" data-lang-key="generateReportButton">Generate Report</button>
            </div>
            
            <!-- New buttons for showing/hiding sections -->
            <div class="flex flex-col items-start gap-2 mt-6 p-4 border border-gray-700 rounded-lg max-w-lg ml-0 mr-auto">
                <button id="toggleManualCalculationButton" class="btn w-full text-left" data-lang-key="hideManualCalculation">Hide Manual Calculation</button>
                <button id="toggleMeterCalculationButton" class="btn w-full text-left" data-lang-key="showMeterCalculation">Show By Meter Calculation</button>
                <button id="toggleTableButton" class="btn w-full text-left" data-lang-key="showDeviceTable">Show Device Table</button>
                <button id="toggleBudgetOptimizationButton" class="btn w-full text-left" data-lang-key="showBudgetOptimization">Show Budget Optimization</button>
                <button id="showTariffDetailsButton" class="btn w-full text-left" data-lang-key="showTariffDetails">Show Tariff Details</button>
            </div>

            <!-- 5. Device Consumption Table -->
            <div class="section-card flex-grow" id="deviceTableSection" style="display: none;">
                <h2 class="text-xl" data-lang-key="deviceConsumptionTableTitle">5. Device Consumption Table</h2>
                <div class="device-table-container">
                    <table id="deviceTable" class="device-table">
                        <thead>
                            <tr>
                                <th data-lang-key="deviceHeader">Device</th>
                                <th data-lang-key="wattHeader">Watt</th>
                                <th data-lang-key="hoursHeader">Hours</th>
                                <th data-lang-key="dayHeader">Day</th>
                                <th data-lang-key="countHeader">Count</th>
                                <th data-lang-key="kwhHeader">kWh</th>
                                <th data-lang-key="iqdHeader">IQD</th>
                                <th data-lang-key="onHeader">On</th>
                                <th data-lang-key="fixedHeader">Fixed</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Device rows will be populated here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div class="flex flex-wrap items-start gap-4 mt-6 max-w-lg ml-0 mr-auto">
                    <button id="addRowButton" class="btn w-full sm:w-auto text-left" data-lang-key="addRowButton">Add Row</button>
                    <button id="deleteRowButton" class="btn w-full sm:w-auto text-left" data-lang-key="deleteSelectedButton">Delete Selected</button>
                    <button id="saveTableButton" class="btn w-full sm:w-auto text-left" data-lang-key="saveDataCSVButton">Save Data (CSV)</button>
                    <label for="loadFileInput" class="btn cursor-pointer w-full sm:w-auto text-left" data-lang-key="loadDataCSVButton">Load Data (CSV)<input type="file" id="loadFileInput" accept=".csv" class="hidden"></label>
                    <button id="clearAllButton" class="btn w-full sm:w-auto text-left" data-lang-key="clearAllButton">Clear All</button>
                </div>
                <button id="deviceReportButton" class="btn btn-action w-full mt-6" data-lang-key="generateReportButton">Generate Report</button>
            </div>

            <!-- 3. Budget Optimization -->
            <div class="section-card" id="budgetOptimizationSection" style="display: none;">
                <h2 class="text-xl" data-lang-key="budgetOptimizationTitle">3. Budget Optimization</h2>
                <div class="input-group">
                    <select id="optimizationTargetDropdown" class="p-2 border rounded-md">
                        <option value="Target Cost" data-lang-key="targetCostOption">Target Cost</option>
                        <option value="Target Amperes" data-lang-key="targetAmperesOption">Target Amperes</option>
                        <option value="Target kWh" data-lang-key="targetKwhOption">Target kWh</option>
                    </select>
                    <input type="number" id="budgetLimitInput" value="100000" class="w-32">
                </div>
                <button id="optimizeBudgetButton" class="btn btn-action w-full" data-lang-key="optimizeTargetButton">Optimize Target</button>
                <div class="result-grid" id="budgetOptimizationResultGrid">
                    <div class="result-item col-span-full">
                        <div class="result-label" data-lang-key="optimizationResultLabel">Optimization Result</div>
                        <div class="result-value" id="budgetResultLabel" data-lang-key="notOptimized">Not Optimized</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <footer class="mt-8 text-center text-neutral-gray-medium text-sm">
        <p data-lang-key="footerText">Created by Dr. Ismael Abdulrahman</p>
        <p class="text-sm">ismael.abdulrahman@epu.edu.iq</p>
    </footer>

    <!-- Custom Modal for Tariff Details -->
    <div id="tariffDetailsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-button" id="closeTariffDetailsModal">&times;</button>
            <h3 id="tariffDetailsModalTitle" data-lang-key="tariffDetailsModalTitle">Tariff Details</h3>
            <div id="householdTariffChartContainer" class="chart-container" style="display: none;">
                <canvas id="householdTariffChart"></canvas>
            </div>
            <div id="commercialTariffChartContainer" class="chart-container" style="display: none;">
                <canvas id="commercialTariffChart"></canvas>
            </div>
            <div id="otherCategoriesTariffChartContainer" class="chart-container" style="display: none;">
                <canvas id="otherCategoriesTariffChart"></canvas>
            </div>
            <pre id="tariffDetailsModalContent"></pre>
        </div>
    </div>

    <!-- Custom Modal for Reports -->
    <div id="reportModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-button" id="closeReportModal">&times;</button>
            <h3 id="reportModalTitle" data-lang-key="reportModalTitle">Report</h3>
            <div id="reportModalContent" class="prose"></div>
        </div>
    </div>

    <!-- Custom Message Box -->
    <div id="appMessage" class=""></div>

    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- LANGUAGE TRANSLATION ---
            const translations = {
                en: {
                    appTitle: "Iraqi Electricity Bill Assistant",
                    mainTitle: "Iraqi Electricity Bill Assistant",
                    manualCalculationTitle: "1. Manual Calculation",
                    categoryLabel: "Category:",
                    householdOption: "Household",
                    commercialOption: "Commercial",
                    agricultureOption: "Agriculture",
                    industrialOption: "Industrial",
                    governmentOption: "Government",
                    inputLabel: "Input:",
                    kwhOption: "kWh",
                    avgAmperesOption: "Avg Amperes",
                    givenBillOption: "Given Bill (IQD)",
                    calculateBillButton: "Calculate Bill",
                    billLabel: "Bill",
                    consumptionLabel: "Consumption",
                    avgAmperesLabel: "Avg Amperes",
                    avgRateLabel: "Avg Rate",
                    generateReportButton: "Generate Report",
                    meterCalculationTitle: "2. By Meter Calculation",
                    prevReadingLabel: "Prev Reading:",
                    currReadingLabel: "Curr Reading:",
                    daysLabel: "Days:",
                    hideManualCalculation: "Hide Manual Calculation",
                    showManualCalculation: "Show Manual Calculation",
                    showMeterCalculation: "Show By Meter Calculation",
                    hideMeterCalculation: "Hide By Meter Calculation",
                    showDeviceTable: "Show Device Table",
                    hideDeviceTable: "Hide Device Table",
                    showBudgetOptimization: "Show Budget Optimization",
                    hideBudgetOptimization: "Hide Budget Optimization",
                    showTariffDetails: "Show Tariff Details",
                    deviceConsumptionTableTitle: "5. Device Consumption Table",
                    deviceHeader: "Device",
                    wattHeader: "Watt",
                    hoursHeader: "Hours",
                    dayHeader: "Day",
                    countHeader: "Count",
                    kwhHeader: "kWh",
                    iqdHeader: "IQD",
                    onHeader: "On",
                    fixedHeader: "Fixed",
                    addRowButton: "Add Row",
                    deleteSelectedButton: "Delete Selected",
                    saveDataCSVButton: "Save Data (CSV)",
                    loadDataCSVButton: "Load Data (CSV)",
                    clearAllButton: "Clear All",
                    budgetOptimizationTitle: "3. Budget Optimization",
                    targetCostOption: "Target Cost",
                    targetAmperesOption: "Target Amperes",
                    targetKwhOption: "Target kWh",
                    optimizeTargetButton: "Optimize Target",
                    optimizationResultLabel: "Optimization Result",
                    notOptimized: "Not Optimized",
                    footerText: "Created by Dr. Ismael Abdulrahman",
                    tariffDetailsModalTitle: "Electricity Tariff Details",
                    reportModalTitle: "Report",
                    // Messages
                    enterValidNumeric: "Please enter a valid numeric value for consumption.",
                    currentReadingLessThanPrevious: "Current reading cannot be less than previous reading.",
                    enterPositiveDays: "Please enter a positive integer for days.",
                    performCalculationFirst: "Please perform a calculation first.",
                    ensureValidMeterReadings: "Please ensure valid meter readings and days are entered before generating a report.",
                    addAndCalculateDeviceConsumption: "Please add and calculate device consumption before generating a report.",
                    csvEmpty: "CSV file is empty or corrupted.",
                    deviceDataSaved: "Device data saved to CSV successfully!",
                    deviceDataLoaded: "Device data loaded from CSV successfully!",
                    errorLoadingData: "Error loading data: {error}. Please ensure it's a valid CSV file.",
                    selectRowToDelete: "Please select a row to delete.",
                    allDeviceDataCleared: "All device data has been cleared and reset to default.",
                    invalidTarget: "Invalid Target",
                    withinTarget: "Result: Within Target!",
                    currentStatusWithinTarget: "Your current status is already within the specified target!",
                    optimizationCompleted: "Optimization completed successfully!",
                    unreachable: "Result: Unreachable",
                    couldNotReachTarget: "Could not reach the target by only reducing hours of variable devices.",
                    // Report specific labels
                    manualCalculationSummary: "Manual Calculation Summary",
                    meterCalculationSummary: "Meter Calculation Summary",
                    overallConsumptionSummary: "Overall Consumption Summary",
                    tariffBreakdown: "Tariff Breakdown",
                    deviceBreakdown: "Device Breakdown",
                    device: "Device",
                    watt: "Watt",
                    hoursPerDay: "Hours/Day",
                    daysPerMonth: "Days/Month",
                    count: "Count",
                    kwhPerMonth: "kWh/Month",
                    iqdPerMonth: "IQD/Month",
                    onQuestion: "On?",
                    fixedQuestion: "Fixed?",
                    category: "Category",
                    previousReading: "Previous Reading",
                    currentReading: "Current Reading",
                    days: "Days",
                    totalBill: "Total Bill",
                    totalConsumption: "Total Consumption",
                    averageAmperes: "Average Amperes",
                    averageRate: "Average Rate",
                    // Tariff details
                    householdTariffRates: "Household Tariff Rates (IQD/kWh)",
                    commercialTariffRates: "Commercial Tariff Rates (IQD/kWh)",
                    otherCategoriesTariffRates: "Other Categories Tariff Rates (IQD/kWh)",
                    rate: "Rate (IQD/kWh)",
                    consumptionTiers: "Consumption Tiers",
                    consumption: "Consumption",
                    iqdPerKwh: "IQD/kWh",
                    categoryText: "Category",
                    slab: "Slab",
                    // Units
                    unitIQD: "IQD",
                    unitKWH: "kWh",
                    unitA: "A",
                    yes: "Yes",
                    no: "No",
                    // Device Names
                    deviceNames: {
                        ledTv: "LED TV",
                        refrigerator: "Refrigerator",
                        washingMachine: "Washing Machine",
                        ledLighting: "LED Lighting",
                        freezer: "Freezer",
                        waterPump: "Water Pump",
                        waterHeater: "Water Heater",
                        airCooler: "Air Cooler",
                        fan: "Fan",
                        dishwasher: "Dishwasher",
                        waterDispenser: "Water Dispenser",
                        splitAc1Ton: "Split AC (1 ton)",
                        splitAc1_5Ton: "Split AC (1.5 ton)",
                        splitAc2Ton: "Split AC (2 ton)",
                        towerAc: "Tower AC",
                        electricHeater: "Electric Heater",
                        iron: "Iron",
                        microwave: "Microwave",
                        electricKettle: "Electric Kettle",
                        hairDryer: "Hair Dryer",
                        vacuumCleaner: "Vacuum Cleaner",
                        electricOven: "Electric Oven",
                        phoneCharger: "Phone Charger",
                        desktopPc: "Desktop PC",
                        pcMonitor: "PC Monitor",
                        newDevice: "New Device"
                    }
                },
                ar: {
                    appTitle: "مساعد فواتير كهرباء العراق",
                    mainTitle: "مساعد فواتير كهرباء العراق",
                    manualCalculationTitle: "1. الحساب اليدوي",
                    categoryLabel: "الفئة:",
                    householdOption: "منزلي",
                    commercialOption: "تجاري",
                    agricultureOption: "زراعي",
                    industrialOption: "صناعي",
                    governmentOption: "حكومي",
                    inputLabel: "الإدخال:",
                    kwhOption: "كيلوواط ساعة",
                    avgAmperesOption: "متوسط الأمبير",
                    givenBillOption: "الفاتورة المعطاة (دينار عراقي)",
                    calculateBillButton: "حساب الفاتورة",
                    billLabel: "الفاتورة",
                    consumptionLabel: "الاستهلاك",
                    avgAmperesLabel: "متوسط الأمبير",
                    avgRateLabel: "متوسط السعر",
                    generateReportButton: "إنشاء تقرير",
                    meterCalculationTitle: "2. الحساب بالعداد",
                    prevReadingLabel: "القراءة السابقة:",
                    currReadingLabel: "القراءة الحالية:",
                    daysLabel: "الأيام:",
                    hideManualCalculation: "إخفاء الحساب اليدوي",
                    showManualCalculation: "إظهار الحساب اليدوي",
                    showMeterCalculation: "إظهار الحساب بالعداد",
                    hideMeterCalculation: "إخفاء الحساب بالعداد",
                    showDeviceTable: "إظهار جدول الأجهزة",
                    hideDeviceTable: "إخفاء جدول الأجهزة",
                    showBudgetOptimization: "إظهار تحسين الميزانية",
                    hideBudgetOptimization: "إخفاء تحسين الميزانية",
                    showTariffDetails: "إظهار تفاصيل التعرفة",
                    deviceConsumptionTableTitle: "5. جدول استهلاك الأجهزة",
                    deviceHeader: "الجهاز",
                    wattHeader: "واط",
                    hoursHeader: "الساعات",
                    dayHeader: "اليوم",
                    countHeader: "العدد",
                    kwhHeader: "كيلوواط ساعة",
                    iqdHeader: "دينار عراقي",
                    onHeader: "تشغيل",
                    fixedHeader: "ثابت",
                    addRowButton: "إضافة صف",
                    deleteSelectedButton: "حذف المحدد",
                    saveDataCSVButton: "حفظ البيانات (CSV)",
                    loadDataCSVButton: "تحميل البيانات (CSV)",
                    clearAllButton: "مسح الكل",
                    budgetOptimizationTitle: "3. تحسين الميزانية",
                    targetCostOption: "التكلفة المستهدفة",
                    targetAmperesOption: "الأمبير المستهدف",
                    targetKwhOption: "كيلوواط ساعة المستهدفة",
                    optimizeTargetButton: "تحسين الهدف",
                    optimizationResultLabel: "نتيجة التحسين",
                    notOptimized: "لم يتم التحسين",
                    footerText: "تم الإنشاء بواسطة د. إسماعيل عبدالرحمن",
                    tariffDetailsModalTitle: "تفاصيل تعرفة الكهرباء",
                    reportModalTitle: "التقرير",
                    // Messages
                    enterValidNumeric: "الرجاء إدخال قيمة رقمية صالحة للاستهلاك.",
                    currentReadingLessThanPrevious: "لا يمكن أن تكون القراءة الحالية أقل من القراءة السابقة.",
                    enterPositiveDays: "الرجاء إدخال عدد صحيح موجب للأيام.",
                    performCalculationFirst: "الرجاء إجراء عملية حساب أولاً.",
                    ensureValidMeterReadings: "الرجاء التأكد من إدخال قراءات عداد وأيام صالحة قبل إنشاء التقرير.",
                    addAndCalculateDeviceConsumption: "الرجاء إضافة وحساب استهلاك الجهاز قبل إنشاء التقرير.",
                    csvEmpty: "ملف CSV فارغ أو تالف.",
                    deviceDataSaved: "تم حفظ بيانات الجهاز إلى CSV بنجاح!",
                    deviceDataLoaded: "تم تحميل بيانات الجهاز من CSV بنجاح!",
                    errorLoadingData: "خطأ في تحميل البيانات: {error}. يرجى التأكد من أنه ملف CSV صالح.",
                    selectRowToDelete: "الرجاء تحديد صف لحذفه.",
                    allDeviceDataCleared: "تم مسح جميع بيانات الجهاز وإعادة تعيينها إلى الافتراضي.",
                    invalidTarget: "هدف غير صالح",
                    withinTarget: "النتيجة: ضمن الهدف!",
                    currentStatusWithinTarget: "وضعك الحالي ضمن الهدف المحدد بالفعل!",
                    optimizationCompleted: "اكتمل التحسين بنجاح!",
                    unreachable: "النتيجة: لا يمكن الوصول إليه",
                    couldNotReachTarget: "تعذر الوصول إلى الهدف عن طريق تقليل ساعات الأجهزة المتغيرة فقط.",
                    // Report specific labels
                    manualCalculationSummary: "ملخص الحساب اليدوي",
                    meterCalculationSummary: "ملخص الحساب بالعداد",
                    overallConsumptionSummary: "ملخص الاستهلاك الكلي",
                    tariffBreakdown: "تفاصيل التعرفة",
                    deviceBreakdown: "تفاصيل الجهاز",
                    device: "الجهاز",
                    watt: "واط",
                    hoursPerDay: "ساعات/يوم",
                    daysPerMonth: "أيام/شهر",
                    count: "العدد",
                    kwhPerMonth: "كيلوواط ساعة/شهر",
                    iqdPerMonth: "دينار عراقي/شهر",
                    onQuestion: "تشغيل؟",
                    fixedQuestion: "ثابت؟",
                    category: "الفئة",
                    previousReading: "القراءة السابقة",
                    currentReading: "القراءة الحالية",
                    days: "الأيام",
                    totalBill: "إجمالي الفاتورة",
                    totalConsumption: "إجمالي الاستهلاك",
                    averageAmperes: "متوسط الأمبير",
                    averageRate: "متوسط السعر",
                    // Tariff details
                    householdTariffRates: "أسعار تعرفة المنازل (دينار عراقي/كيلوواط ساعة)",
                    commercialTariffRates: "أسعار التعرفة التجارية (دينار عراقي/كيلوواط ساعة)",
                    otherCategoriesTariffRates: "أسعار تعرفة الفئات الأخرى (دينار عراقي/كيلوواط ساعة)",
                    rate: "السعر (دينار عراقي/كيلوواط ساعة)",
                    consumptionTiers: "شرائح الاستهلاك",
                    consumption: "الاستهلاك",
                    iqdPerKwh: "دينار عراقي/كيلوواط ساعة",
                    slab: "شريحة",
                    // Units
                    unitIQD: "دينار عراقي",
                    unitKWH: "كيلوواط ساعة",
                    unitA: "أمبير",
                    yes: "نعم",
                    no: "لا",
                    // Device Names
                    deviceNames: {
                        ledTv: "تلفزيون LED",
                        refrigerator: "ثلاجة",
                        washingMachine: "غسالة",
                        ledLighting: "إضاءة LED",
                        freezer: "فريزر",
                        waterPump: "مضخة مياه",
                        waterHeater: "سخان مياه",
                        airCooler: "مبرد هواء",
                        fan: "مروحة",
                        dishwasher: "غسالة صحون",
                        waterDispenser: "موزع مياه",
                        splitAc1Ton: "مكيف سبليت (1 طن)",
                        splitAc1_5Ton: "مكيف سبليت (1.5 طن)",
                        splitAc2Ton: "مكيف سبليت (2 طن)",
                        towerAc: "مكيف برج",
                        electricHeater: "سخان كهربائي",
                        iron: "مكواة",
                        microwave: "ميكروويف",
                        electricKettle: "غلاية كهربائية",
                        hairDryer: "مجفف شعر",
                        vacuumCleaner: "مكنسة كهربائية",
                        electricOven: "فرن كهربائي",
                        phoneCharger: "شاحن هاتف",
                        desktopPc: "كمبيوتر مكتبي",
                        pcMonitor: "شاشة كمبيوتر",
                        newDevice: "جهاز جديد"
                    }
                },
                ku: {
                    appTitle: "یارمەتیدەری بیلی کارەبای عێراق",
                    mainTitle: "یارمەتیدەری بیلی کارەبای عێراق",
                    manualCalculationTitle: "1. ژماردنی دەستی",
                    categoryLabel: "پۆلێن:",
                    householdOption: "ماڵان",
                    commercialOption: "بازرگانی",
                    agricultureOption: "کشتوکاڵ",
                    industrialOption: "پیشەسازی",
                    governmentOption: "حکومی",
                    inputLabel: "دانان:",
                    kwhOption: "کیلۆوات کاتژمێر",
                    avgAmperesOption: "تێکڕای ئەمپێر",
                    givenBillOption: "بیلی دراو (د.ع)",
                    calculateBillButton: "ژماردنی بیل",
                    billLabel: "بیل",
                    consumptionLabel: "بەکارهێنان",
                    avgAmperesLabel: "تێکڕای ئەمپێر",
                    avgRateLabel: "تێکڕای نرخ",
                    generateReportButton: "دروستکردنی ڕاپۆرت",
                    meterCalculationTitle: "2. ژماردن بە پێوەری کارەبا",
                    prevReadingLabel: "خوێندنەوەی پێشوو:",
                    currReadingLabel: "خوێندنەوەی ئێستا:",
                    daysLabel: "ڕۆژەکان:",
                    hideManualCalculation: "شاردنەوەی ژماردنی دەستی",
                    showManualCalculation: "پیشاندانی ژماردنی دەستی",
                    showMeterCalculation: "پیشاندانی ژماردن بە پێوەری کارەبا",
                    hideMeterCalculation: "شاردنەوەی ژماردن بە پێوەر",
                    showDeviceTable: "پیشاندانی خشتەی ئامێرەکان",
                    hideDeviceTable: "شاردنەوەی خشتەی ئامێرەکان",
                    showBudgetOptimization: "پیشاندانی باشترکردنی بودجە",
                    hideBudgetOptimization: "شاردنەوەی باشترکردنی بودجە",
                    showTariffDetails: "پیشاندانی وردەکارییەکانی تاریف",
                    deviceConsumptionTableTitle: "5. خشتەی بەکارهێنانی ئامێر",
                    deviceHeader: "ئامێر",
                    wattHeader: "وات",
                    hoursHeader: "کاتژمێر",
                    dayHeader: "ڕۆژ",
                    countHeader: "ژمارە",
                    kwhHeader: "کیلۆوات کاتژمێر",
                    iqdHeader: "د.ع",
                    onHeader: "کارا",
                    fixedHeader: "جێگیر",
                    addRowButton: "زیادکردنی ڕیز",
                    deleteSelectedButton: "سڕینەوەی هەڵبژێردراو",
                    saveDataCSVButton: "پاشەکەوتکردنی داتا (CSV)",
                    loadDataCSVButton: "بارکردنی داتا (CSV)",
                    clearAllButton: "پاککردنەوەی هەموو",
                    budgetOptimizationTitle: "3. باشترکردنی بودجە",
                    targetCostOption: "تێچووی ئامانج",
                    targetAmperesOption: "ئەمپێری ئامانج",
                    targetKwhOption: "کیلۆوات کاتژمێری ئامانج",
                    optimizeTargetButton: "باشترکردنی ئامانج",
                    optimizationResultLabel: "ئەنجامی باشترکردن",
                    notOptimized: "باشتر نەکراوە",
                    footerText: "دروستکراوە لەلایەن د. ئیسماعیل عبدالرحمن",
                    tariffDetailsModalTitle: "وردەکارییەکانی تاریفی کارەبا",
                    reportModalTitle: "ڕاپۆرت",
                    // Messages
                    enterValidNumeric: "تکایە بەهایەکی ژمارەیی دروست بۆ بەکارهێنان بنووسە.",
                    currentReadingLessThanPrevious: "خوێندنەوەی ئێستا ناتوانێت کەمتر بێت لە خوێندنەوەی پێشوو.",
                    enterPositiveDays: "تکایە ژمارەیەکی تەواوی پۆزەتیڤ بۆ ڕۆژەکان بنووسە.",
                    performCalculationFirst: "تکایە سەرەتا ژماردنێک ئەنجام بدە.",
                    ensureValidMeterReadings: "تکایە دڵنیا بە لەوەی خوێندنەوەی پێوەر و ڕۆژەکان دروستن پێش دروستکردنی ڕاپۆرت.",
                    addAndCalculateDeviceConsumption: "تکایە ئامێر زیاد بکە و بەکارهێنانەکەی بژمێرە پێش دروستکردنی ڕاپۆرت.",
                    csvEmpty: "فایلی CSV بەتاڵە یان تێکچووە.",
                    deviceDataSaved: "داتای ئامێر بە سەرکەوتوویی پاشەکەوت کرا بۆ CSV!",
                    deviceDataLoaded: "تم تحميل بيانات الجهاز من CSV بنجاح!",
                    errorLoadingData: "هەڵە لە بارکردنی داتا: {error}. تکایە دڵنیا بە لەوەی فایلی CSV دروستە.",
                    selectRowToDelete: "تکایە ڕیزێک هەڵبژێرە بۆ سڕینەوە.",
                    allDeviceDataCleared: "هەموو داتای ئامێر پاککرایەوە و گەڕێنرایەوە بۆ باری بنەڕەتی.",
                    invalidTarget: "ئامانجی نادروست",
                    withinTarget: "ئەنجام: لەناو ئامانجدا!",
                    currentStatusWithinTarget: "دۆخی ئێستات لەناو ئامانجی دیاریکراودا پاشەکەوت کراوە!",
                    optimizationCompleted: "باشترکردن بە سەرکەوتوویی تەواو بوو!",
                    unreachable: "ئەنجام: ناتوانرێت پێی بگات",
                    couldNotReachTarget: "نەتوانرا بگاتە ئامانج تەنها بە کەمکردنەوەی کاتژمێرەکانی ئامێرە گۆڕاوەکان.",
                    // Report specific labels
                    manualCalculationSummary: "کورتەی ژماردنی دەستی",
                    meterCalculationSummary: "کورتەی ژماردن بە پێوەر",
                    overallConsumptionSummary: "کورتەی گشتیی بەکارهێنان",
                    tariffBreakdown: "وردەکارییەکانی تاریف",
                    deviceBreakdown: "وردەکارییەکانی ئامێر",
                    device: "ئامێر",
                    watt: "وات",
                    hoursPerDay: "کاتژمێر/ڕۆژ",
                    daysPerMonth: "ڕۆژ/مانگ",
                    count: "ژمارە",
                    kwhPerMonth: "کیلۆوات کاتژمێر/مانگ",
                    iqdPerMonth: "د.ع/مانگ",
                    onQuestion: "کارا؟",
                    fixedQuestion: "جێگیر؟",
                    category: "پۆلێن",
                    previousReading: "خوێندنەوەی پێشوو",
                    currentReading: "خوێندنەوەی ئێستا",
                    days: "ڕۆژەکان",
                    totalBill: "کۆی بیل",
                    totalConsumption: "کۆی بەکارهێنان",
                    averageAmperes: "تێکڕای ئەمپێر",
                    averageRate: "تێکڕای نرخ",
                    // Tariff details
                    householdTariffRates: "نرخی تاریفی ماڵان (د.ع/کیلۆوات کاتژمێر)",
                    commercialTariffRates: "نرخی تاریفی بازرگانی (د.ع/کیلۆوات کاتژمێر)",
                    otherCategoriesTariffRates: "نرخی تاریفی پۆلێنەکانی تر (د.ع/کیلۆوات کاتژمێر)",
                    rate: "نرخ (د.ع/کیلۆوات کاتژمێر)",
                    consumptionTiers: "پلەکانی بەکارهێنان",
                    consumption: "بەکارهێنان",
                    iqdPerKwh: "د.ع/کیلۆوات کاتژمێر",
                    slab: "شریحه",
                    // Units
                    unitIQD: "د.ع",
                    unitKWH: "کیلۆوات کاتژمێر",
                    unitA: "ئەمپێر",
                    yes: "بەڵێ",
                    no: "نەخێر",
                    // Device Names
                    deviceNames: {
                        ledTv: "تەلەفزیۆنی LED",
                        refrigerator: "ساردکەرەوە",
                        washingMachine: "جلشۆر",
                        ledLighting: "ڕووناککەرەوەی LED",
                        freezer: "فریزەر",
                        waterPump: "پەمپی ئاو",
                        waterHeater: "گەرمکەرەوەی ئاو",
                        airCooler: "فێنککەرەوەی هەوا",
                        fan: "پانکە",
                        dishwasher: "قاپشۆر",
                        waterDispenser: "دابەشکردنی ئاو",
                        splitAc1Ton: "ئەی سی سپلیت (1 تۆن)",
                        splitAc1_5Ton: "ئەی سی سپلیت (1.5 تۆن)",
                        splitAc2Ton: "ئەی سی سپلیت (2 تۆن)",
                        towerAc: "ئەی سی تاوەر",
                        electricHeater: "گەرمکەرەوەی کارەبایی",
                        iron: "ئوتوو",
                        microwave: "مایکرۆوەیڤ",
                        electricKettle: "گۆزەڵەی کارەبایی",
                        hairDryer: "وشککەرەوەی قژ",
                        vacuumCleaner: "پاککەرەوەی کارەبایی",
                        electricOven: "فڕنی کارەبایی",
                        phoneCharger: "شاحنی مۆبایل",
                        desktopPc: "کۆمپیوتەری مێز",
                        pcMonitor: "شاشەی کۆمپیوتەر",
                        newDevice: "ئامێری نوێ"
                    }
                }
            };

            const langEnBtn = document.getElementById('lang-en');
            const langArBtn = document.getElementById('lang-ar');
            const langKuBtn = document.getElementById('lang-ku');
            const langBtns = [langEnBtn, langArBtn, langKuBtn];
            let currentLang = 'en';

            const translatePage = (lang) => {
                currentLang = lang;
                const elements = document.querySelectorAll('[data-lang-key]');
                const body = document.body;

                // Set direction and text alignment
                if (lang === 'ar' || lang === 'ku') {
                    body.classList.add('rtl');
                } else {
                    body.classList.remove('rtl');
                }

                // Translate static text content
                elements.forEach(element => {
                    const key = element.getAttribute('data-lang-key');
                    if (translations[lang] && translations[lang][key]) {
                        element.textContent = translations[lang][key];
                    }
                });

                // Translate options in dropdowns
                document.querySelectorAll('select').forEach(selectElement => {
                    Array.from(selectElement.options).forEach(option => {
                        const key = option.getAttribute('data-lang-key');
                        if (key && translations[lang] && translations[lang][key]) {
                            option.textContent = translations[lang][key];
                        }
                    });
                });

                // Update device table names
                Array.from(deviceTableBody.children).forEach(row => {
                    const nameInput = row.querySelector('.device-input[type="text"]');
                    const nameKey = nameInput.getAttribute('data-name-key');
                    if (nameKey && translations[lang].deviceNames[nameKey]) {
                        nameInput.value = translations[lang].deviceNames[nameKey];
                    }
                });

                // Update report modal content if it's open (re-generate it)
                if (reportModal.style.display === 'flex') {
                    const currentReportTitle = reportModalTitle.textContent;
                    // Check against all possible translated titles to determine which report to regenerate
                    if (currentReportTitle === translations.en.manualCalculationSummary ||
                        currentReportTitle === translations.ar.manualCalculationSummary ||
                        currentReportTitle === translations.ku.manualCalculationSummary) {
                        generateManualReport();
                    } else if (currentReportTitle === translations.en.meterCalculationSummary ||
                               currentReportTitle === translations.ar.meterCalculationSummary ||
                               currentReportTitle === translations.ku.meterCalculationSummary) {
                        generateMeterReport();
                    } else if (currentReportTitle === translations.en.overallConsumptionSummary ||
                               currentReportTitle === translations.ar.overallConsumptionSummary ||
                               currentReportTitle === translations.ku.overallConsumptionSummary) {
                        generateDeviceReport();
                    }
                }


                // Update tariff modal content if it's open (re-generate it)
                if (tariffDetailsModal.style.display === 'flex') {
                    showTariffDetailsButton.click(); // Re-trigger the display to update charts/text
                }

                // Update button texts that toggle visibility
                const isManualVisible = manualCalculationSection.style.display === 'block';
                toggleManualCalculationButton.textContent = isManualVisible ? translations[lang].hideManualCalculation : translations[lang].showManualCalculation;
                
                const isMeterVisible = meterCalculationSection.style.display === 'block';
                toggleMeterCalculationButton.textContent = isMeterVisible ? translations[lang].hideMeterCalculation : translations[lang].showMeterCalculation;

                const isDeviceTableVisible = deviceTableSection.style.display === 'block';
                toggleTableButton.textContent = isDeviceTableVisible ? translations[lang].hideDeviceTable : translations[lang].showDeviceTable;

                const isBudgetOptimizationVisible = budgetOptimizationSection.style.display === 'block';
                toggleBudgetOptimizationButton.textContent = isBudgetOptimizationVisible ? translations[lang].hideBudgetOptimization : translations[lang].showBudgetOptimization;
            };

            const setActiveLanguage = (lang) => {
                langBtns.forEach(btn => btn.classList.remove('active'));
                if (lang === 'en') langEnBtn.classList.add('active');
                else if (lang === 'ar') langArBtn.classList.add('active');
                else if (lang === 'ku') langKuBtn.classList.add('active');
                translatePage(lang);
            };

            // --- GLOBAL CONSTANTS ---
            const VOLTAGE = 220;
            const HOURS_PER_DAY = 24;

            // --- UI ELEMENTS ---
            const categoryDropdown = document.getElementById('categoryDropdown');
            const manualInputTypeDropdown = document.getElementById('manualInputTypeDropdown');
            const manualInput = document.getElementById('manualInput');
            const calculateManualButton = document.getElementById('calculateManualButton');
            const manualReportButton = document.getElementById('manualReportButton');

            const manualKwhElem = document.getElementById('manualKwh');
            const manualAmperesElem = document.getElementById('manualAmperes');
            const manualBillElem = document.getElementById('manualBill');
            const manualAvgRateElem = document.getElementById('manualAvgRate');
            const manualResultGrid = document.getElementById('manualResultGrid');

            const calculateMeterButton = document.getElementById('calculateMeterButton');
            const meterPrevReading = document.getElementById('meterPrevReading');
            const meterCurrReading = document.getElementById('meterCurrReading');
            const daysInput = document.getElementById('daysInput');

            const meterKwhElem = document.getElementById('meterKwh');
            const meterAmperesElem = document.getElementById('meterAmperes');
            const meterBillElem = document.getElementById('meterBill');
            const meterAvgRateElem = document.getElementById('meterAvgRate');
            const meterReportButton = document.getElementById('meterReportButton');
            const meterResultGrid = document.getElementById('meterResultGrid');

            const optimizeBudgetButton = document.getElementById('optimizeBudgetButton');
            const optimizationTargetDropdown = document.getElementById('optimizationTargetDropdown');
            const budgetLimitInput = document.getElementById('budgetLimitInput');
            const budgetResultLabel = document.getElementById('budgetResultLabel');
            const budgetOptimizationResultGrid = document.getElementById('budgetOptimizationResultGrid');

            const deviceTableBody = document.querySelector("#deviceTable tbody");
            const addRowButton = document.getElementById('addRowButton');
            const deleteRowButton = document.getElementById('deleteRowButton');
            const saveTableButton = document.getElementById('saveTableButton');
            const loadFileInput = document.getElementById('loadFileInput');
            const clearAllButton = document.getElementById('clearAllButton');
            const deviceReportButton = document.getElementById('deviceReportButton');
            const deviceTableSection = document.getElementById('deviceTableSection'); // For result grid color

            // New UI element references for toggling visibility
            const toggleBudgetOptimizationButton = document.getElementById('toggleBudgetOptimizationButton'); 
            const toggleTableButton = document.getElementById('toggleTableButton');
            const showTariffDetailsButton = document.getElementById('showTariffDetailsButton'); 

            // Section elements
            const manualCalculationSection = document.getElementById('manualCalculationSection');
            const meterCalculationSection = document.getElementById('meterCalculationSection');
            const budgetOptimizationSection = document.getElementById('budgetOptimizationSection'); 
            

            // New toggle buttons for manual and meter sections
            const toggleManualCalculationButton = document.getElementById('toggleManualCalculationButton');
            const toggleMeterCalculationButton = document.getElementById('toggleMeterCalculationButton');

            // Modal elements (Tariff)
            const tariffDetailsModal = document.getElementById('tariffDetailsModal');
            const closeTariffDetailsModal = document.getElementById('closeTariffDetailsModal');
            const tariffDetailsModalTitle = document.getElementById('tariffDetailsModalTitle');
            const tariffDetailsModalContent = document.getElementById('tariffDetailsModalContent');
            const householdTariffChartContainer = document.getElementById('householdTariffChartContainer');
            const householdTariffChartCanvas = document.getElementById('householdTariffChart');
            const commercialTariffChartContainer = document.getElementById('commercialTariffChartContainer');
            const commercialTariffChartCanvas = document.getElementById('commercialTariffChart');
            const otherCategoriesTariffChartContainer = document.getElementById('otherCategoriesTariffChartContainer');
            const otherCategoriesTariffChartCanvas = document.getElementById('otherCategoriesTariffChart');
            let householdTariffChartInstance = null;
            let commercialTariffChartInstance = null;
            let otherCategoriesTariffChartInstance = null;

            // Modal elements (Report)
            const reportModal = document.getElementById('reportModal');
            const closeReportModal = document.getElementById('closeReportModal');
            const reportModalTitle = document.getElementById('reportModalTitle');
            const reportModalContent = document.getElementById('reportModalContent');

            // Message box element
            const appMessage = document.getElementById('appMessage');

            let selectedTableRow = null; 

            // Event listener for language selection change
            langEnBtn.addEventListener('click', () => setActiveLanguage('en'));
            langArBtn.addEventListener('click', () => setActiveLanguage('ar'));
            langKuBtn.addEventListener('click', () => setActiveLanguage('ku'));


            // --- UTILITY FUNCTIONS ---
            const formatNumber = (value, decimalPlaces = 2, isCurrency = false, removeTrailingZeroDecimal = false) => {
                try {
                    const num = parseFloat(value);
                    if (isNaN(num)) return String(value);
                    const lang = currentLang;
                    // Use 'ar-IQ' for Arabic, 'en-US' for English and Kurdish (as Kurdish typically uses Western numerals for numbers)
                    const locale = lang === 'ar' ? 'ar-IQ' : 'en-US'; 

                    const options = {
                        minimumFractionDigits: decimalPlaces,
                        maximumFractionDigits: decimalPlaces,
                        useGrouping: false // Disable thousands separators (commas)
                    };

                    if (isCurrency) {
                        // For currency, we want no decimals, and no grouping
                        return Math.round(num).toLocaleString(locale, { useGrouping: false, minimumFractionDigits: 0, maximumFractionDigits: 0 });
                    }
                    if (removeTrailingZeroDecimal && num === parseInt(num)) {
                        // For integers that should be displayed without decimals, and no grouping
                        return parseInt(num).toLocaleString(locale, { useGrouping: false, minimumFractionDigits: 0, maximumFractionDigits: 0 });
                    }
                    return num.toLocaleString(locale, options);
                } catch (e) {
                    console.error("Error formatting number:", e);
                    return String(value);
                }
            };

            const convertArabicNumeralsToWestern = (input) => {
                if (typeof input !== 'string') return input;
                const arabicNumerals = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
                const westernNumerals = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];

                let output = input;
                for (let i = 0; i < arabicNumerals.length; i++) {
                    output = output.replace(new RegExp(arabicNumerals[i], 'g'), westernNumerals[i]);
                }
                return output;
            };

            const validateNumeric = (textInput) => {
                if (typeof textInput !== 'string') textInput = String(textInput);

                // Convert Arabic numerals to Western numerals first
                let cleanInput = convertArabicNumeralsToWestern(textInput);

                // Replace Arabic thousands separator (٬) and decimal separator (٫)
                cleanInput = cleanInput.replace(/٬/g, '').replace(/٫/g, '.'); // Arabic thousands comma, Arabic decimal point

                // Replace English thousands comma (,)
                cleanInput = cleanInput.replace(/,/g, '');

                if (!cleanInput.trim()) return 0.0;
                const value = parseFloat(cleanInput);
                return isNaN(value) ? 0.0 : value;
            };

            const kwhToAmperes = (kwh, days) => {
                if (!days || days <= 0) return 0.0;
                const hoursTotal = HOURS_PER_DAY * days;
                return (kwh * 1000) / (VOLTAGE * hoursTotal);
            };

            const amperesToKwh = (amperes, days) => {
                if (!days || days <= 0) return 0.0;
                const hoursTotal = HOURS_PER_DAY * days;
                return (amperes * VOLTAGE * hoursTotal) / 1000;
            };

            // --- MESSAGE DISPLAY FUNCTION ---
            const showMessage = (messageKey, type = 'info', replacements = {}) => {
                const lang = currentLang;
                let message = translations[lang] && translations[lang][messageKey] ? translations[lang][messageKey] : messageKey;
                
                // Apply replacements
                for (const key in replacements) {
                    message = message.replace(`{${key}}`, replacements[key]);
                }

                appMessage.textContent = message;
                appMessage.className = ``; // Clear existing classes
                appMessage.classList.add(type, 'show');
                setTimeout(() => {
                    appMessage.classList.remove('show');
                }, 3000); // Message disappears after 3 seconds
            };

            // --- TARIFF CALCULATION LOGIC (IRAQI SYSTEM) ---
            const getIraqiTariffDetails = (kWh, category) => {
                const lang = currentLang;
                let totalCost = 0;
                let breakdown = [];
                let remainingKwh = kWh;
                
                let tiers, rates, slabNames;

                if (category === 'Household') {
                    tiers = [1500, 3000, 4000];
                    rates = [10, 35, 80, 120];
                    slabNames = ["1-1500 kWh", "1501-3000 kWh", "3001-4000 kWh", "4001+ kWh"];
                } else if (category === 'Commercial') {
                    tiers = [1000, 2000];
                    rates = [60, 80, 120];
                    slabNames = ["1-1000 kWh", "1001-2000 kWh", "2001+ kWh"];
                } else {
                    // Handle flat rates
                    let rate = 0;
                    if (category === 'Agriculture' || category === 'Industrial') rate = 60;
                    if (category === 'Government') rate = 120;

                    totalCost = kWh * rate;
                    breakdown.push(`  - ${translations[lang].consumption}: ${formatNumber(kWh, 2)} ${translations[lang].unitKWH} @ ${formatNumber(rate, 2)} ${translations[lang].iqdPerKwh} = ${formatNumber(totalCost, 0, true)} ${translations[lang].unitIQD}`);
                    return { totalCost, breakdown: breakdown.join("\n") };
                }

                // Progressive calculation for tiered rates
                let previousSlabLimit = 0;
                for (let i = 0; i < rates.length; i++) {
                    if (remainingKwh <= 0) break;

                    const slabRate = rates[i];
                    const slabLimit = (i < tiers.length) ? tiers[i] : Infinity;
                    const slabName = slabNames[i];

                    let consumptionInThisSlab = 0;
                    if (i === 0) {
                        consumptionInThisSlab = Math.min(remainingKwh, slabLimit);
                    } else {
                        consumptionInThisSlab = Math.min(remainingKwh, slabLimit - previousSlabLimit);
                    }

                    if (consumptionInThisSlab > 0) {
                        const costInThisSlab = consumptionInThisSlab * slabRate;
                        totalCost += costInThisSlab;
                        breakdown.push(`  - ${translations[lang].slab} ${i + 1} (${slabName}): ${formatNumber(consumptionInThisSlab, 2)} ${translations[lang].unitKWH} @ ${formatNumber(slabRate, 0)} ${translations[lang].iqdPerKwh} = ${formatNumber(costInThisSlab, 0, true)} ${translations[lang].unitIQD}`);
                    }
                    remainingKwh -= consumptionInThisSlab;
                    previousSlabLimit = slabLimit;
                }
                
                return { totalCost, breakdown: breakdown.join("\n") };
            };

            const calculateCostForCategory = (consumption, category) => {
                return getIraqiTariffDetails(consumption, category).totalCost;
            };

            // --- UI UPDATE FUNCTIONS ---

            const updateResultDisplay = (kwh, amperes, bill, avgRate, kwhElem, amperesElem, billElem, avgRateElem, resultGridElement, sectionType) => {
                // Set dynamic CSS variables for colors
                let resultColorVar, highlightColorVar;
                if (sectionType === 'manual') {
                    resultColorVar = 'var(--manual-result-color)';
                    highlightColorVar = 'var(--manual-highlight-color)';
                } else if (sectionType === 'meter') {
                    resultColorVar = 'var(--meter-result-color)';
                    highlightColorVar = 'var(--meter-highlight-color)';
                } else if (sectionType === 'device') {
                    resultColorVar = 'var(--device-result-color)';
                    highlightColorVar = 'var(--device-highlight-color)';
                } else if (sectionType === 'optimization') {
                    resultColorVar = 'var(--optimization-result-color)';
                    highlightColorVar = 'var(--optimization-highlight-color)';
                }

                resultGridElement.style.setProperty('--current-result-color', resultColorVar);
                resultGridElement.style.setProperty('--current-highlight-color', highlightColorVar);

                // Apply flashing animation
                [kwhElem, amperesElem, billElem, avgRateElem].forEach(elem => {
                    elem.classList.remove('flash-animation'); // Remove existing animation
                    void elem.offsetWidth; // Trigger reflow to restart animation
                    elem.classList.add('flash-animation'); // Add animation
                });
                const lang = currentLang;
                billElem.textContent = `${formatNumber(bill, 0, true)} ${translations[lang].unitIQD}`; // Bill first
                kwhElem.textContent = `${formatNumber(kwh, 2)} ${translations[lang].unitKWH}`;
                amperesElem.textContent = `${formatNumber(amperes, 2)} ${translations[lang].unitA}`;
                avgRateElem.textContent = `${formatNumber(avgRate, 2)} ${translations[lang].iqdPerKwh}`;
            };

            // --- MAIN CALCULATION HANDLER ---
            const performManualCalculation = () => {
                let inputValue = validateNumeric(manualInput.value);
                if (isNaN(inputValue) || inputValue < 0) {
                    showMessage("enterValidNumeric", 'error');
                    updateResultDisplay(0, 0, 0, 0, manualKwhElem, manualAmperesElem, manualBillElem, manualAvgRateElem, manualResultGrid, 'manual');
                    return;
                }

                const daysVal = validateNumeric(daysInput.value) || 30;
                const category = categoryDropdown.value;
                let calculatedKwh = 0;
                let calculatedAmperes = 0;
                let totalBill = 0;

                if (manualInputTypeDropdown.value === 'kWh') {
                    calculatedKwh = inputValue;
                    calculatedAmperes = kwhToAmperes(calculatedKwh, daysVal);
                    totalBill = calculateCostForCategory(calculatedKwh, category);
                } else if (manualInputTypeDropdown.value === 'Avg Amperes') {
                    calculatedAmperes = inputValue;
                    calculatedKwh = amperesToKwh(calculatedAmperes, daysVal);
                    totalBill = calculateCostForCategory(calculatedKwh, category);
                } else if (manualInputTypeDropdown.value === 'Given Bill') {
                    const targetBill = inputValue;
                    let lowKwh = 0;
                    let highKwh = 50000; 
                    let foundKwh = 0;
                    const tolerance = 1.0;

                    for (let i = 0; i < 100; i++) { 
                        const midKwh = (lowKwh + highKwh) / 2;
                        const calculatedBillAtMid = calculateCostForCategory(midKwh, category);

                        if (Math.abs(calculatedBillAtMid - targetBill) < tolerance) {
                            foundKwh = midKwh;
                            break;
                        } else if (calculatedBillAtMid < targetBill) {
                            lowKwh = midKwh;
                        } else {
                            highKwh = midKwh;
                        }
                    }
                    calculatedKwh = foundKwh;
                    calculatedAmperes = kwhToAmperes(calculatedKwh, daysVal);
                    totalBill = targetBill; 
                }

                const avgRate = calculatedKwh > 0 ? totalBill / calculatedKwh : 0;

                updateResultDisplay(calculatedKwh, calculatedAmperes, totalBill, avgRate, manualKwhElem, manualAmperesElem, manualBillElem, manualAvgRateElem, manualResultGrid, 'manual');
            };

            const performMeterCalculation = () => {
                const prevReading = validateNumeric(meterPrevReading.value);
                const currReading = validateNumeric(meterCurrReading.value);
                const daysVal = validateNumeric(daysInput.value) || 30;
                const category = categoryDropdown.value;

                if (isNaN(prevReading) || isNaN(currReading) || prevReading < 0 || currReading < 0) {
                    showMessage("ensureValidMeterReadings", 'error');
                    updateResultDisplay(0, 0, 0, 0, meterKwhElem, meterAmperesElem, meterBillElem, meterAvgRateElem, meterResultGrid, 'meter');
                    return;
                }
                if (currReading < prevReading) {
                    showMessage("currentReadingLessThanPrevious", 'error');
                    updateResultDisplay(0, 0, 0, 0, meterKwhElem, meterAmperesElem, meterBillElem, meterAvgRateElem, meterResultGrid, 'meter');
                    return;
                }
                if (isNaN(daysVal) || daysVal <= 0) {
                    showMessage("enterPositiveDays", 'error');
                    updateResultDisplay(0, 0, 0, 0, meterKwhElem, meterAmperesElem, meterBillElem, meterAvgRateElem, meterResultGrid, 'meter');
                    return;
                }

                const consumption = currReading - prevReading;
                const totalBill = calculateCostForCategory(consumption, category);
                const avgAmperes = kwhToAmperes(consumption, daysVal);
                const avgRate = consumption > 0 ? totalBill / consumption : 0;

                updateResultDisplay(consumption, avgAmperes, totalBill, avgRate, meterKwhElem, meterAmperesElem, meterBillElem, meterAvgRateElem, meterResultGrid, 'meter');
            };

            const calculateDeviceConsumption = () => {
                let totalKwh = 0;
                const deviceDetails = [];
                const category = categoryDropdown.value;
                const daysVal = validateNumeric(daysInput.value) || 30;
                const lang = currentLang;

                Array.from(deviceTableBody.children).forEach(row => {
                    const isOn = row.querySelector('.device-on').checked;
                    const kwhOutputCell = row.querySelector('.output-kwh');
                    const iqdOutputCell = row.querySelector('.output-iqd');

                    if (!isOn) {
                        kwhOutputCell.textContent = '0.00';
                        iqdOutputCell.textContent = '0';
                        return;
                    }

                    const inputs = row.querySelectorAll('input[type="text"], input[type="number"]');
                    const deviceName = inputs[0].value;
                    const watt = validateNumeric(inputs[1].value);
                    const hours = validateNumeric(inputs[2].value);
                    const day = validateNumeric(inputs[3].value);
                    const count = validateNumeric(inputs[4].value);

                    const kwh = (watt / 1000) * hours * day * count;
                    kwhOutputCell.textContent = formatNumber(kwh, 2);
                    totalKwh += kwh;
                    deviceDetails.push({ name: deviceName, kwh: kwh, row: row }); 
                });

                const totalBill = calculateCostForCategory(totalKwh, category);
                const avgRate = totalKwh > 0 ? totalBill / totalKwh : 0;

                deviceDetails.forEach(device => {
                    const iqd = device.kwh * avgRate;
                    device.row.querySelector('.output-iqd').textContent = formatNumber(iqd, 0, true);
                    device.iqd = iqd; 
                });
                // Update a dummy result grid for device consumption to trigger color change
                // We'll use the manualResultGrid for this as it's always visible and we need a target for the color change.
                updateResultDisplay(totalKwh, kwhToAmperes(totalKwh, daysVal), totalBill, avgRate, manualKwhElem, manualAmperesElem, manualBillElem, manualAvgRateElem, manualResultGrid, 'device');
            };

            const optimizeForBudget = () => {
                let targetValue = validateNumeric(budgetLimitInput.value);
                if (isNaN(targetValue) || targetValue < 0) {
                    showMessage("enterValidNumeric", 'error');
                    budgetResultLabel.textContent = translations[currentLang].invalidTarget;
                    updateResultDisplay(0, 0, 0, 0, manualKwhElem, manualAmperesElem, manualBillElem, manualAvgRateElem, budgetOptimizationResultGrid, 'optimization'); // Use dummy values for color update
                    return;
                }

                const daysVal = validateNumeric(daysInput.value) || 30;
                let currentTotalKwh = 0;
                const variableDevicesData = [];
                const category = categoryDropdown.value;

                Array.from(deviceTableBody.children).forEach((row, idx) => {
                    const isOn = row.querySelector('.device-on').checked;
                    if (!isOn) return;

                    const inputs = row.querySelectorAll('input[type="text"], input[type="number"]');
                    const deviceName = inputs[0].value;
                    const watt = validateNumeric(inputs[1].value);
                    const hours = validateNumeric(inputs[2].value);
                    const day = validateNumeric(inputs[3].value);
                    const count = validateNumeric(inputs[4].value);
                    const isFixed = row.querySelector('.device-fixed').checked;

                    const currentKwhDevice = (watt / 1000) * hours * day * count;
                    currentTotalKwh += currentKwhDevice;

                    if (!isFixed) { // Only consider variable devices for optimization
                        variableDevicesData.push({
                            index: idx,
                            name: deviceName,
                            initialKwh: currentKwhDevice,
                            watt, hours, day, count,
                            row: row 
                        });
                    }
                });

                const currentBill = calculateCostForCategory(currentTotalKwh, category);
                const currentAmperes = kwhToAmperes(currentTotalKwh, daysVal);
                const lang = currentLang;

                let targetKwhForOptimization = 0;
                if (optimizationTargetDropdown.value === 'Target Cost') {
                    if (currentBill > 0) {
                        targetKwhForOptimization = (targetValue / currentBill) * currentTotalKwh;
                    } else {
                        targetKwhForOptimization = targetValue / 100; 
                    }
                } else if (optimizationTargetDropdown.value === 'Target Amperes') {
                    targetKwhForOptimization = amperesToKwh(targetValue, daysVal);
                } else if (optimizationTargetDropdown.value === 'Target kWh') {
                    targetKwhForOptimization = targetValue;
                }

                if ((optimizationTargetDropdown.value === 'Target Cost' && currentBill <= targetValue) ||
                    (optimizationTargetDropdown.value === 'Target Amperes' && currentAmperes <= targetValue) ||
                    (optimizationTargetDropdown.value === 'Target kWh' && currentTotalKwh <= targetValue)) {
                    budgetResultLabel.textContent = translations[lang].withinTarget;
                    showMessage('currentStatusWithinTarget', 'info');
                    updateResultDisplay(currentTotalKwh, currentAmperes, currentBill, currentTotalKwh > 0 ? currentBill / currentTotalKwh : 0, manualKwhElem, manualAmperesElem, manualBillElem, manualAvgRateElem, budgetOptimizationResultGrid, 'optimization');
                    return;
                }

                variableDevicesData.sort((a, b) => b.initialKwh - a.initialKwh);

                let optimizedConsumptionKwh = currentTotalKwh;
                let changesMade = false;

                for (const device of variableDevicesData) {
                    if (optimizedConsumptionKwh <= targetKwhForOptimization) break; 

                    const kwhPerHour = (device.watt / 1000) * device.day * device.count;
                    if (kwhPerHour <= 0) continue;

                    let currentDeviceHours = validateNumeric(device.row.querySelector('input[type="number"]').value);

                    while (currentDeviceHours > 0) {
                        const testHours = Math.max(0, currentDeviceHours - 1); 
                        const kwhReducedByHour = (currentDeviceHours - testHours) * kwhPerHour;
                        const potentialNewTotalConsumption = optimizedConsumptionKwh - kwhReducedByHour;

                        let potentialNewBill = calculateCostForCategory(potentialNewTotalConsumption, category);
                        let potentialNewAmperes = kwhToAmperes(potentialNewTotalConsumption, daysVal);

                        let canReduceFurther = false;
                        if ((optimizationTargetDropdown.value === 'Target Cost' && potentialNewBill <= targetValue) ||
                            (optimizationTargetDropdown.value === 'Target Amperes' && potentialNewAmperes <= targetValue) ||
                            (optimizationTargetDropdown.value === 'Target kWh' && potentialNewTotalConsumption <= targetValue)) {
                            canReduceFurther = true;
                        }

                        if (canReduceFurther || testHours === 0) { 
                            const hoursReduced = currentDeviceHours - testHours;
                            if (hoursReduced > 0) {
                                device.row.querySelector('input[type="number"]').value = formatNumber(testHours, 1, false, true); 
                                optimizedConsumptionKwh = potentialNewTotalConsumption;
                                changesMade = true;
                            }
                            break; 
                        } else {
                            currentDeviceHours = testHours; 
                        }
                    }
                }

                if (changesMade) {
                    budgetResultLabel.textContent = translations[lang].optimizationCompleted;
                    calculateDeviceConsumption(); // Recalculate device consumption to update table outputs
                    showMessage('optimizationCompleted', 'success');
                } else {
                    budgetResultLabel.textContent = translations[lang].unreachable;
                    showMessage('couldNotReachTarget', 'error');
                }
                // Update the optimization result display with the final (or current) values
                updateResultDisplay(optimizedConsumptionKwh, kwhToAmperes(optimizedConsumptionKwh, daysVal), calculateCostForCategory(optimizedConsumptionKwh, category), optimizedConsumptionKwh > 0 ? calculateCostForCategory(optimizedConsumptionKwh, category) / optimizedConsumptionKwh : 0, manualKwhElem, manualAmperesElem, manualBillElem, manualAvgRateElem, budgetOptimizationResultGrid, 'optimization');
            };

            // --- DEVICE TABLE LOGIC ---
            const addTableRow = (deviceData = {}) => {
                const lang = currentLang;
                const defaultNameKey = deviceData.nameKey || 'newDevice';
                const data = {
                    nameKey: defaultNameKey,
                    name: translations[lang].deviceNames[defaultNameKey], 
                    watt: '100', hours: '8', day: '30', count: '1', on: true, fixed: false, ...deviceData
                };

                const row = deviceTableBody.insertRow();
                row.innerHTML = `
                    <td><input type="text" value="${data.name}" class="device-input" data-name-key="${data.nameKey}"></td>
                    <td><input type="number" value="${data.watt}" class="device-input"></td>
                    <td><input type="number" value="${data.hours}" class="device-input" min="0" max="24"></td>
                    <td><input type="number" value="${data.day}" class="device-input" min="0" max="31"></td>
                    <td><input type="number" value="${data.count}" class="device-input" min="0"></td>
                    <td class="output-kwh output-cell">0.00</td>
                    <td class="output-iqd output-cell">0</td>
                    <td><input type="checkbox" class="device-on" ${data.on ? 'checked' : ''}></td>
                    <td><input type="checkbox" class="device-fixed" ${data.fixed ? 'checked' : ''}></td>
                `;

                row.querySelector('.device-on').addEventListener('change', () => calculateDeviceConsumption());
                row.querySelector('.device-fixed').addEventListener('change', () => calculateDeviceConsumption());
                row.querySelectorAll('.device-input').forEach(input => {
                    // Store the nameKey on the input itself for translation updates
                    if (input.type === 'text') {
                        input.setAttribute('data-name-key', data.nameKey);
                    }
                    input.addEventListener('change', () => calculateDeviceConsumption());
                });

                row.addEventListener('click', () => handleTableRowClick(row, Array.from(deviceTableBody.children).indexOf(row)));

                if (!data.on) row.classList.add('inactive'); 
            };

            const handleTableRowClick = (row, index) => {
                if (selectedTableRow) {
                    selectedTableRow.classList.remove('selected-row');
                }
                selectedTableRow = row;
                selectedTableRow.classList.add('selected-row');
            };

            const startupPopulateDeviceTable = () => {
                const sampleDevices = [
                    { nameKey: 'ledTv', watt: '100', hours: '8', day: '30', count: '1', on: true, fixed: false },
                    { nameKey: 'refrigerator', watt: '175', hours: '24', day: '30', count: '1', on: true, fixed: true },
                    { nameKey: 'washingMachine', watt: '2000', hours: '2', day: '4', count: '1', on: true, fixed: false },
                    { nameKey: 'ledLighting', watt: '12', hours: '12', day: '30', count: '20', on: true, fixed: false },
                    { nameKey: 'freezer', watt: '150', hours: '24', day: '30', count: '1', on: true, fixed: true },
                    { nameKey: 'waterPump', watt: '500', hours: '1', day: '30', count: '1', on: true, fixed: false },
                    { nameKey: 'waterHeater', watt: '2500', hours: '1', day: '15', count: '1', on: false, fixed: false },
                    { nameKey: 'airCooler', watt: '250', hours: '18', day: '30', count: '1', on: true, fixed: false },
                    { nameKey: 'fan', watt: '75', hours: '18', day: '30', count: '1', on: true, fixed: false },
                    { nameKey: 'dishwasher', watt: '1800', hours: '2', day: '15', count: '1', on: true, fixed: false },
                    { nameKey: 'waterDispenser', watt: '175', hours: '2', day: '15', count: '1', on: true, fixed: false },
                    { nameKey: 'splitAc1Ton', watt: '1000', hours: '4', day: '30', count: '1', on: true, fixed: false },
                    { nameKey: 'splitAc1_5Ton', watt: '1500', hours: '4', day: '30', count: '1', on: false, fixed: false },
                    { nameKey: 'splitAc2Ton', watt: '2000', hours: '4', day: '30', count: '1', on: false, fixed: false },
                    { nameKey: 'towerAc', watt: '3000', hours: '4', day: '30', count: '1', on: false, fixed: false },
                    { nameKey: 'electricHeater', watt: '2000', hours: '6', day: '20', count: '1', on: false, fixed: false },
                    { nameKey: 'iron', watt: '1500', hours: '1', day: '8', count: '1', on: false, fixed: false },
                    { nameKey: 'microwave', watt: '1000', hours: '0.5', day: '15', count: '1', on: false, fixed: false },
                    { nameKey: 'electricKettle', watt: '1800', hours: '0.2', day: '30', count: '1', on: false, fixed: false },
                    { nameKey: 'hairDryer', watt: '1600', hours: '0.2', day: '10', count: '1', on: false, fixed: false },
                    { nameKey: 'vacuumCleaner', watt: '1400', hours: '0.5', day: '4', count: '1', on: false, fixed: false },
                    { nameKey: 'electricOven', watt: '2500', hours: '1', day: '10', count: '1', on: false, fixed: false },
                    { nameKey: 'phoneCharger', watt: '10', hours: '8', day: '30', count: '2', on: false, fixed: true },
                    { nameKey: 'desktopPc', watt: '150', hours: '6', day: '30', count: '1', on: true, fixed: false },
                    { nameKey: 'pcMonitor', watt: '40', hours: '6', day: '30', count: '1', on: false, fixed: false },
                ];
                
                deviceTableBody.innerHTML = ''; // Clear existing rows before populating
                sampleDevices.forEach(device => {
                    addTableRow(device);
                });
            };

            // --- REPORT GENERATION FUNCTIONS ---
            const generateReport = (calculationType) => {
                const lang = currentLang;
                let reportHtml = '';
                let kwh, bill, amperes, avgRate, category, breakdown;

                if (calculationType === 'manual') {
                    kwh = validateNumeric(manualKwhElem.textContent.replace(translations[lang].unitKWH, '').trim());
                    bill = validateNumeric(manualBillElem.textContent.replace(translations[lang].unitIQD, '').trim());
                    amperes = validateNumeric(manualAmperesElem.textContent.replace(translations[lang].unitA, '').trim());
                    avgRate = validateNumeric(manualAvgRateElem.textContent.replace(translations[lang].iqdPerKwh, '').trim());
                    category = categoryDropdown.value;
                    
                    reportHtml += `<div class="report-section-title">${translations[lang].manualCalculationSummary}</div>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].category}:</span> <span class="report-item-value">${translations[lang][category.toLowerCase() + 'Option'] || category}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].billLabel}:</span> <span class="report-item-value">${formatNumber(bill, 0, true)} ${translations[lang].unitIQD}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].consumptionLabel}:</span> <span class="report-item-value">${formatNumber(kwh, 2)} ${translations[lang].unitKWH}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].avgAmperesLabel}:</span> <span class="report-item-value">${formatNumber(amperes, 2)} ${translations[lang].unitA}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].avgRateLabel}:</span> <span class="report-item-value">${formatNumber(avgRate, 2)} ${translations[lang].iqdPerKwh}</span></p>`;
                
                } else if (calculationType === 'meter') {
                    const prevReading = validateNumeric(meterPrevReading.value);
                    const currReading = validateNumeric(meterCurrReading.value);
                    const daysVal = validateNumeric(daysInput.value) || 30;
                    category = categoryDropdown.value;
                    kwh = currReading - prevReading;
                    bill = calculateCostForCategory(kwh, category);
                    amperes = kwhToAmperes(kwh, daysVal);
                    avgRate = kwh > 0 ? bill / kwh : 0;

                    reportHtml += `<div class="report-section-title">${translations[lang].meterCalculationSummary}</div>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].category}:</span> <span class="report-item-value">${translations[lang][category.toLowerCase() + 'Option'] || category}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].previousReading}:</span> <span class="report-item-value">${formatNumber(prevReading, 0, true)} ${translations[lang].unitKWH}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].currentReading}:</span> <span class="report-item-value">${formatNumber(currReading, 0, true)} ${translations[lang].unitKWH}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].days}:</span> <span class="report-item-value">${formatNumber(daysVal, 0, false, true)}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].billLabel}:</span> <span class="report-item-value">${formatNumber(bill, 0, true)} ${translations[lang].unitIQD}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].consumptionLabel}:</span> <span class="report-item-value">${formatNumber(kwh, 2)} ${translations[lang].unitKWH}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].avgAmperesLabel}:</span> <span class="report-item-value">${formatNumber(amperes, 2)} ${translations[lang].unitA}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].avgRateLabel}:</span> <span class="report-item-value">${formatNumber(avgRate, 2)} ${translations[lang].iqdPerKwh}</span></p>`;
                }
                
                ({ breakdown } = getIraqiTariffDetails(kwh, category));
                reportHtml += `<div class="report-section-title">${translations[lang].tariffBreakdown}</div><pre>${breakdown}</pre>`;

                reportModalTitle.textContent = translations[lang].reportModalTitle;
                reportModalContent.innerHTML = reportHtml;
                reportModal.style.display = 'flex';
            };

            const generateDeviceReport = () => {
                const lang = currentLang;
                let totalKwh = 0;
                const deviceDetailsForReport = [];
                const category = categoryDropdown.value;
                const daysVal = validateNumeric(daysInput.value) || 30;

                Array.from(deviceTableBody.children).forEach(row => {
                    const isOn = row.querySelector('.device-on').checked;
                    const inputs = row.querySelectorAll('input[type="text"], input[type="number"]');
                    const deviceName = inputs[0].value;
                    const watt = validateNumeric(inputs[1].value);
                    const hours = validateNumeric(inputs[2].value);
                    const day = validateNumeric(inputs[3].value);
                    const count = validateNumeric(inputs[4].value);
                    const isFixed = row.querySelector('.device-fixed').checked;
                    const kwh = (watt / 1000) * hours * day * count;
                    
                    if (isOn) {
                        totalKwh += kwh; 
                    }

                    deviceDetailsForReport.push({
                        name: deviceName,
                        watt: formatNumber(watt, 0, false, true),
                        hours: formatNumber(hours, 1, false, true),
                        day: formatNumber(day, 0, false, true),
                        count: formatNumber(count, 0, false, true),
                        kwh: formatNumber(kwh, 2),
                        on: isOn ? translations[lang].yes : translations[lang].no, // Translate Yes/No
                        fixed: isFixed ? translations[lang].yes : translations[lang].no // Translate Yes/No
                    });
                });

                if (deviceTableBody.children.length === 0) {
                    showMessage("addAndCalculateDeviceConsumption", 'info');
                    return;
                }
                
                const finalTotalBill = calculateCostForCategory(totalKwh, category);
                const finalAvgRate = totalKwh > 0 ? finalTotalBill / totalKwh : 0;
                const finalAvgAmperes = kwhToAmperes(totalKwh, daysVal);

                let reportHtml = `
                    <div class="report-section-title">${translations[lang].overallConsumptionSummary}</div>
                    <p><span class="report-item-label">${translations[lang].category}:</span> <span class="report-item-value">${translations[lang][category.toLowerCase() + 'Option'] || category}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].totalBill}:</span> <span class="report-item-value">${formatNumber(finalTotalBill, 0, true)} ${translations[lang].unitIQD}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].totalConsumption}:</span> <span class="report-item-value">${formatNumber(totalKwh, 2)} ${translations[lang].unitKWH}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].averageAmperes}:</span> <span class="report-item-value">${formatNumber(finalAvgAmperes, 2)} ${translations[lang].unitA}</span></p>`;
                    reportHtml += `<p><span class="report-item-label">${translations[lang].averageRate}:</span> <span class="report-item-value">${formatNumber(finalAvgRate, 2)} ${translations[lang].iqdPerKwh}</span></p>`;

                    reportHtml += `<div class="report-section-title">${translations[lang].deviceBreakdown}</div>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>${translations[lang].device}</th>
                                <th>${translations[lang].watt}</th>
                                <th>${translations[lang].hoursPerDay}</th>
                                <th>${translations[lang].daysPerMonth}</th>
                                <th>${translations[lang].count}</th>
                                <th>${translations[lang].kwhPerMonth}</th>
                                <th>${translations[lang].iqdPerMonth}</th>
                                <th>${translations[lang].onQuestion}</th>
                                <th>${translations[lang].fixedQuestion}</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                deviceDetailsForReport.forEach(device => {
                    const iqd = validateNumeric(device.kwh) * finalAvgRate;
                    reportHtml += `
                            <tr>
                                <td>${device.name}</td>
                                <td>${device.watt}</td>
                                <td>${device.hours}</td>
                                <td>${device.day}</td>
                                <td>${device.count}</td>
                                <td>${device.kwh}</td>
                                <td>${formatNumber(iqd, 0, true)}</td>
                                <td>${device.on}</td>
                                <td>${device.fixed}</td>
                            </tr>
                    `;
                });

                reportHtml += `
                        </tbody>
                    </table>
                `;

                reportModalTitle.textContent = translations[lang].reportModalTitle; // Update title
                reportModalContent.innerHTML = reportHtml;
                reportModal.style.display = 'flex';
            };


            // --- CSV HANDLING FUNCTIONS ---
            const exportTableToCsv = () => {
                const table = document.getElementById('deviceTable');
                let csv = [];

                // Get headers
                let headers = [];
                table.querySelectorAll('th').forEach(th => {
                    headers.push(th.innerText);
                });
                csv.push(headers.join(','));

                // Get rows
                table.querySelectorAll('tbody tr').forEach(row => {
                    let rowData = [];
                    row.querySelectorAll('td').forEach((td, index) => {
                        let cellValue;
                        if (index === 0) { // Device Name input
                            cellValue = td.querySelector('input').getAttribute('data-name-key'); // Store the key, not the translated value
                        } else if (index < 5) { // Other input fields
                            cellValue = td.querySelector('input').value;
                        } else if (index >= 7) { // Checkboxes
                            cellValue = td.querySelector('input').checked ? 'TRUE' : 'FALSE';
                        } else { // Output cells
                            cellValue = td.innerText.replace(/,/g, ''); // Remove commas for numeric values
                        }
                        // Escape commas and double quotes for CSV
                        if (String(cellValue).includes(',') || String(cellValue).includes('"')) {
                            cellValue = `"${String(cellValue).replace(/"/g, '""')}"`;
                        }
                        rowData.push(cellValue);
                    });
                    csv.push(rowData.join(','));
                });

                const csvString = csv.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'devices_runaki.csv';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage("deviceDataSaved", 'success');
            };

            const importTableFromCsv = (csvString) => {
                const lines = csvString.split('\n').filter(line => line.trim() !== '');
                if (lines.length < 1) {
                    showMessage("csvEmpty", 'error');
                    return;
                }

                // Assuming the first line is headers, we skip it for data parsing
                const dataRows = lines.slice(1); 
                
                deviceTableBody.innerHTML = ''; // Clear existing rows

                dataRows.forEach(line => {
                    // Simple CSV parsing: split by comma, but handle quoted fields
                    const rowValues = [];
                    let inQuote = false;
                    let currentField = '';
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"' && (i === 0 || line[i-1] === ',' || inQuote)) {
                            if (inQuote && line[i+1] === '"') { // Handle escaped double quote ""
                                currentField += '"';
                                i++;
                            } else {
                                inQuote = !inQuote;
                            }
                        } else if (char === ',' && !inQuote) {
                            rowValues.push(currentField);
                            currentField = '';
                        } else {
                            currentField += char;
                        }
                    }
                    rowValues.push(currentField); // Add the last field

                    // Ensure we have enough columns (at least 9 for device data)
                    if (rowValues.length < 9) {
                        console.warn("Skipping malformed CSV row:", line);
                        return;
                    }

                    addTableRow({
                        nameKey: rowValues[0], // Load the nameKey
                        watt: rowValues[1],
                        hours: rowValues[2],
                        day: rowValues[3],
                        count: rowValues[4],
                        on: rowValues[7].toUpperCase() === 'TRUE',
                        fixed: rowValues[8].toUpperCase() === 'TRUE',
                    });
                });
                calculateDeviceConsumption();
                showMessage("deviceDataLoaded", 'success');
            };


            // --- EVENT LISTENERS ---
            manualInputTypeDropdown.addEventListener('change', (e) => {
                const type = e.target.value;
                if (type === 'kWh') manualInput.value = '1891';
                else if (type === 'Avg Amperes') manualInput.value = '12';
                else if (type === 'Given Bill') manualInput.value = '100000';
                performManualCalculation();
            });

            calculateManualButton.addEventListener('click', performManualCalculation);
            manualInput.addEventListener('change', performManualCalculation); 
            manualInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') performManualCalculation(); });
            categoryDropdown.addEventListener('change', () => {
                performManualCalculation();
                if (deviceTableSection.style.display === 'block') { // Only recalculate if table is visible
                    calculateDeviceConsumption(); 
                }
            });

            calculateMeterButton.addEventListener('click', performMeterCalculation);
            meterPrevReading.addEventListener('change', performMeterCalculation);
            meterPrevReading.addEventListener('keydown', (e) => { if (e.key === 'Enter') performMeterCalculation(); });
            meterCurrReading.addEventListener('change', performMeterCalculation);
            meterCurrReading.addEventListener('keydown', (e) => { if (e.key === 'Enter') performMeterCalculation(); });
            daysInput.addEventListener('change', () => {
                performManualCalculation(); 
                performMeterCalculation(); 
                if (deviceTableSection.style.display === 'block') { // Only recalculate if table is visible
                    calculateDeviceConsumption(); 
                }
            });
            daysInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') {
                performManualCalculation();
                performMeterCalculation();
                if (deviceTableSection.style.display === 'block') { // Only recalculate if table is visible
                    calculateDeviceConsumption();
                }
            }});

            manualReportButton.addEventListener('click', () => generateReport('manual'));
            meterReportButton.addEventListener('click', () => generateReport('meter'));
            deviceReportButton.addEventListener('click', generateDeviceReport);

            addRowButton.addEventListener('click', () => {
                addTableRow();
                calculateDeviceConsumption();
            });
            deleteRowButton.addEventListener('click', () => {
                if (selectedTableRow) {
                    selectedTableRow.remove();
                    selectedTableRow = null; 
                    calculateDeviceConsumption();
                } else {
                    showMessage('selectRowToDelete', 'info');
                }
            });
            clearAllButton.addEventListener('click', () => {
                deviceTableBody.innerHTML = '';
                startupPopulateDeviceTable();
                calculateDeviceConsumption();
                showMessage("allDeviceDataCleared", 'info');
            });
            saveTableButton.addEventListener('click', exportTableToCsv);

            loadFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (readerEvent) => {
                    try {
                        importTableFromCsv(readerEvent.target.result);
                    } catch (error) {
                        showMessage('errorLoadingData', 'error', { error: error.message });
                        console.error("Error loading data:", error);
                    }
                };
                reader.readAsText(file);
            });

            // Budget Optimization
            optimizationTargetDropdown.addEventListener('change', () => {
                const target = optimizationTargetDropdown.value;
                if (target === 'Target Cost') budgetLimitInput.value = '100000';
                else if (target === 'Target Amperes') budgetLimitInput.value = '12';
                else if (target === 'Target kWh') budgetLimitInput.value = '1891';
                budgetResultLabel.textContent = translations[currentLang].notOptimized;
            });
            optimizeBudgetButton.addEventListener('click', optimizeForBudget);
            budgetLimitInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') optimizeForBudget(); });


            // Toggle Budget Optimization Section
            toggleBudgetOptimizationButton.addEventListener('click', () => {
                const isVisible = budgetOptimizationSection.style.display === 'block';
                budgetOptimizationSection.style.display = isVisible ? 'none' : 'block';
                toggleBudgetOptimizationButton.textContent = isVisible ? translations[currentLang].showBudgetOptimization : translations[currentLang].hideBudgetOptimization;
                if (!isVisible) {
                    // If showing, ensure initial calculation is run
                    optimizeForBudget();
                }
            });

            // Toggle Device Table Button
            toggleTableButton.addEventListener('click', () => {
                const isVisible = deviceTableSection.style.display === 'block';
                deviceTableSection.style.display = isVisible ? 'none' : 'block';
                toggleTableButton.textContent = isVisible ? translations[currentLang].showDeviceTable : translations[currentLang].hideDeviceTable;
                if (!isVisible) {
                    calculateDeviceConsumption(); 
                }
            });

            // --- REFACTORED BUTTON TOGGLE LOGIC ---
            const updateCalculationToggleButtons = () => {
                const lang = currentLang;
                const isManualVisible = manualCalculationSection.style.display !== 'none';

                if (isManualVisible) {
                    toggleManualCalculationButton.textContent = translations[lang].hideManualCalculation;
                    toggleMeterCalculationButton.textContent = translations[lang].showMeterCalculation;
                } else {
                    toggleManualCalculationButton.textContent = translations[lang].showManualCalculation;
                    toggleMeterCalculationButton.textContent = translations[lang].hideMeterCalculation;
                }
            };

            // Toggle Manual Calculation Section
            toggleManualCalculationButton.addEventListener('click', () => {
                manualCalculationSection.style.display = 'block';
                meterCalculationSection.style.display = 'none';
                updateCalculationToggleButtons();
            });

            // Toggle Meter Calculation Section
            toggleMeterCalculationButton.addEventListener('click', () => {
                meterCalculationSection.style.display = 'block';
                manualCalculationSection.style.display = 'none';
                updateCalculationToggleButtons();
            });


            // Show Tariff Details Button
            showTariffDetailsButton.addEventListener('click', () => {
                const lang = currentLang;
                tariffDetailsModalTitle.textContent = translations[lang].tariffDetailsModalTitle;

                // Destroy existing charts
                if (householdTariffChartInstance) householdTariffChartInstance.destroy();
                if (commercialTariffChartInstance) commercialTariffChartInstance.destroy();
                if (otherCategoriesTariffChartInstance) otherCategoriesTariffChartInstance.destroy();

                // Show chart containers, hide preformatted text
                householdTariffChartContainer.style.display = 'block';
                commercialTariffChartContainer.style.display = 'block';
                otherCategoriesTariffChartContainer.style.display = 'block';
                tariffDetailsModalContent.style.display = 'none';

                const chartOptions = (titleKey) => ({
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: translations[lang][titleKey], color: 'white', font: { size: 16 } },
                        tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${formatNumber(ctx.parsed.y, 0)} ${translations[lang].iqdPerKwh}` } },
                        datalabels: { anchor: 'end', align: 'top', color: 'white', font: { weight: 'bold' }, formatter: (val) => formatNumber(val, 0) }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: translations[lang].rate, color: 'white' }, ticks: { color: 'white' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        x: { title: { display: true, text: translations[lang].consumptionTiers, color: 'white' }, ticks: { color: 'white', autoSkip: false, maxRotation: 45, minRotation: 45 }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                    }
                });

                // Household Chart
                householdTariffChartInstance = new Chart(householdTariffChartCanvas, {
                    type: 'bar',
                    data: {
                        labels: ["1-1500 kWh", "1501-3000 kWh", "3001-4000 kWh", "4001+ kWh"],
                        datasets: [{ data: [10, 35, 80, 120], backgroundColor: 'rgba(54, 162, 235, 0.6)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }]
                    },
                    options: chartOptions('householdTariffRates'),
                    plugins: [ChartDataLabels]
                });

                // Commercial Chart
                commercialTariffChartInstance = new Chart(commercialTariffChartCanvas, {
                    type: 'bar',
                    data: {
                        labels: ["1-1000 kWh", "1001-2000 kWh", "2001+ kWh"],
                        datasets: [{ data: [60, 80, 120], backgroundColor: 'rgba(255, 159, 64, 0.6)', borderColor: 'rgba(255, 159, 64, 1)', borderWidth: 1 }]
                    },
                    options: chartOptions('commercialTariffRates'),
                    plugins: [ChartDataLabels]
                });

                // Other Categories Chart
                const otherOptions = chartOptions('otherCategoriesTariffRates');
                otherOptions.scales.x.title.text = translations[lang].categoryText; // Change x-axis title
                otherCategoriesTariffChartInstance = new Chart(otherCategoriesTariffChartCanvas, {
                    type: 'bar',
                    data: {
                        labels: [translations[lang].industrialOption, translations[lang].governmentOption, translations[lang].agricultureOption],
                        datasets: [{ data: [60, 120, 60], backgroundColor: ['rgba(153, 102, 255, 0.6)', 'rgba(255, 99, 132, 0.6)', 'rgba(75, 192, 192, 0.6)'], borderColor: ['rgba(153, 102, 255, 1)', 'rgba(255, 99, 132, 1)', 'rgba(75, 192, 192, 1)'], borderWidth: 1 }]
                    },
                    options: otherOptions,
                    plugins: [ChartDataLabels]
                });

                tariffDetailsModal.style.display = 'flex';
            });

            closeTariffDetailsModal.addEventListener('click', () => {
                tariffDetailsModal.style.display = 'none';
            });

            tariffDetailsModal.addEventListener('click', (e) => {
                if (e.target === tariffDetailsModal) {
                    tariffDetailsModal.style.display = 'none';
                }
            });

            closeReportModal.addEventListener('click', () => {
                reportModal.style.display = 'none';
            });

            reportModal.addEventListener('click', (e) => {
                if (e.target === reportModal) {
                    reportModal.style.display = 'none';
                }
            });


            // --- INITIALIZATION CALLS ---
            startupPopulateDeviceTable(); // Populate table on load
            calculateDeviceConsumption(); // Calculate initial device consumption
            performManualCalculation(); // Perform initial manual calculation
            performMeterCalculation(); // Perform initial meter calculation
            setActiveLanguage('en'); // Set initial language and button state
            updateCalculationToggleButtons(); // Set initial button text
        });
    </script>
</body>
</html>
